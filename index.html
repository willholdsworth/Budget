<html lang="en"><head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Budget Tracker</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap">
<style>
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Space Grotesk', monospace;
  background: #ffffff;
  min-height: 100vh;
  padding: 20px;
  color: #000000;
  transition: all 0.3s ease;
}

body.dark-mode {
  background: #000000;
  color: #ffffff;
}

.fixed-header {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  background: #ffffff;
  padding: 20px;
  z-index: 1000;
  transition: all 0.3s ease;
}

body.dark-mode .fixed-header {
  background: #000000;
}

.header-content {
  max-width: 1000px;
  margin: 0 auto;
  display: flex;
  align-items: center;
  position: relative;
}

.header-left {
  position: absolute;
  left: 0;
}

.header-right {
  position: absolute;
  right: 0;
}

.greeting {
  font-size: 24px;
  font-weight: 300;
  letter-spacing: -0.02em;
  margin: 0 auto;
  text-align: center;
  flex-grow: 1;
}

.hamburger-btn {
  background: transparent;
  color: #000000;
  border: none;
  width: 50px;
  height: 50px;
  cursor: pointer;
  font-size: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
  font-family: inherit;
  position: relative;
  z-index: 1100;
  text-align: center;
}

body.dark-mode .hamburger-btn {
  color: #ffffff;
  background: #000000;
}

.hamburger-btn:focus {
  outline: none;
}

.hamburger-btn.menu-open {
  transform: rotate(90deg);
}

button {
  background: #000000;
  color: #ffffff;
  border: none;
  padding: 12px 24px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  font-family: inherit;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  transform: translateY(0);
  position: relative;
  overflow: hidden;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

body.dark-mode button {
  background: #ffffff;
  color: #000000;
}

button::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
  transition: left 0.6s ease;
}

button:hover::before {
  left: 100%;
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(0, 0, 0, 0.2);
}

body.dark-mode button:hover {
  box-shadow: 0 6px 16px rgba(255, 255, 255, 0.15);
}

.btn-danger {
  background: #8e1600;
  color: #ffffff;
}

.btn-danger:hover {
  background: #721100;
  box-shadow: 0 6px 16px rgba(142, 22, 0, 0.3);
}

.btn-small {
  padding: 6px 12px;
  font-size: 12px;
}

.save-btn {
  background: #8e1600;
  color: #ffffff;
  border: none;
  padding: 8px 16px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
  font-family: inherit;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-align: center;
}

.save-btn:hover:not(:disabled) {
  transform: translateY(-1px);
  opacity: 0.8;
}

.save-btn.changed {
  background: #8e1600;
}

.save-btn:disabled {
  cursor: not-allowed;
  opacity: 0.6;
}

.sidebar {
  position: fixed;
  top: 0;
  left: -250px;
  width: 250px;
  height: 100%;
  background: #ffffff;
  border-right: 2px solid #000000;
  padding: 80px 20px 20px;
  z-index: 1001;
  transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  backdrop-filter: blur(10px);
}

body.dark-mode .sidebar {
  background: #000000;
  border-right-color: #ffffff;
}

.sidebar.open {
  left: 0;
  box-shadow: 4px 0 20px rgba(0, 0, 0, 0.2);
}

body.dark-mode .sidebar.open {
  box-shadow: 4px 0 20px rgba(255, 255, 255, 0.1);
}

.sidebar-menu {
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.sidebar-menu li {
  width: 100%;
}

.sidebar-menu button, .sidebar-menu .currency-selector {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #000000;
  border-radius: 8px;
  font-size: 14px;
  background: #ffffff;
  font-family: inherit;
  transition: all 0.3s ease;
  color: #000000;
  cursor: pointer;
  text-align: center;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
}

body.dark-mode .sidebar-menu button, body.dark-mode .sidebar-menu .currency-selector {
  border-color: #ffffff;
  background: #000000;
  color: #ffffff;
}

.sidebar-menu button:hover, .sidebar-menu .currency-selector:hover {
  background: #e8e8e8;
  color: #000000;
}

body.dark-mode .sidebar-menu button:hover, body.dark-mode .sidebar-menu .currency-selector:hover {
  background: #1a1a1a;
  color: #ffffff;
}

.sidebar-menu .checkbox-group {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  border: 2px solid #000000;
  border-radius: 8px;
  background: #ffffff;
  color: #000000;
  transition: all 0.3s ease;
}

body.dark-mode .sidebar-menu .checkbox-group {
  border-color: #ffffff;
  background: #000000;
  color: #ffffff;
}

.sidebar-menu .checkbox-group:hover {
  background: #e8e8e8;
}

body.dark-mode .sidebar-menu .checkbox-group:hover {
  background: #1a1a1a;
}

.sidebar-menu .checkbox-group input[type="checkbox"] {
  width: auto;
  margin: 0;
}

.sidebar-menu .checkbox-group label {
  color: #000000;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  cursor: pointer;
}

body.dark-mode .sidebar-menu .checkbox-group label {
  color: #ffffff;
}

.container {
  max-width: 1000px;
  margin: 70px auto 0;
  background: transparent;
}


.tabs {
  display: flex;
  background: transparent;
  padding: 8px 0;
  margin-bottom: 32px;
  gap: 8px;
  justify-content: center;
}

body.dark-mode .tabs {
  background: transparent;
}

.tab {
  flex: 0 0 auto;
  padding: 12px 24px;
  text-align: center;
  cursor: pointer;
  background: #ffffff;
  border-radius: 8px;
  font-weight: 600;
  font-size: 14px;
  color: #000000;
  transition: background 0.3s ease, color 0.3s ease;
  font-family: inherit;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  display: flex;
  align-items: center;
  justify-content: center;
}

body.dark-mode .tab {
  background: #000000;
  color: #ffffff;
}

.tab.active {
  background: #000000;
  color: #ffffff;
}

body.dark-mode .tab.active {
  background: #ffffff;
  color: #000000;
}

.tab-content {
  display: none;
  opacity: 0;
  transform: translateY(20px);
  transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

.tab-content.active {
  display: block;
  opacity: 1;
  transform: translateY(0);
  animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

.card {
  background: #ffffff;
  border-radius: 16px;
  padding: 32px;
  margin-bottom: 24px;
  border: 2px solid #000000;
  transition: none;
}

body.dark-mode .card {
  background: #000000;
  border-color: #ffffff;
}

.card h3, .card h4 {
  margin-bottom: 20px;
  color: #000000;
  font-size: 18px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 1px;
}

body.dark-mode .card h3, body.dark-mode .card h4 {
  color: #ffffff;
}

.stat-card {
  background: #ffffff;
  border-radius: 12px;
  padding: 20px;
  text-align: center;
  border: 2px solid #000000;
  transition: none;
}

body.dark-mode .stat-card {
  background: #000000;
  border-color: #ffffff;
}

.person-card {
  padding: 24px;
  border-radius: 12px;
  background: #ffffff;
  border: 2px solid #000000;
  transition: none;
}

body.dark-mode .person-card {
  background: #000000;
  border-color: #ffffff;
}

.person-card h3 {
  color: #000000;
  margin-bottom: 16px;
  font-size: 16px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

body.dark-mode .person-card h3 {
  color: #ffffff;
}

.bill-item {
  background: #ffffff;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 12px;
  display: flex;
  justify-content: space-between;
  align-items: center;
  border: 2px solid #000000;
  transition: none;
}

body.dark-mode .bill-item {
  background: #000000;
  border-color: #ffffff;
}

.bill-info {
  flex: 1;
}

.bill-info strong {
  font-size: 14px;
  color: #000000;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

body.dark-mode .bill-info strong {
  color: #ffffff;
}

.bill-info small {
  color: #666;
  font-size: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

body.dark-mode .bill-info small {
  color: #999;
}

.bill-actions {
  display: flex;
  gap: 8px;
}

.overview-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 16px;
  margin-bottom: 32px;
}

.stat-value {
  font-size: 22px;
  font-weight: 600;
  margin-bottom: 8px;
  color: #000000;
  transition: all 0.3s ease;
}

body.dark-mode .stat-value {
  color: #ffffff;
}

.stat-label {
  color: #666;
  font-size: 14px;
  font-weight: 500;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

body.dark-mode .stat-label {
  color: #999;
}

.person-overview {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.person-info {
  display: grid;
  gap: 12px;
}

.info-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  transition: all 0.2s ease;
}

.person-card .info-item:hover {
  background: transparent;
}

.debt-overview .info-item:hover {
  background: transparent;
}

.info-label {
  font-weight: 500;
  color: #666;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

body.dark-mode .info-label {
  color: #999;
}

.info-value {
  font-weight: 600;
  color: #000000;
  font-size: 14px;
}

body.dark-mode .info-value {
  color: #ffffff;
}

.form-group {
  margin-bottom: 20px;
}

label {
  display: block;
  margin-bottom: 6px;
  font-weight: 500;
  color: #666;
  font-size: 14px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

body.dark-mode label {
  color: #999;
}

input, select, textarea {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid #000000;
  border-radius: 8px;
  font-size: 14px;
  background: #ffffff;
  font-family: inherit;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  color: #000000;
  transform: translateY(0);
}

body.dark-mode input, body.dark-mode select, body.dark-mode textarea {
  border-color: #ffffff;
  background: #000000;
  color: #ffffff;
}

input:focus, select:focus, textarea:focus {
  outline: none;
  border-color: #666;
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

body.dark-mode input:focus, body.dark-mode select:focus, body.dark-mode textarea:focus {
  box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
}

body.dark-mode input[type="date"]::-webkit-calendar-picker-indicator {
  filter: invert(100%);
}

.checkbox-group {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 20px;
}

.checkbox-group input[type="checkbox"] {
  width: auto;
  margin: 0;
}

.payment-transfers {
  background: #f5f5f5;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  border: 2px solid #000000;
  animation: slideInUp 0.5s cubic-bezier(0.4, 0, 0.2, 1);
}

body.dark-mode .payment-transfers {
  background: #1a1a1a;
  border-color: #ffffff;
}

.transfer-item {
  display: flex;
  justify-content: space-between;
  padding: 8px 0;
  border-bottom: 1px solid #000000;
}

body.dark-mode .transfer-item {
  border-bottom-color: #ffffff;
}

.transfer-item:last-child {
  border-bottom: none;
}

.transfer-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
  gap: 20px;
  margin-bottom: 24px;
}

.debt-overview {
  background: #f5f5f5;
  border-radius: 8px;
  padding: 16px;
  margin-top: 16px;
  border: 1px solid #000000;
}

body.dark-mode .debt-overview {
  background: #1a1a1a;
  border-color: #ffffff;
}

.debt-item {
  margin-bottom: 20px;
}

.debt-item:last-child {
  margin-bottom: 0;
}

#debtsList .debt-item .info-item:first-child .info-label {
  font-weight: 1500;
  font-size: 1.1em;
}

.bills-section {
  margin-bottom: 24px;
}

.bills-group {
  margin-bottom: 20px;
  border: 1px solid #000000;
  border-radius: 8px;
  padding: 15px;
  background: #ffffff;
}

body.dark-mode .bills-group {
  border-color: #ffffff;
  background: #000000;
}

.bills-group-header {
  font-size: 16px;
  font-weight: 600;
  color: #000000;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

body.dark-mode .bills-group-header {
  color: #ffffff;
}

.history-table-wrapper {
  width: 100%;
  max-width: 100%;
  overflow: hidden;
  box-sizing: border-box;
}

.history-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
  background: #ffffff;
  border-radius: 8px;
  overflow: hidden;
  border: 2px solid #000000;
  table-layout: fixed;
}

body.dark-mode .history-table {
  background: #000000;
  border-color: #ffffff;
}

.history-table th, .history-table td {
  padding: 12px 16px;
  text-align: left;
  border-bottom: 1px solid #000000;
  font-size: 14px;
  color: #000000;
  word-wrap: break-word;
  overflow-wrap: break-word;
}

body.dark-mode .history-table th, body.dark-mode .history-table td {
  border-color: #ffffff;
  color: #ffffff;
}

.history-table th {
  background: #000000;
  font-weight: 600;
  color: #ffffff;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

body.dark-mode .history-table th {
  background: #ffffff;
  color: #000000;
}

.calendar-container {
  background: #f5f5f5;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  border: 2px solid #000000;
  overflow: hidden;
  animation: fadeInScale 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

body.dark-mode .calendar-container {
  background: #1a1a1a;
  border-color: #ffffff;
}

.calendar-container h4 {
  color: #000000;
  margin-bottom: 16px;
  font-size: 18px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
}

body.dark-mode .calendar-container h4 {
  color: #ffffff;
}

.calendar-header-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 10px;
}

.calendar-btn {
  background: #888 !important;
  color: white !important;
  border: none !important;
  width: 32px !important;
  height: 32px !important;
  border-radius: 50% !important;
  display: flex !important;
  align-items: center !important;
  justify-content: center !important;
  font-weight: bold !important;
  padding: 0 !important;
  cursor: pointer !important;
  text-align: center !important;
}

body.dark-mode .calendar-btn {
  color: #ffffff;
  background: #333333;
}

.calendar-grid {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 2px;
  position: relative;
}

.calendar-header {
  background: #000000;
  color: #ffffff;
  padding: 8px;
  text-align: center;
  font-weight: 600;
  font-size: 12px;
  text-transform: uppercase;
}

body.dark-mode .calendar-header {
  background: #ffffff;
  color: #000000;
}

.calendar-day {
  background: #ffffff;
  border: 1px solid #000000;
  min-height: 80px;
  padding: 4px;
  position: relative;
  overflow: hidden;
  transition: all 0.3s ease;
  flex: 1;
}

body.dark-mode .calendar-day {
  background: #000000;
  border-color: #ffffff;
}

.calendar-day.has-events {
  cursor: pointer;
}

.calendar-grid.has-expanded-day .calendar-day:not(.expanded) {
  min-width: 0;
  flex: 0.5;
}

.calendar-day.expanded {
  flex: 10;
  min-height: 30px;
  overflow-y: auto;
  z-index: 2;
}

.calendar-grid-row {
  display: flex;
  width: 100%;
}

body.dark-mode .calendar-day.expanded {
  box-shadow: 0 4px 10px rgba(255, 255, 255, 0.1);
}

.calendar-day.empty {
  background: transparent !important;
  opacity: 0.4 !important;
  border: 1px solid rgba(0, 0, 0, 0.2) !important;
}

body.dark-mode .calendar-day.empty {
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
}

.calendar-day.today {
  background: #ffffff;
}

body.dark-mode .calendar-day.today {
  background: #000000;
}

.calendar-day.today .day-number {
  color: #ffffff;
  background: #000000;
  border-radius: 50%;
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-bottom: 4px;
}

body.dark-mode .calendar-day.today .day-number {
  color: #000000;
  background: #ffffff;
}

.day-number {
  font-weight: 600;
  font-size: 14px;
  margin-bottom: 2px;
  color: #000000;
}

body.dark-mode .day-number {
  color: #ffffff;
}

.day-events {
  display: flex;
  flex-direction: column;
  gap: 2px;
}

.bill-name, .payday-name, .bonus-name, .oneoff-name {
  display: block;
  font-size: 10px;
  padding: 2px 4px;
  margin: 2px 0;
  border-radius: 3px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.expanded .bill-name, .expanded .payday-name, .expanded .bonus-name, .expanded .oneoff-name {
  white-space: normal;
}

.bill-name {
  color: #000000;
  background: #e8e8e8;
}

body.dark-mode .bill-name {
  color: #ffffff;
  background: #333;
}

.payday-name {
  color: #000000;
  background: #4CAF50;
  font-weight: 600;
  font-style: uppercase;
}

.bonus-name {
  color: #000000;
  background: #9C27B0;
  font-weight: 600;
  font-style: uppercase;
}

.oneoff-name {
  color: #ffffff;
  background: #8e1600;
  font-weight: 600;
}

.day-close-btn {
  position: absolute;
  top: 0px;
  right: 0px;
  width: 0px;
  height: 0px;
  background: #fff;
  color: #fff;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 0px;
  cursor: pointer;
  z-index: -1;
  display: none;
}

.expanded .day-close-btn {
  display: flex;
}

.event-dots {
  display: flex;
  gap: 4px;
  justify-content: center;
  margin-top: 4px;
}

.event-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  display: inline-block;
}

.bill-dot {
  background-color: #e8e8e8;
}

.payday-dot {
  background-color: #4CAF50;
}

.bonus-dot {
  background-color: #9C27B0;
}

.oneoff-dot {
  background-color: #8e1600;
}

.day-events-container {
  max-height: 60vh;
  overflow-y: auto;
}

.day-events-section {
  margin-bottom: 16px;
}

.day-events-section h4 {
  margin-bottom: 10px;
}

.day-event-item {
  padding: 10px;
  margin-bottom: 8px;
  border-radius: 4px;
}

.historical-income-container {
  background: #f5f5f5;
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 24px;
  border: 2px solid #000000;
  animation: slideInUp 0.6s cubic-bezier(0.4, 0, 0.2, 1);
}

body.dark-mode .historical-income-container {
  background: #1a1a1a;
  border-color: #ffffff;
}

.historical-income-container h4 {
  color: #000000;
  font-size: 18px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  text-align: center;
  margin-bottom: 20px;
}

body.dark-mode .historical-income-container h4 {
  color: #ffffff;
}

.year-group {
  margin-bottom: 20px;
  border: 1px solid #000000;
  border-radius: 8px;
  padding: 15px;
  background: #ffffff;
}

body.dark-mode .year-group {
  border-color: #ffffff;
  background: #000000;
}

.year-header {
  text-align: center;
  font-size: 16px;
  font-weight: 600;
  color: #000000;
  margin-bottom: 12px;
}

body.dark-mode .year-header {
  color: #ffffff;
}

.year-totals {
  text-align: center;
  font-size: 14px;
  color: #666;
  margin-bottom: 15px;
}

body.dark-mode .year-totals {
  color: #999;
}

.months-list {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.month-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 12px;
  border-bottom: 1px solid #e8e8e8;
  font-size: 14px;
}

body.dark-mode .month-item {
  border-bottom-color: #333;
}

.month-item:last-child {
  border-bottom: none;
}

.month-name {
  font-weight: 500;
  color: #000000;
}

body.dark-mode .month-name {
  color: #ffffff;
}

.month-total {
  font-weight: 600;
  color: #000000;
}

body.dark-mode .month-total {
  color: #ffffff;
}

.color-palette {
  display: grid;
  grid-template-columns: repeat(8, 1fr);
  gap: 8px;
  margin-top: 8px;
}

.color-option {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  cursor: pointer;
  border: 3px solid transparent;
  transition: all 0.3s ease;
}

.color-option.selected {
  border-color: #000000;
  transform: scale(1.1);
}

body.dark-mode .color-option.selected {
  border-color: #ffffff;
}

.color-swatch {
  display: inline-block;
  width: 16px;
  height: 16px;
  border-radius: 50%;
  margin-right: 8px;
  border: 1px solid #ccc;
  vertical-align: middle;
}

.color-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  z-index: 10000;
  justify-content: center;
  align-items: center;
}

.color-modal-content {
  background: #ffffff;
  border: 2px solid #000000;
  border-radius: 16px;
  padding: 32px;
  max-width: 400px;
  width: 90%;
  color: #000000;
}

body.dark-mode .color-modal-content {
  background: #000000;
  border-color: #ffffff;
  color: #ffffff;
}

.color-option-item {
  display: flex;
  align-items: center;
  padding: 8px 12px;
  cursor: pointer;
  border-radius: 4px;
  margin: 4px 0;
  transition: background 0.2s ease;
}

.color-option-item:hover {
  background: rgba(0, 0, 0, 0.05);
}

body.dark-mode .color-option-item:hover {
  background: rgba(255, 255, 255, 0.05);
}

.person-color-dot {
  display: inline-block;
  width: 12px;
  height: 12px;
  border-radius: 50%;
  margin-right: 8px;
  border: 1px solid rgba(0, 0, 0, 0.2);
  vertical-align: middle;
}

body.dark-mode .person-color-dot {
  border-color: rgba(255, 255, 255, 0.3);
}

@keyframes slideInUp {
  from {
    opacity: 0;
    transform: translateY(30px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInScale {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes cascadeIn {
  from {
    opacity: 0;
    transform: translateY(20px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.cascade-item {
  animation: cascadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1) both;
}

.cascade-item:nth-child(1) {
  animation-delay: 0.05s;
}

.cascade-item:nth-child(2) {
  animation-delay: 0.1s;
}

.cascade-item:nth-child(3) {
  animation-delay: 0.15s;
}

.cascade-item:nth-child(4) {
  animation-delay: 0.2s;
}

.cascade-item:nth-child(5) {
  animation-delay: 0.25s;
}

.cascade-item:nth-child(6) {
  animation-delay: 0.3s;
}

.cascade-item:nth-child(7) {
  animation-delay: 0.35s;
}

.cascade-item:nth-child(8) {
  animation-delay: 0.4s;
}

.cascade-item:nth-child(9) {
  animation-delay: 0.45s;
}

.cascade-item:nth-child(10) {
  animation-delay: 0.5s;
}

@media (max-width: 1200px) {
  .overview-grid {
    grid-template-columns: repeat(4, 1fr);
    gap: 16px;
  }
  .stat-card {
    padding: 16px;
  }
  .stat-value {
    font-size: 20px;
  }
}

@media (max-width: 768px) {
  .tabs {
    flex-wrap: wrap;
    justify-content: center;
  }
  .overview-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 12px;
  }
  .person-overview, .transfer-grid {
    grid-template-columns: 1fr;
  }
  .greeting {
    font-size: 18px;
  }
  .hamburger-btn {
    width: 45px;
    height: 45px;
    font-size: 20px;
  }
  .tab {
    padding: 10px 16px;
    font-size: 12px;
  }
  .stat-card {
    padding: 12px;
  }
  .stat-value {
    font-size: 18px;
  }
  .calendar-day {
    min-height: 80px;
  }
  .bill-name, .payday-name, .bonus-name, .oneoff-name {
    font-size: 8px;
    padding: 1px 2px;
  }
  .calendar-day.expanded {
    min-height: 120px;
  }
  .header-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
  }
  #saveBtn, #importExportBtn {
    margin: 0;
    padding: 6px 12px;
    font-size: 12px;
  }
  .event-dot {
    width: 6px;
    height: 6px;
  }
  .event-dots {
    margin-top: 2px;
  }
  .history-table {
    table-layout: auto;
    min-width: 600px;
  }
  .history-table th, .history-table td {
    white-space: nowrap;
  }
  .history-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }
}

@media (max-width: 480px) {
  .overview-grid {
    grid-template-columns: repeat(2, 1fr);
    gap: 8px;
  }
  .greeting {
    font-size: 16px;
  }
  .hamburger-btn {
    width: 40px;
    height: 40px;
    font-size: 18px;
  }
  .tab {
    padding: 8px 12px;
    font-size: 11px;
  }
  .stat-card {
    padding: 8px;
  }
  
  .stat-value {
    font-size: 14px;
  }
  .container {
    padding: 0 10px;
  }
  body {
    padding: 10px;
  }
  .calendar-container {
    padding: 15px;
  }
  .calendar-day {
    min-height: 50px;
  }
  .day-number {
    font-size: 12px;
  }
  .calendar-day.expanded {
    min-height: auto;
    min-width: 60px;
    transition: all 0.3s ease;
  }
  .history-table {
    min-width: 550px;
    font-size: 12px;
  }
  .history-table th, .history-table td {
    padding: 8px 12px;
  }
}

</style>
</head><body>
<div class="fixed-header">
  <div class="header-content">
    <div class="header-left"><button id="hamburgerBtn" class="hamburger-btn">☰</button></div>
    <div class="greeting" id="greeting">Hello, Welcome!</div>
    <div class="header-right" style="padding-top: 8px;">
      <button id="importExportBtn" class="save-btn" onclick="showImportExportModal()">SAVE/IMPORT</button>
    </div>
  </div>
  <div id="sidebar" class="sidebar">
<ul class="sidebar-menu">
<li><button id="addNewPersonBtn">Add New User</button></li>
<li class="checkbox-group"><input type="checkbox" id="weightedBillsSidebar"><label for="weightedBillsSidebar">Weight Bills By Income</label></li>
<li><select id="currencySelect" class="currency-selector"><option value="USD">$USD</option><option value="EUR">€EUR</option><option value="GBP">£GBP</option><option value="JPY">¥JPY</option><option value="CAD">$CAD</option></select></li>
<li><button id="toggleDarkModeBtn">Dark Mode</button></li>
</ul>
</div>
</div>
<div class="container">
<div class="tabs" id="tabsContainer">
<button class="tab active" data-tab="overview">Overview</button>
<button class="tab" data-tab="bills">Bills</button>
<button class="tab" id="addPersonTab" data-tab="add-person" style="display: block;">+ Add User</button>
<button class="tab" data-tab="history">History</button>
</div>
<div id="overview" class="tab-content active">
<div id="transfersOverview" class="transfer-grid" style="display:none;"></div>
<div class="overview-grid">
<div class="stat-card cascade-item"><div class="stat-value" id="totalIncome">£0.00</div><div class="stat-label">Total Income</div></div>
<div class="stat-card cascade-item"><div class="stat-value" id="totalBills">£0.00</div><div class="stat-value" id="billsPercentage" style="font-size:16px;margin-top:4px;">0%</div><div class="stat-label">Total Bills</div></div>
<div class="stat-card cascade-item"><div class="stat-value" id="totalSavings">£0.00</div><div class="stat-value" id="savingsPercentage" style="font-size:16px;margin-top:4px;">0%</div><div class="stat-label">Total Savings</div></div>
<div class="stat-card cascade-item"><div class="stat-value" id="totalLeftover">£0.00</div><div class="stat-value" id="leftoverPercentage" style="font-size:16px;margin-top:4px;">0%</div><div class="stat-label">Leftover</div></div>
</div>
<div id="billCalendar" class="cascade-item">
        <div class="calendar-container">
            <h4>June 2025</h4>
            <div class="calendar-grid">
                <div class="calendar-header">Sun</div>
                <div class="calendar-header">Mon</div>
                <div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div>
                <div class="calendar-header">Thu</div>
                <div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
    
            <div class="calendar-day ">
                <div class="day-number">1</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">2</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">3</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">4</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">5</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">6</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">7</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">8</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">9</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">10</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">11</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">12</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">13</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">14</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">15</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">16</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">17</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">18</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">19</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">20</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">21</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">22</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">23</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">24</div>
                
                
            </div>
        
            <div class="calendar-day today">
                <div class="day-number">25</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">26</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">27</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">28</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">29</div>
                
                
            </div>
        
            <div class="calendar-day ">
                <div class="day-number">30</div>
                
                
            </div>
        </div></div></div>
<div id="peopleOverview" class="person-overview"></div>
<div id="oneOffOverview" class="card cascade-item" style="display:none;"><h3>One-off Expenses This Month</h3><div id="oneOffList"></div></div>
<div id="debtOverview" class="card cascade-item" style="display:none;"><h3>Debt Overview</h3><div id="debtsList"></div></div>
</div>
<div id="bills" class="tab-content">
<div class="card cascade-item">
<h3>Add New Bill</h3>
<div class="form-group"><label for="billName">Bill Name</label><input type="text" id="billName" placeholder="Enter bill name"></div>
<div class="form-group"><label for="billAmount">Amount</label><input type="number" id="billAmount" placeholder="0.00" step="0.01"></div>
<div class="form-group"><label for="billFrequency">Frequency</label><select id="billFrequency"><option value="monthly" selected="">Monthly</option><option value="quarterly">Quarterly</option><option value="yearly">Yearly</option></select></div>
<div class="form-group"><label for="billDate">Due Day of Month</label><select id="billDate"><option value="">Select day...</option><option value="1">1</option><option value="2">2</option><option value="3">3</option><option value="4">4</option><option value="5">5</option><option value="6">6</option><option value="7">7</option><option value="8">8</option><option value="9">9</option><option value="10">10</option><option value="11">11</option><option value="12">12</option><option value="13">13</option><option value="14">14</option><option value="15">15</option><option value="16">16</option><option value="17">17</option><option value="18">18</option><option value="19">19</option><option value="20">20</option><option value="21">21</option><option value="22">22</option><option value="23">23</option><option value="24">24</option><option value="25">25</option><option value="26">26</option><option value="27">27</option><option value="28">28</option><option value="29">29</option><option value="30">30</option><option value="31">31</option></select></div>
<div class="form-group" id="billMonthGroup" style="display:none;"><label for="billMonth">Month</label><select id="billMonth"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
<div class="form-group" id="billStartMonthGroup" style="display:none;"><label for="billStartMonth">Start Month</label><select id="billStartMonth"><option value="1">January</option><option value="2">February</option><option value="3">March</option><option value="4">April</option><option value="5">May</option><option value="6">June</option><option value="7">July</option><option value="8">August</option><option value="9">September</option><option value="10">October</option><option value="11">November</option><option value="12">December</option></select></div>
<div class="form-group"><label for="billCategory">Category</label><select id="billCategory"><option value="Utilities">Utilities</option><option value="Housing">Housing</option><option value="Transportation">Transportation</option><option value="Insurance">Insurance</option><option value="Entertainment">Entertainment</option><option value="Subscriptions">Subscriptions</option><option value="Government">Government</option><option value="Financial">Financial</option><option value="Health &amp; Fitness">Health &amp; Fitness</option><option value="Technology">Technology</option><option value="Other">Other</option></select></div>
<div class="form-group" id="billTypeGroup" style="display: none;"><label for="billType">Bill Type</label><select id="billType"><option value="individual">Individual</option><option value="joint">Joint</option></select></div>
<div class="form-group" id="billPayerGroup" style="display: none;"><label for="billPayer">Paid By</label><select id="billPayer"></select></div>
<div class="checkbox-group"><input type="checkbox" id="isDebt"><label for="isDebt">This is a debt/loan</label></div>
<div class="checkbox-group"><input type="checkbox" id="isOneOff"><label for="isOneOff">This is a one-off unexpected expense</label></div>
<div id="debtFields" style="display:none;">
<div class="form-group"><label for="totalDebt">Total Debt Amount</label><input type="number" id="totalDebt" placeholder="0.00" step="0.01"></div>
<div class="form-group"><label for="interestRate">Interest Rate (% - optional)</label><input type="number" id="interestRate" placeholder="0.00" step="0.01"></div>
<div class="form-group"><label for="termYears">Term Length Years (optional)</label><input type="number" id="termYears" placeholder="30" min="0"></div>
<div class="form-group"><label for="termMonths">Additional Months (optional)</label><input type="number" id="termMonths" placeholder="0" min="0" max="11"></div>
<div class="form-group"><label for="overpayment">Monthly Overpayment (optional)</label><input type="number" id="overpayment" placeholder="0.00" step="0.01"></div>
</div>
<button id="addBillBtn">Add Bill</button>
</div>
<div class="card cascade-item"><h3>All Bills</h3><div id="billsList"></div></div>
</div>
<div id="history" class="tab-content">
<div class="card cascade-item">
<h3>Income &amp; Salary History</h3>
<div class="form-group"><label for="historyPersonFilter">Filter by Person</label><select id="historyPersonFilter"><option value="all">All People</option></select></div>
<div class="form-group"><label for="historyStartDate">Start Date</label><input type="date" id="historyStartDate"></div>
<div class="form-group"><label for="historyEndDate">End Date</label><input type="date" id="historyEndDate"></div>
<button id="clearHistoryFiltersBtn">Clear Filters</button>
<button id="fullResetBtn" class="btn-danger" style="margin-top:8px;">Full Reset</button>
<div class="history-table-wrapper"><table class="history-table"><thead><tr><th>Date</th><th>Person</th><th>Type</th><th>Amount</th><th>Description</th><th>Actions</th></tr></thead><tbody id="incomeHistoryList"><tr><td colspan="6">No income data for selected person.</td></tr></tbody></table></div>
</div>
<div class="card cascade-item"><h3>Bill History</h3><div class="history-table-wrapper"><table class="history-table"><thead><tr><th>Date</th><th>Bill Name</th><th>Amount</th><th>Category</th><th>Type</th><th>Status</th></tr></thead><tbody id="billHistoryList"><tr><td colspan="6">No bill payments for selected person.</td></tr></tbody></table></div></div>
<div class="card cascade-item"><h3>Event History</h3><div class="history-table-wrapper"><table class="history-table"><thead><tr><th>Date</th><th>Event</th><th>Description</th><th>Actions</th></tr></thead><tbody id="eventHistoryList"><tr><td colspan="4">No events for selected person.</td></tr></tbody></table></div></div>
</div>
</div>
<script id="embedded-data" type="application/json">{
        "people": [],
        "bills": [],
        "currency": "GBP",
        "darkMode": false,
        "weightedBills": false,
        "nextPersonId": 1,
        "nextBillId": 1,
        "nextIncomeId": 1,
        "nextEventId": 2,
        "nextPaycheckId": 1,
        "paycheckHistory": [],
        "billHistory": [],
        "eventHistory": [],
        "billPayments": [],
        "lastProcessedDate": "2025-06-25",
        "peopleIncomeSettings": {},
        "savedFileHandle": null
}</script>
<script>
let data = {};
let nextPersonId = 1;
let nextBillId = 1;
let nextIncomeId = 1;
let nextEventId = 1;
let nextPaycheckId = 1;
let hasChanges = false;
let originalEmbeddedData = {};
let sessionStartData = {};
let savedFileHandle = null;
const STORAGE_KEY = 'budgetTrackerData';
const $ = id => document.getElementById(id);
const colorPalette = [
    {name: 'Moss', value: '#b9b99d'},
    {name: 'Blush', value: '#E0CFC3'},
    {name: 'Sand', value: '#D5caba'},
    {name: 'Fir', value: '#606c5a'},
    {name: 'Earth', value: '#8f837a'},
    {name: 'Water', value: '#95a8ac'},
    {name: 'Golden', value: '#dcb482'}
];


let currentViewMonth = new Date().getMonth();
let currentViewYear = new Date().getFullYear();

function updateCalendarView(year = null, month = null) {
    if (year !== null) currentViewYear = year;
    if (month !== null) currentViewMonth = month;
    
    const billCalendar = document.getElementById('billCalendar');
    if (!billCalendar) return;
    
    billCalendar.innerHTML = createCalendarView(currentViewYear, currentViewMonth);
    
    initCalendarInteractions();
}

function navigateCalendar(direction) {
    if (direction === -1) {
        let newMonth = currentViewMonth - 1;
        let newYear = currentViewYear;
        
        if (newMonth < 0) {
            newMonth = 11;
            newYear--;
        }
        
        currentViewMonth = newMonth;
        currentViewYear = newYear;
    } else if (direction === 1) {
        let newMonth = currentViewMonth + 1;
        let newYear = currentViewYear;
        
        if (newMonth > 11) {
            newMonth = 0;
            newYear++;
        }
        
        currentViewMonth = newMonth;
        currentViewYear = newYear;
    }
    
    updateCalendarView();
}

function createCalendarView(year = null, month = null) {
    const today = new Date();
    const currentMonth = month !== null ? month : today.getMonth();
    const currentYear = year !== null ? year : today.getFullYear();
    
    const firstDay = new Date(currentYear, currentMonth, 1);
    const lastDay = new Date(currentYear, currentMonth + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    const prevMonth = new Date(currentYear, currentMonth, 0);
    const prevMonthDays = prevMonth.getDate();
    
    const monthNames = ["January", "February", "March", "April", "May", "June", 
                       "July", "August", "September", "October", "November", "December"];
    
    const viewDate = new Date(currentYear, currentMonth, 1);
    const isFutureView = viewDate > today;
    const isPastView = viewDate.getFullYear() < today.getFullYear() || 
                     (viewDate.getFullYear() === today.getFullYear() && viewDate.getMonth() < today.getMonth());
    
    let calendarHTML = `
        <div class="calendar-container">
            <div class="calendar-header-row">
                <button id="prevMonthBtn" class="calendar-btn">&lt;</button>
                <h4>${monthNames[currentMonth]} ${currentYear}</h4>
                <button id="nextMonthBtn" class="calendar-btn">&gt;</button>
            </div>
            <div class="calendar-grid" id="calendarGrid">
                <div class="calendar-header">Sun</div>
                <div class="calendar-header">Mon</div>
                <div class="calendar-header">Tue</div>
                <div class="calendar-header">Wed</div>
                <div class="calendar-header">Thu</div>
                <div class="calendar-header">Fri</div>
                <div class="calendar-header">Sat</div>
    `;
    
    let dayCount = 1;
    let nextMonthDay = 1;
    
    const totalDaysToShow = startingDayOfWeek + daysInMonth;
    const totalRows = Math.ceil(totalDaysToShow / 7);
    
    for (let i = 0; i < totalRows; i++) {
        for (let j = 0; j < 7; j++) {
            if (i === 0 && j < startingDayOfWeek) {
                const prevDate = prevMonthDays - (startingDayOfWeek - j - 1);
                const prevMonthDate = new Date(currentYear, currentMonth - 1, prevDate);
                
                const billsForDay = [];
                const paydaysForDay = [];
                const bonusesForDay = [];
                const oneOffsForDay = [];
                
                // Check for bills on this day from previous month
                data.bills.forEach(bill => {
                    if (bill.isDeleted) return;
                    
                    const billCreatedDate = bill.dateCreated ? new Date(bill.dateCreated) : new Date(0);
                    
                    if (bill.isOneOff) {
                        const billDate = new Date(bill.date);
                        if (billDate.getDate() === prevDate && 
                            billDate.getMonth() === prevMonthDate.getMonth() && 
                            billDate.getFullYear() === prevMonthDate.getFullYear()) {
                            
                            const payer = bill.payer === 'joint' ? null : data.people.find(p => p.id === bill.payer);
                            oneOffsForDay.push({
                                ...bill,
                                payerColor: payer ? payer.color : null
                            });
                        }
                        return;
                    }
                    
                    if (prevMonthDate < billCreatedDate && isPastView) {
                        return;
                    }
                    
                    let shouldShow = false;
                    const billDay = bill.day || new Date(bill.date).getDate();
                    
                    if (bill.frequency === 'yearly' && bill.month) {
                        if (bill.month - 1 === prevMonthDate.getMonth() && billDay === prevDate) {
                            shouldShow = true;
                        }
                    } else if (bill.frequency === 'quarterly') {
                        const billDate = new Date(bill.date);
                        const billStartMonth = bill.startMonth || billDate.getMonth() + 1;
                        let quarterMonths = [];
                        for (let k = 0; k < 4; k++) {
                            quarterMonths.push(((billStartMonth - 1 + k * 3) % 12) + 1);
                        }
                        if (quarterMonths.includes(prevMonthDate.getMonth() + 1) && billDay === prevDate) {
                            shouldShow = true;
                        }
                    } else if (bill.frequency === 'monthly') {
                        if (billDay === prevDate) {
                            shouldShow = true;
                        }
                    }
                    
                    if (shouldShow) {
                        const payer = bill.payer === 'joint' ? null : data.people.find(p => p.id === bill.payer);
                        billsForDay.push({
                            ...bill,
                            payerColor: payer ? payer.color : null
                        });
                    }
                });
                
                // Check for paydays on this day from previous month
                data.paycheckHistory.forEach(paycheck => {
                    const paycheckDate = new Date(paycheck.date);
                    if (paycheckDate.getDate() === prevDate && 
                        paycheckDate.getMonth() === prevMonthDate.getMonth() && 
                        paycheckDate.getFullYear() === prevMonthDate.getFullYear()) {
                        
                        const person = data.people.find(p => p.id === paycheck.personId);
                        if (person) {
                            if (paycheck.type === 'bonus') {
                                bonusesForDay.push({ person, amount: paycheck.amount });
                            } else {
                                paydaysForDay.push({ ...person, amount: paycheck.amount });
                            }
                        }
                    }
                });
                
                const hasBills = billsForDay.length > 0;
                const hasPaydays = paydaysForDay.length > 0;
                const hasBonuses = bonusesForDay.length > 0;
                const hasOneOffs = oneOffsForDay.length > 0;
                const hasEvents = hasBills || hasPaydays || hasBonuses || hasOneOffs;
                
                let billText = '';
                let paydayText = '';
                let bonusText = '';
                let oneOffText = '';
                
                billText = billsForDay.map(bill => {
                    const backgroundColor = bill.payerColor ? bill.payerColor : '#e8e8e8';
                    const textColor = bill.payerColor ? getContrastColor(bill.payerColor) : '#000000';
                    return `<span class="bill-name" style="background-color: ${backgroundColor}; color: ${textColor};">${bill.name}: ${formatCurrency(bill.amount + (bill.overpayment || 0))}</span>`;
                }).join('');
                
                paydayText = paydaysForDay.map(person => {
                    return `<span class="payday-name" style="background-color: ${person.color}; color: #000000;">${person.name} Payday: ${formatCurrency(person.amount || person.income || 0)}</span>`;
                }).join('');
                
                bonusText = bonusesForDay.map(bonus => {
                    return `<span class="bonus-name" style="background-color: ${bonus.person.color}; color: #000000;">${bonus.person.name} Bonus: ${formatCurrency(bonus.amount)}</span>`;
                }).join('');
                
                oneOffText = oneOffsForDay.map(oneOff => {
                    const backgroundColor = oneOff.payerColor ? oneOff.payerColor : '#8e1600';
                    const textColor = oneOff.payerColor ? getContrastColor(oneOff.payerColor) : '#ffffff';
                    return `<span class="oneoff-name" style="background-color: ${backgroundColor}; color: ${textColor};">${oneOff.name}: ${formatCurrency(oneOff.amount)}</span>`;
                }).join('');
                
                calendarHTML += `
                    <div class="calendar-day empty" data-day="${prevDate}" data-month="${prevMonthDate.getMonth()}" data-year="${prevMonthDate.getFullYear()}">
                        <div class="day-close-btn">×</div>
                        <div class="day-number">${prevDate}</div>
                        <div class="day-events">
                            ${billText}
                            ${paydayText}
                            ${bonusText}
                            ${oneOffText}
                        </div>
                    </div>
                `;
            } else if (dayCount > daysInMonth) {
                const nextMonthDate = new Date(currentYear, currentMonth + 1, nextMonthDay);
                
                const billsForDay = [];
                const paydaysForDay = [];
                const bonusesForDay = [];
                const oneOffsForDay = [];
                
                // Check for bills on this day from next month
                data.bills.forEach(bill => {
                    if (bill.isDeleted) return;
                    
                    const billCreatedDate = bill.dateCreated ? new Date(bill.dateCreated) : new Date(0);
                    
                    if (bill.isOneOff) {
                        const billDate = new Date(bill.date);
                        if (billDate.getDate() === nextMonthDay && 
                            billDate.getMonth() === nextMonthDate.getMonth() && 
                            billDate.getFullYear() === nextMonthDate.getFullYear()) {
                            
                            const payer = bill.payer === 'joint' ? null : data.people.find(p => p.id === bill.payer);
                            oneOffsForDay.push({
                                ...bill,
                                payerColor: payer ? payer.color : null
                            });
                        }
                        return;
                    }
                    
                    if (nextMonthDate < billCreatedDate && isPastView) {
                        return;
                    }
                    
                    let shouldShow = false;
                    const billDay = bill.day || new Date(bill.date).getDate();
                    
                    if (bill.frequency === 'yearly' && bill.month) {
                        if (bill.month - 1 === nextMonthDate.getMonth() && billDay === nextMonthDay) {
                            shouldShow = true;
                        }
                    } else if (bill.frequency === 'quarterly') {
                        const billDate = new Date(bill.date);
                        const billStartMonth = bill.startMonth || billDate.getMonth() + 1;
                        let quarterMonths = [];
                        for (let k = 0; k < 4; k++) {
                            quarterMonths.push(((billStartMonth - 1 + k * 3) % 12) + 1);
                        }
                        if (quarterMonths.includes(nextMonthDate.getMonth() + 1) && billDay === nextMonthDay) {
                            shouldShow = true;
                        }
                    } else if (bill.frequency === 'monthly') {
                        if (billDay === nextMonthDay) {
                            shouldShow = true;
                        }
                    }
                    
                    if (shouldShow) {
                        const payer = bill.payer === 'joint' ? null : data.people.find(p => p.id === bill.payer);
                        billsForDay.push({
                            ...bill,
                            payerColor: payer ? payer.color : null
                        });
                    }
                });
                
                // Check for paydays on this day from next month
                data.paycheckHistory.forEach(paycheck => {
                    const paycheckDate = new Date(paycheck.date);
                    if (paycheckDate.getDate() === nextMonthDay && 
                        paycheckDate.getMonth() === nextMonthDate.getMonth() && 
                        paycheckDate.getFullYear() === nextMonthDate.getFullYear()) {
                        
                        const person = data.people.find(p => p.id === paycheck.personId);
                        if (person) {
                            if (paycheck.type === 'bonus') {
                                bonusesForDay.push({ person, amount: paycheck.amount });
                            } else {
                                paydaysForDay.push({ ...person, amount: paycheck.amount });
                            }
                        }
                    }
                });
                
                const hasBills = billsForDay.length > 0;
                const hasPaydays = paydaysForDay.length > 0;
                const hasBonuses = bonusesForDay.length > 0;
                const hasOneOffs = oneOffsForDay.length > 0;
                const hasEvents = hasBills || hasPaydays || hasBonuses || hasOneOffs;
                
                let billText = '';
                let paydayText = '';
                let bonusText = '';
                let oneOffText = '';
                
                billText = billsForDay.map(bill => {
                    const backgroundColor = bill.payerColor ? bill.payerColor : '#e8e8e8';
                    const textColor = bill.payerColor ? getContrastColor(bill.payerColor) : '#000000';
                    return `<span class="bill-name" style="background-color: ${backgroundColor}; color: ${textColor};">${bill.name}: ${formatCurrency(bill.amount + (bill.overpayment || 0))}</span>`;
                }).join('');
                
                paydayText = paydaysForDay.map(person => {
                    return `<span class="payday-name" style="background-color: ${person.color}; color: #000000;">${person.name} Payday: ${formatCurrency(person.amount || person.income || 0)}</span>`;
                }).join('');
                
                bonusText = bonusesForDay.map(bonus => {
                    return `<span class="bonus-name" style="background-color: ${bonus.person.color}; color: #000000;">${bonus.person.name} Bonus: ${formatCurrency(bonus.amount)}</span>`;
                }).join('');
                
                oneOffText = oneOffsForDay.map(oneOff => {
                    const backgroundColor = oneOff.payerColor ? oneOff.payerColor : '#8e1600';
                    const textColor = oneOff.payerColor ? getContrastColor(oneOff.payerColor) : '#ffffff';
                    return `<span class="oneoff-name" style="background-color: ${backgroundColor}; color: ${textColor};">${oneOff.name}: ${formatCurrency(oneOff.amount)}</span>`;
                }).join('');
                
                calendarHTML += `
                    <div class="calendar-day empty" data-day="${nextMonthDay}" data-month="${nextMonthDate.getMonth()}" data-year="${nextMonthDate.getFullYear()}">
                        <div class="day-close-btn">×</div>
                        <div class="day-number">${nextMonthDay}</div>
                        <div class="day-events">
                            ${billText}
                            ${paydayText}
                            ${bonusText}
                            ${oneOffText}
                        </div>
                    </div>
                `;
                nextMonthDay++;
            } else {
                const isToday = dayCount === today.getDate() && 
                               currentMonth === today.getMonth() && 
                               currentYear === today.getFullYear();
                
                const currentDayDate = new Date(currentYear, currentMonth, dayCount);
                
                const billsForDay = [];
                const paydaysForDay = [];
                const bonusesForDay = [];
                const oneOffsForDay = [];
                
                data.bills.forEach(bill => {
                    if (bill.isDeleted) return;
                    
                    const billCreatedDate = bill.dateCreated ? new Date(bill.dateCreated) : new Date(0);
                    
                    if (bill.isOneOff) {
                        const billDate = new Date(bill.date);
                        if (billDate.getDate() === dayCount && 
                            billDate.getMonth() === currentMonth && 
                            billDate.getFullYear() === currentYear) {
                            
                            const payer = bill.payer === 'joint' ? null : data.people.find(p => p.id === bill.payer);
                            oneOffsForDay.push({
                                ...bill,
                                payerColor: payer ? payer.color : null
                            });
                        }
                        return;
                    }
                    
                    if (currentDayDate < billCreatedDate && isPastView) {
                        return;
                    }
                    
                    let shouldShow = false;
                    const billDay = bill.day || new Date(bill.date).getDate();
                    
                    if (bill.frequency === 'yearly' && bill.month) {
                        if (bill.month - 1 === currentMonth && billDay === dayCount) {
                            shouldShow = true;
                        }
                    } else if (bill.frequency === 'quarterly') {
                        const billDate = new Date(bill.date);
                        const billStartMonth = bill.startMonth || billDate.getMonth() + 1;
                        let quarterMonths = [];
                        for (let k = 0; k < 4; k++) {
                            quarterMonths.push(((billStartMonth - 1 + k * 3) % 12) + 1);
                        }
                        if (quarterMonths.includes(currentMonth + 1) && billDay === dayCount) {
                            shouldShow = true;
                        }
                    } else if (bill.frequency === 'monthly') {
                        if (billDay === dayCount) {
                            shouldShow = true;
                        } else if (billDay > daysInMonth && dayCount === daysInMonth) {
                            shouldShow = true;
                        }
                    }
                    
                    if (shouldShow) {
                        const payer = bill.payer === 'joint' ? null : data.people.find(p => p.id === bill.payer);
                        billsForDay.push({
                            ...bill,
                            displayNote: billDay > daysInMonth ? ` (moved from ${billDay})` : '',
                            payerColor: payer ? payer.color : null
                        });
                    }
                });
                
                data.paycheckHistory.forEach(paycheck => {
                    const paycheckDate = new Date(paycheck.date);
                    if (paycheckDate.getDate() === dayCount && 
                        paycheckDate.getMonth() === currentMonth && 
                        paycheckDate.getFullYear() === currentYear) {
                        
                        const person = data.people.find(p => p.id === paycheck.personId);
                        if (person) {
                            if (paycheck.type === 'bonus') {
                                bonusesForDay.push({ person, amount: paycheck.amount });
                            } else {
                                paydaysForDay.push({ ...person, amount: paycheck.amount });
                            }
                        }
                    }
                });
                
                if (!isPastView) {
                    data.people.forEach(person => {
                        if (isPaydayOnDate(person, dayCount, currentMonth, currentYear)) {
                            if (!paydaysForDay.some(p => p.id === person.id)) {
                                paydaysForDay.push(person);
                            }
                        }
                    });
                }
                
                const hasBills = billsForDay.length > 0;
                const hasPaydays = paydaysForDay.length > 0;
                const hasBonuses = bonusesForDay.length > 0;
                const hasOneOffs = oneOffsForDay.length > 0;
                const hasEvents = hasBills || hasPaydays || hasBonuses || hasOneOffs;
                
                let billText = '';
                let paydayText = '';
                let bonusText = '';
                let oneOffText = '';
                
                billText = billsForDay.map(bill => {
                    const backgroundColor = bill.payerColor ? bill.payerColor : '#e8e8e8';
                    const textColor = bill.payerColor ? getContrastColor(bill.payerColor) : '#000000';
                    return `<span class="bill-name" style="background-color: ${backgroundColor}; color: ${textColor};">${bill.name}: ${formatCurrency(bill.amount + (bill.overpayment || 0))}${bill.displayNote || ''}</span>`;
                }).join('');
                
                paydayText = paydaysForDay.map(person => {
                    return `<span class="payday-name" style="background-color: ${person.color}; color: #000000;">${person.name} Payday: ${formatCurrency(person.amount || person.income || 0)}</span>`;
                }).join('');
                
                bonusText = bonusesForDay.map(bonus => {
                    return `<span class="bonus-name" style="background-color: ${bonus.person.color}; color: #000000;">${bonus.person.name} Bonus: ${formatCurrency(bonus.amount)}</span>`;
                }).join('');
                
                oneOffText = oneOffsForDay.map(oneOff => {
                    const backgroundColor = oneOff.payerColor ? oneOff.payerColor : '#8e1600';
                    const textColor = oneOff.payerColor ? getContrastColor(oneOff.payerColor) : '#ffffff';
                    return `<span class="oneoff-name" style="background-color: ${backgroundColor}; color: ${textColor};">${oneOff.name}: ${formatCurrency(oneOff.amount)}</span>`;
                }).join('');
                
                calendarHTML += `
                    <div class="calendar-day ${isToday ? 'today' : ''}" data-day="${dayCount}" data-month="${currentMonth}" data-year="${currentYear}">
                        <div class="day-close-btn">×</div>
                        <div class="day-number">${dayCount}</div>
                        <div class="day-events">
                            ${billText}
                            ${paydayText}
                            ${bonusText}
                            ${oneOffText}
                        </div>
                    </div>
                `;
                dayCount++;
            }
        }
    }
    
    calendarHTML += '</div></div>';
    calendarHTML += '<div class="calendar-overlay" id="calendarOverlay"></div>';
    return calendarHTML;
}

function navigateCalendar(direction) {
    let newMonth = currentViewMonth + direction;
    let newYear = currentViewYear;
    
    if (newMonth > 11) {
        newMonth = 0;
        newYear++;
    } else if (newMonth < 0) {
        newMonth = 11;
        newYear--;
    }
    
    currentViewMonth = newMonth;
    currentViewYear = newYear;
    updateCalendarView();
}

function resetCalendarToCurrentMonth() {
    const today = new Date();
    currentViewMonth = today.getMonth();
    currentViewYear = today.getFullYear();
    updateCalendarView();
}

function frequencyToMonthly(amount, frequency) {
    switch (frequency) {
        case 'biweekly': return amount * 26 / 12;
        case 'monthly': return amount;
        case 'quarterly': return amount / 3;
        case 'yearly': return amount / 12;
        default: return amount;
    }
}

function showImportExportModal() {
    let modal = $('editModal');
    let modalContent;
    
    if (!modal) {
        const modalData = createModal();
        modal = modalData.modal;
        modalContent = modalData.modalContent;
    } else {
        modalContent = $('modalContent');
    }
    
    modalContent.innerHTML = `
        <h3 style="margin-bottom:10px;color:${document.body.classList.contains('dark-mode') ? '#fff' : '#000'};text-align:center;">SAVE/IMPORT</h3>
        
        <p style="text-align:center;margin-bottom:25px;padding:10px;background-color:${document.body.classList.contains('dark-mode') ? '#333' : '#f5f5f5'};border-radius:5px;font-size:14px;color:${document.body.classList.contains('dark-mode') ? '#ff9' : '#800'};">
            For security, all data is deleted when you close this page unless you export or save it. Remember to save your changes before leaving.
        </p>
        
        <div style="display:flex;flex-direction:column;gap:20px;margin-bottom:20px;">
            <div>
                <button id="importBtn" style="width:100%;height:60px;font-size:16px;font-weight:bold;">IMPORT</button>
                <p style="margin-top:5px;font-size:13px;color:${document.body.classList.contains('dark-mode') ? '#ccc' : '#666'};">
                    Load your previously exported .txt file to view your budget.
                </p>
            </div>
            
            <div>
                <button id="exportBtn" style="width:100%;height:60px;font-size:16px;font-weight:bold;">EXPORT</button>
                <p style="margin-top:5px;font-size:13px;color:${document.body.classList.contains('dark-mode') ? '#ccc' : '#666'};">
                    Create a unique encoded .txt file with your budget data. Save to your device, or to a cloud service to access from any device or to share with others.
                </p>
            </div>
            
            <div>
                <button id="saveLocalFileBtn" style="width:100%;height:60px;font-size:16px;font-weight:bold;">SAVE LOCAL FILE</button>
                <p style="margin-top:5px;font-size:13px;color:${document.body.classList.contains('dark-mode') ? '#ccc' : '#666'};">
                    Save an .html file to your desktop or phone to view later. Every time you resave the file all the changes you make will be encoded into your .html file so your data can't be accessed unless you have the .html file.
                </p>
            </div>
        </div>
        
        <div style="margin-top:20px;text-align:center;">
            <button id="closeModalBtn" style="background:#666;width:150px;">Close</button>
        </div>
    `;
    
    $('importBtn').addEventListener('click', () => {
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.txt';
        fileInput.style.display = 'none';
        document.body.appendChild(fileInput);
        
        fileInput.click();
        
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) {
                document.body.removeChild(fileInput);
                return;
            }
            
            if (!confirm('Importing will replace all current data with the data from the selected file. Continue?')) {
                document.body.removeChild(fileInput);
                return;
            }
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const fileContent = e.target.result;
                    const importData = JSON.parse(atob(fileContent.trim()));
                    
                    if (!importData.people || !importData.bills) {
                        throw new Error('Invalid import data format');
                    }
                    
                    data.people = importData.people || [];
                    data.bills = importData.bills || [];
                    data.currency = importData.currency || 'USD';
                    data.darkMode = importData.darkMode || false;
                    data.weightedBills = importData.weightedBills || false;
                    data.paycheckHistory = importData.paycheckHistory || [];
                    data.billHistory = importData.billHistory || [];
                    data.eventHistory = importData.eventHistory || [];
                    data.billPayments = importData.billPayments || [];
                    data.lastProcessedDate = importData.lastProcessedDate || null;
                    data.peopleIncomeSettings = importData.peopleIncomeSettings || {};
                    
                    nextPersonId = Math.max(1, ...data.people.map(p => p.id + 1));
                    nextBillId = Math.max(1, ...data.bills.map(b => b.id + 1));
                    nextIncomeId = Math.max(1, ...data.people.map(p => (p.incomeHistory || []).map(i => i.id + 1)).flat());
                    nextEventId = Math.max(1, ...data.eventHistory.map(e => e.id + 1));
                    nextPaycheckId = Math.max(1, ...data.paycheckHistory.map(p => p.id + 1));
                    
                    document.querySelectorAll('.tab[data-person-id]').forEach(tab => tab.remove());
                    document.querySelectorAll('.tab-content[id^="person-"]').forEach(content => content.remove());
                    
                    if (data.darkMode) {
                        document.body.classList.add('dark-mode');
                    } else {
                        document.body.classList.remove('dark-mode');
                    }
                    
                    $('currencySelect').value = data.currency;
                    $('weightedBillsSidebar').checked = data.weightedBills;
                    
                    data.people.forEach(person => createPersonTab(person));
                    attachPersonEventListeners();
                    updateGreeting();
                    updateBillPayerOptions();
                    updateBillsList();
                    updateHistoryDisplay();
                    updateOverview();
                    toggleBillTypeVisibility();
                    updateTabsVisibility();
                    
                    data.eventHistory.push({
                        id: nextEventId++,
                        date: new Date().toISOString().split('T')[0],
                        event: 'Data Imported',
                        description: 'Imported data from a budget file'
                    });
                    
                    saveDataToLocalStorage();
                    hideModal();
                    showTab('overview');
                    
                    alert('Data imported successfully!');
                    
                } catch (e) {
                    console.error('Import error:', e);
                    alert('Failed to import data. The file may be invalid or corrupted.');
                }
                
                document.body.removeChild(fileInput);
            };
            
            reader.readAsText(file);
        });
    });
    
    $('exportBtn').addEventListener('click', () => {
        const exportData = {
            people: data.people,
            bills: data.bills,
            currency: data.currency,
            darkMode: data.darkMode,
            weightedBills: data.weightedBills,
            paycheckHistory: data.paycheckHistory,
            billHistory: data.billHistory,
            eventHistory: data.eventHistory,
            billPayments: data.billPayments,
            lastProcessedDate: data.lastProcessedDate,
            peopleIncomeSettings: data.peopleIncomeSettings
        };
        
        const exportString = btoa(JSON.stringify(exportData));
        const blob = new Blob([exportString], { type: 'text/plain' });
        
        if ('showSaveFilePicker' in window) {
            async function saveWithFilePicker() {
                try {
                    const handle = await window.showSaveFilePicker({
                        suggestedName: 'budget_data.txt',
                        types: [{
                            description: 'Text Files',
                            accept: { 'text/plain': ['.txt'] }
                        }]
                    });
                    
                    const writable = await handle.createWritable();
                    await writable.write(exportString);
                    await writable.close();
                    
                    data.eventHistory.push({
                        id: nextEventId++,
                        date: new Date().toISOString().split('T')[0],
                        event: 'Data Exported',
                        description: 'Exported budget data to text file'
                    });
                    
                    saveDataToLocalStorage();
                } catch (err) {
                    if (err.name !== 'AbortError') {
                        console.error('Error saving file:', err);
                        alert('Error saving file. Please try again.');
                    }
                }
            }
            
            saveWithFilePicker();
        } else {
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'budget_data.txt';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            data.eventHistory.push({
                id: nextEventId++,
                date: new Date().toISOString().split('T')[0],
                event: 'Data Exported',
                description: 'Exported budget data to text file'
            });
            
            saveDataToLocalStorage();
        }
    });
    
    $('saveLocalFileBtn').addEventListener('click', () => {
        hideModal();
        saveDataToFile();
    });
    
    $('closeModalBtn').addEventListener('click', hideModal);
    
    showModal();
}

function calculateMonthlyBudget(person) {
    let monthlyIncome = 0;
    
    if (person.income && person.frequency && person.paymentDate) {
        const today = new Date();
        const currentMonth = today.getMonth();
        const currentYear = today.getFullYear();
        
        if (person.frequency === 'biweekly') {
            const paymentDate = new Date(person.paymentDate);
            let paydayCount = 0;
            
            let checkDate = new Date(currentYear, currentMonth, 1);
            const monthEnd = new Date(currentYear, currentMonth + 1, 0);
            
            while (checkDate <= monthEnd) {
                if (isPaydayOnDate(person, checkDate.getDate(), currentMonth, currentYear)) {
                    paydayCount++;
                }
                checkDate.setDate(checkDate.getDate() + 1);
            }
            
            monthlyIncome = person.income * paydayCount;
        } else {
            monthlyIncome = frequencyToMonthly(person.income, person.frequency);
        }
    }
    
    const currentMonth = new Date().toISOString().substring(0, 7);
    const currentMonthBonuses = data.paycheckHistory
        .filter(p => p.personId === person.id && p.type === 'bonus' && p.date.startsWith(currentMonth))
        .reduce((sum, bonus) => sum + bonus.amount, 0);
    
    return monthlyIncome + currentMonthBonuses;
}

function calculateIncomeRatio() {
    const totalIncome = data.people.reduce((sum, p) => sum + calculateMonthlyBudget(p), 0);
    return data.people.map(p => ({
        id: p.id,
        ratio: totalIncome ? calculateMonthlyBudget(p) / totalIncome : 1 / data.people.length
    }));
}

function calculateWeightedShare(billAmount, personId, useWeighted = false) {
    if (!useWeighted || data.people.length <= 1) {
        return billAmount / data.people.length;
    }
    
    const incomeRatios = calculateIncomeRatio();
    const personRatio = incomeRatios.find(r => r.id === personId)?.ratio || (1 / data.people.length);
    return billAmount * personRatio;
}

function calculateSetAsideAmount(billAmount, frequency, isDebt, interestRate, currentDebtBalance) {
    if (frequency === 'monthly') {
        return 0;
    }
    
    const periods = frequency === 'quarterly' ? 3 : 12;
    
    if (isDebt && interestRate && interestRate > 0 && currentDebtBalance > 0) {
        const monthlyRate = interestRate / 100 / 12;
        let debtGrowth = 0;
        let tempBalance = currentDebtBalance;
        
        for (let i = 0; i < periods; i++) {
            debtGrowth += tempBalance * monthlyRate;
            tempBalance += (tempBalance * monthlyRate);
        }
        
        const adjustedPayment = billAmount + (debtGrowth / periods);
        return adjustedPayment / periods;
    }
    
    return billAmount / periods;
}

function updatePersonIncome(personId) {
    const person = data.people.find(p => p.id === personId);
    if (!person) return;
    
    const oldIncome = person.income || 0;
    const oldFrequency = person.frequency;
    const oldPaymentDate = person.paymentDate;
    const oldEmployer = person.employer || '';
    
    const income = parseFloat($(`income-${personId}`).value) || 0;
    const frequency = $(`frequency-${personId}`).value;
    const paymentDate = $(`paymentDate-${personId}`).value;
    const employer = $(`employer-${personId}`).value.trim();
    
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    if (oldPaymentDate !== paymentDate && oldPaymentDate && paymentDate) {
        const oldDate = new Date(oldPaymentDate);
        const newDate = new Date(paymentDate);
        
        if (frequency === 'biweekly') {
            updateBiweeklyPaydayChanges(personId, oldDate, newDate, today);
        } else if (frequency === 'monthly' || frequency === 'quarterly' || frequency === 'yearly') {
            updateRegularPaydayChanges(personId, oldDate, newDate, frequency, today);
        }
    }
    
    if (oldIncome !== income && oldPaymentDate === paymentDate && paymentDate) {
        const paymentDateObj = new Date(paymentDate);
        const isCurrentMonth = paymentDateObj.getMonth() === currentMonth && 
                              paymentDateObj.getFullYear() === currentYear;
        
        if (isCurrentMonth) {
            const existingPaycheck = data.paycheckHistory.find(p => 
                p.personId === personId && 
                p.date === paymentDate && 
                p.type === 'salary' &&
                !p.isAdditional
            );
            
            if (existingPaycheck) {
                const oldAmount = existingPaycheck.amount;
                existingPaycheck.amount = income;
                existingPaycheck.description += ' (amount updated)';
                
                data.eventHistory.push({
                    id: nextEventId++,
                    date: new Date().toISOString().split('T')[0],
                    event: 'Current Month Salary Updated',
                    description: `Updated ${person.name}'s salary for ${paymentDate} from ${formatCurrency(oldAmount)} to ${formatCurrency(income)}`
                });
            }
        }
    }
    
    person.income = income;
    person.frequency = frequency;
    person.paymentDate = paymentDate;
    person.employer = employer;
    
    if (income > 0 && paymentDate) {
        const paymentDateObj = new Date(paymentDate);
        const isFirstTimeSetup = !data.peopleIncomeSettings || !data.peopleIncomeSettings[personId];
        const shouldLogCurrentMonth = shouldLogIncomeForCurrentMonth(paymentDateObj, frequency, today);
        
        if (!data.peopleIncomeSettings) data.peopleIncomeSettings = {};
        
        if (!data.peopleIncomeSettings[personId]) {
            data.peopleIncomeSettings[personId] = {};
        }
        
        if (shouldLogCurrentMonth && isFirstTimeSetup) {
            const currentMonthYear = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
            
            data.paycheckHistory.push({
                id: nextPaycheckId++,
                personId: personId,
                personName: person.name,
                type: 'salary',
                amount: income,
                date: paymentDate,
                description: employer ? `${frequency} salary - ${employer}` : `${frequency} salary`,
                employer: employer,
                frequency: frequency,
                isAutoLogged: false,
                monthApplied: currentMonthYear
            });
            
            data.eventHistory.push({
                id: nextEventId++,
                date: new Date().toISOString().split('T')[0],
                event: 'Income Settings Added',
                description: `Added income settings for ${person.name}: ${formatCurrency(income)}/${frequency} on ${paymentDate}${employer ? ` at ${employer}` : ''}`
            });
        }
        
        data.peopleIncomeSettings[personId] = {
            ...data.peopleIncomeSettings[personId],
            lastAmount: income,
            lastFrequency: frequency,
            lastPaymentDate: paymentDate,
            nextPaymentDate: getNextPaymentDate(paymentDateObj, frequency).toISOString().split('T')[0],
            currentAmount: income
        };
        
        if (!isFirstTimeSetup) {
            data.eventHistory.push({
                id: nextEventId++,
                date: new Date().toISOString().split('T')[0],
                event: 'Income Settings Updated',
                description: `Updated ${person.name}'s income settings to ${formatCurrency(income)}/${frequency}${employer ? ` at ${employer}` : ''}`
            });
        }
    }
    
    if (oldEmployer !== employer) {
        data.eventHistory.push({
            id: nextEventId++,
            date: new Date().toISOString().split('T')[0],
            event: 'Employer Updated',
            description: `Updated ${person.name}'s employer from "${oldEmployer}" to "${employer}"`
        });
    }
    
    saveDataToLocalStorage();
    updateGreeting();
    updateBillPayerOptions();
    updateHistoryDisplay();
    updateOverview();
    updatePersonOverview(personId);
}

function shouldLogIncomeForCurrentMonth(paymentDate, frequency, today) {
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const payMonth = paymentDate.getMonth();
    const payYear = paymentDate.getFullYear();
    
    if (frequency === 'monthly') {
        return payMonth === currentMonth && payYear === currentYear;
    } else if (frequency === 'quarterly') {
        const monthsDiff = (currentYear - payYear) * 12 + (currentMonth - payMonth);
        return monthsDiff >= 0 && monthsDiff % 3 === 0;
    } else if (frequency === 'yearly') {
        return payMonth === currentMonth && payYear <= currentYear;
    } else if (frequency === 'biweekly') {
        return paymentDate <= today && payMonth === currentMonth && payYear === currentYear;
    }
    
    return false;
}

function updateBiweeklyPaydayChanges(personId, oldDate, newDate, today) {
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    data.eventHistory.push({
        id: nextEventId++,
        date: new Date().toISOString().split('T')[0],
        event: 'Biweekly Payday Changed',
        description: `Changed biweekly payday schedule. Future paydays will be every 14 days starting from ${newDate.toISOString().split('T')[0]}`
    });
    
    if (!data.peopleIncomeSettings[personId]) {
        data.peopleIncomeSettings[personId] = {};
    }
    
    data.peopleIncomeSettings[personId] = {
        ...data.peopleIncomeSettings[personId],
        lastPaymentDate: newDate.toISOString().split('T')[0],
        nextPaymentDate: getNextPaymentDate(newDate, 'biweekly').toISOString().split('T')[0]
    };
}

function updateRegularPaydayChanges(personId, oldDate, newDate, frequency, today) {
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const todayDate = today.getDate();
    
    const oldDay = oldDate.getDate();
    const newDay = newDate.getDate();
    
    const oldPaydayThisMonth = new Date(currentYear, currentMonth, oldDay);
    const newPaydayThisMonth = new Date(currentYear, currentMonth, newDay);
    
    if (oldDay <= todayDate) {
        const existingPaycheck = data.paycheckHistory.find(p => 
            p.personId === personId && 
            p.date === oldPaydayThisMonth.toISOString().split('T')[0] && 
            p.type === 'salary'
        );
        
        if (existingPaycheck) {
            existingPaycheck.date = newPaydayThisMonth.toISOString().split('T')[0];
            existingPaycheck.description += ' (date updated)';
            
            data.eventHistory.push({
                id: nextEventId++,
                date: new Date().toISOString().split('T')[0],
                event: 'Payday Date Updated',
                description: `Updated payday date from ${oldDay}th to ${newDay}th for ${existingPaycheck.personName} in current month`
            });
        }
    }
    
    if (!data.peopleIncomeSettings[personId]) {
        data.peopleIncomeSettings[personId] = {};
    }
    
    data.peopleIncomeSettings[personId] = {
        ...data.peopleIncomeSettings[personId],
        lastPaymentDate: newDate.toISOString().split('T')[0],
        nextPaymentDate: getNextPaymentDate(newDate, frequency).toISOString().split('T')[0]
    };
}

function updateBiweeklyPaydayChanges(personId, oldDate, newDate, today) {
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    const todayDate = today.getDate();
    
    const monthStart = new Date(currentYear, currentMonth, 1);
    const monthEnd = new Date(currentYear, currentMonth + 1, 0);
    
    const oldPaydays = [];
    let checkDate = new Date(oldDate);
    
    while (checkDate.getFullYear() < currentYear || 
           (checkDate.getFullYear() === currentYear && checkDate.getMonth() <= currentMonth)) {
        
        if (checkDate.getMonth() === currentMonth && checkDate.getFullYear() === currentYear) {
            oldPaydays.push(new Date(checkDate));
        }
        
        checkDate.setDate(checkDate.getDate() + 14);
        
        if (checkDate.getFullYear() > currentYear + 1) break;
    }
    
    oldPaydays.sort((a, b) => a.getDate() - b.getDate());
    
    const passedPaydays = oldPaydays.filter(date => date.getDate() <= todayDate);
    
    if (passedPaydays.length > 0) {
        const latestPassedPayday = passedPaydays[passedPaydays.length - 1];
        
        const existingPaycheck = data.paycheckHistory.find(p => 
            p.personId === personId && 
            p.date === latestPassedPayday.toISOString().split('T')[0] && 
            p.type === 'salary'
        );
        
        if (existingPaycheck) {
            const daysDifference = latestPassedPayday.getDate() - oldDate.getDate();
            const biweeklyPeriods = Math.floor(daysDifference / 14);
            
            const newPaydayDate = new Date(newDate);
            newPaydayDate.setDate(newDate.getDate() + (biweeklyPeriods * 14));
            
            if (newPaydayDate.getMonth() === currentMonth && newPaydayDate.getFullYear() === currentYear) {
                existingPaycheck.date = newPaydayDate.toISOString().split('T')[0];
                existingPaycheck.description += ' (date updated)';
                
                data.eventHistory.push({
                    id: nextEventId++,
                    date: new Date().toISOString().split('T')[0],
                    event: 'Biweekly Payday Date Updated',
                    description: `Updated biweekly payday from ${latestPassedPayday.getDate()}th to ${newPaydayDate.getDate()}th for ${existingPaycheck.personName}`
                });
            }
        }
    }
    
    if (!data.peopleIncomeSettings[personId]) {
        data.peopleIncomeSettings[personId] = {};
    }
    
    data.peopleIncomeSettings[personId] = {
        ...data.peopleIncomeSettings[personId],
        lastPaymentDate: newDate.toISOString().split('T')[0],
        nextPaymentDate: getNextPaymentDate(newDate, 'biweekly').toISOString().split('T')[0]
    };
}

function updatePaycheckDate(personId, oldDate, newDate) {
    const paycheck = data.paycheckHistory.find(p => 
        p.personId === personId && 
        p.date === oldDate && 
        p.type === 'salary'
    );
    
    if (paycheck) {
        paycheck.date = newDate;
        paycheck.description += ' (date updated)';
        
        data.eventHistory.push({
            id: nextEventId++,
            date: new Date().toISOString().split('T')[0],
            event: 'Payday Date Updated',
            description: `Updated payday date from ${oldDate} to ${newDate} for ${paycheck.personName}`
        });
    }
}

function getNextPaymentDate(currentDate, frequency) {
    const nextDate = new Date(currentDate);
    
    switch (frequency) {
        case 'biweekly':
            nextDate.setDate(currentDate.getDate() + 14);
            break;
        case 'monthly':
            nextDate.setMonth(currentDate.getMonth() + 1);
            break;
        case 'quarterly':
            nextDate.setMonth(currentDate.getMonth() + 3);
            break;
        case 'yearly':
            nextDate.setFullYear(currentDate.getFullYear() + 1);
            break;
    }
    
    return nextDate;
}

function updatePersonSavingsExpenses(personId) {
    const person = data.people.find(p => p.id === personId);
    if (!person) return;
    
    const oldSavings = person.savings || 0;
    const oldExpenses = person.expenses || 0;
    
    const savings = parseFloat($(`savings-${personId}`).value) || 0;
    const expenses = parseFloat($(`expenses-${personId}`).value) || 0;
    
    const today = new Date().toISOString().split('T')[0];
    const currentMonthYear = new Date().toISOString().substring(0, 7);
    
    if (oldSavings !== savings) {
        person.savings = savings;
        
        data.eventHistory.push({
            id: nextEventId++,
            date: today,
            event: 'Savings Goal Changed',
            description: `${person.name}'s monthly savings goal changed from ${formatCurrency(oldSavings)} to ${formatCurrency(savings)} effective ${today}`
        });
        
        if (!person.savingsHistory) person.savingsHistory = [];
        person.savingsHistory.push({
            date: today,
            previousAmount: oldSavings,
            newAmount: savings,
            effectiveMonth: currentMonthYear
        });
    }
    
    if (oldExpenses !== expenses) {
        person.expenses = expenses;
        
        data.eventHistory.push({
            id: nextEventId++,
            date: today,
            event: 'Expenses Goal Changed',
            description: `${person.name}'s monthly expenses goal changed from ${formatCurrency(oldExpenses)} to ${formatCurrency(expenses)} effective ${today}`
        });
        
        if (!person.expensesHistory) person.expensesHistory = [];
        person.expensesHistory.push({
            date: today,
            previousAmount: oldExpenses,
            newAmount: expenses,
            effectiveMonth: currentMonthYear
        });
    }
    
    if (oldSavings !== savings || oldExpenses !== expenses) {
        data.eventHistory.push({
            id: nextEventId++,
            date: today,
            event: 'Budget Goals Updated',
            description: `Updated ${person.name}'s monthly budget goals: Savings ${formatCurrency(savings)}, Expenses ${formatCurrency(expenses)}`
        });
    }
    
    saveDataToLocalStorage();
    updateOverview();
    updatePersonOverview(personId);
}

function deletePerson(personId) {
    if (!confirm(`Are you sure you want to delete this person and their associated data? This cannot be undone.`)) return;
    
    const person = data.people.find(p => p.id === personId);
    if (!person) return;
    
    if (data.bills.some(b => b.payer === person.id)) {
        alert('Cannot delete person with associated bills. Please reassign or delete their bills first.');
        return;
    }
    
    data.people = data.people.filter(p => p.id !== personId);
    data.paycheckHistory = data.paycheckHistory.filter(p => p.personId !== personId);
    
    data.eventHistory.push({
        id: nextEventId++,
        date: new Date().toISOString().split('T')[0],
        event: 'Person Deleted',
        description: `Deleted ${person.name} from budget tracker`
    });
    
    saveDataToLocalStorage();
    
    const tab = document.querySelector(`button.tab[data-person-id="${personId}"]`);
    if (tab) tab.remove();
    
    const content = $(`person-${personId}`);
    if (content) content.remove();
    
    updateGreeting();
    updateBillPayerOptions();
    updateHistoryDisplay();
    updateOverview();
    toggleBillTypeVisibility();
    updateTabsVisibility();
    
    showTab('overview');
}

function addPaycheck(personId) {
    const person = data.people.find(p => p.id === personId);
    if (!person) return;
    
    const amount = parseFloat($(`paycheckAmount-${personId}`).value) || 0;
    const date = $(`paycheckDate-${personId}`).value;
    const employer = $(`paycheckEmployer-${personId}`).value.trim();
    
    if (!amount || !date) {
        alert('Please provide amount and date');
        return;
    }
    
    const selectedDate = new Date(date);
    const today = new Date();
    const currentMonthStart = new Date(today.getFullYear(), today.getMonth(), 1);
    const currentMonthEnd = new Date(today.getFullYear(), today.getMonth() + 1, 0);
    
    if (selectedDate > currentMonthEnd) {
        alert('Cannot add income for future months. You can only add income for past dates or the current month.');
        return;
    }
    
    const paymentDate = new Date(date);
    const monthApplied = `${paymentDate.getFullYear()}-${String(paymentDate.getMonth() + 1).padStart(2, '0')}`;
    
    const existingEntries = data.paycheckHistory.filter(p => 
        p.personId === personId && 
        p.date === date && 
        p.type === 'salary'
    );
    
    const paycheck = {
        id: nextPaycheckId++,
        personId: personId,
        personName: person.name,
        type: 'salary',
        amount: amount,
        date: date,
        description: employer ? `Additional salary entry - ${employer}` : 'Additional salary entry',
        employer: employer,
        frequency: 'manual',
        isAutoLogged: false,
        monthApplied: monthApplied,
        isHistorical: selectedDate < currentMonthStart,
        isAdditional: existingEntries.length > 0
    };
    
    data.paycheckHistory.push(paycheck);
    
    const entryType = selectedDate < currentMonthStart ? 'historical' : 'current month';
    const additionalText = existingEntries.length > 0 ? 'additional ' : '';
    
    data.eventHistory.push({
        id: nextEventId++,
        date: new Date().toISOString().split('T')[0],
        event: selectedDate < currentMonthStart ? 'Additional Historical Salary Added' : 'Additional Manual Salary Added',
        description: `Added ${formatCurrency(amount)} ${additionalText}${entryType} salary for ${person.name} on ${date}${employer ? ` from ${employer}` : ''}${existingEntries.length > 0 ? ` (in addition to existing entries)` : ''}`
    });
    
    $(`paycheckAmount-${personId}`).value = '';
    $(`paycheckDate-${personId}`).value = '';
    $(`paycheckEmployer-${personId}`).value = '';
    
    saveDataToLocalStorage();
    updateHistoryDisplay();
    updateOverview();
    updatePersonOverview(personId);
}

function addBonus(personId) {
   const person = data.people.find(p => p.id === personId);
   if (!person) return;
   
   const amount = parseFloat($(`bonusAmount-${personId}`).value) || 0;
   const date = $(`bonusDate-${personId}`).value;
   const employer = $(`bonusEmployer-${personId}`).value.trim();
   
   if (!amount || !date) {
       alert('Please provide amount and date');
       return;
   }
   
   const bonusDate = new Date(date);
   const today = new Date();
   const monthApplied = `${bonusDate.getFullYear()}-${String(bonusDate.getMonth() + 1).padStart(2, '0')}`;
   
   const bonus = {
       id: nextPaycheckId++,
       personId: personId,
       personName: person.name,
       type: 'bonus',
       amount: amount,
       date: date,
       description: employer ? `One-time bonus - ${employer}` : 'One-time bonus',
       employer: employer,
       isAutoLogged: false,
       monthApplied: monthApplied,
       isOneTime: true,
       isHistorical: bonusDate < new Date(today.getFullYear(), today.getMonth(), 1)
   };
   
   data.paycheckHistory.push(bonus);
   
   data.eventHistory.push({
       id: nextEventId++,
       date: new Date().toISOString().split('T')[0],
       event: bonus.isHistorical ? 'Historical Bonus Added' : 'Bonus Added',
       description: `Added ${formatCurrency(amount)} bonus for ${person.name} on ${date}${employer ? ` from ${employer}` : ''} (applied to ${monthApplied})`
   });
   
   $(`bonusAmount-${personId}`).value = '';
   $(`bonusDate-${personId}`).value = '';
   $(`bonusEmployer-${personId}`).value = '';
   
   saveDataToLocalStorage();
   updateHistoryDisplay();
   updateOverview();
   updatePersonOverview(personId);
}

function deletePaycheck(paycheckId, personId) {
    if (!confirm('Are you sure you want to delete this paycheck? This cannot be undone.')) return;
    
    const paycheck = data.paycheckHistory.find(p => p.id === paycheckId);
    if (!paycheck) return;
    
    data.paycheckHistory = data.paycheckHistory.filter(p => p.id !== paycheckId);
    
    data.eventHistory.push({
        id: nextEventId++,
        date: new Date().toISOString().split('T')[0],
        event: 'Paycheck Deleted',
        description: `Deleted ${formatCurrency(paycheck.amount)} ${paycheck.type} for ${paycheck.personName} on ${paycheck.date}`
    });
    
    saveDataToLocalStorage();
    updatePersonOverview(personId);
    updateHistoryDisplay();
    updateOverview();
}

function updatePersonOverview(personId) {
    const person = data.people.find(p => p.id === personId);
    if (!person) return;
    
    const personTab = $(`person-${personId}`);
    if (personTab) {
        const yearlyIncomeView = personTab.querySelector('.historical-income-container');
        if (yearlyIncomeView) {
            const newView = createYearlyIncomeView(personId);
            const tempDiv = document.createElement('div');
            tempDiv.innerHTML = newView;
            const newElement = tempDiv.firstChild;
            yearlyIncomeView.parentNode.replaceChild(newElement, yearlyIncomeView);
        }
    }
}

function updateHistoryDisplay() {
    const incomeHistoryList = $('incomeHistoryList');
    const billHistoryList = $('billHistoryList');
    const eventHistoryList = $('eventHistoryList');
    const personFilterContainer = $('historyPersonFilter');
    const startDate = $('historyStartDate').value;
    const endDate = $('historyEndDate').value;
    
    let selectedPersonId = personFilterContainer.tagName === 'SELECT' ? 
        (personFilterContainer.value === 'all' ? 'all' : parseInt(personFilterContainer.value)) : 
        (data.people.length === 1 ? data.people[0].id : 'all');
    
    if (data.people.length === 1) {
        personFilterContainer.outerHTML = `<span id="historyPersonFilter">${data.people[0].name}</span>`;
        selectedPersonId = data.people[0].id;
    } else {
        const currentValue = personFilterContainer.tagName === 'SELECT' ? personFilterContainer.value : 'all';
        personFilterContainer.outerHTML = `<select id="historyPersonFilter"><option value="all">All People</option>${data.people.map(p => `<option value="${p.id}" ${p.id == currentValue ? 'selected' : ''}>${p.name}</option>`).join('')}</select>`;
        const newPersonFilter = $('historyPersonFilter');
        newPersonFilter.value = currentValue;
        newPersonFilter.addEventListener('change', updateHistoryDisplay);
    }
    
    let filteredPaychecks = data.paycheckHistory || [];
    if (selectedPersonId !== 'all') {
        filteredPaychecks = filteredPaychecks.filter(p => p.personId === selectedPersonId);
    }
    if (startDate) {
        filteredPaychecks = filteredPaychecks.filter(p => p.date >= startDate);
    }
    if (endDate) {
        filteredPaychecks = filteredPaychecks.filter(p => p.date <= endDate);
    }
    
    const sortedPaychecks = filteredPaychecks.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    incomeHistoryList.innerHTML = sortedPaychecks.length > 0 ? sortedPaychecks.map(p => {
        const typeDisplay = p.type === 'bonus' ? 'Bonus' : 'Salary';
        const description = p.isOneTime ? p.description : p.description;
        return `
            <tr>
                <td>${p.date}</td>
                <td>${p.personName}</td>
                <td>${typeDisplay}</td>
                <td>${formatCurrency(p.amount)}</td>
                <td>${description}</td>
                <td><button class="btn-danger btn-small" onclick="deletePaycheck(${p.id},${p.personId})">Delete</button></td>
            </tr>
        `;
    }).join('') : '<tr><td colspan="6">No income data for selected person.</td></tr>';
    
    let filteredBillHistory = data.billPayments || [];
    if (selectedPersonId !== 'all') {
        filteredBillHistory = filteredBillHistory.filter(p => 
            p.payer === selectedPersonId || 
            (p.payer === 'joint' && data.people.find(person => person.id === selectedPersonId))
        );
    }
    if (startDate) {
        filteredBillHistory = filteredBillHistory.filter(p => p.date >= startDate);
    }
    if (endDate) {
        filteredBillHistory = filteredBillHistory.filter(p => p.date <= endDate);
    }
    
    const sortedBillHistory = filteredBillHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    billHistoryList.innerHTML = sortedBillHistory.length > 0 ? sortedBillHistory.map(p => `
        <tr>
            <td>${p.date}</td>
            <td>${p.billName}</td>
            <td>${formatCurrency(p.amount)}</td>
            <td>${p.category}</td>
            <td>${p.billType}</td>
            <td>${p.status}</td>
        </tr>
    `).join('') : '<tr><td colspan="6">No bill payments for selected person.</td></tr>';
    
    let filteredEvents = data.eventHistory || [];
    if (selectedPersonId !== 'all') {
        const person = data.people.find(p => p.id === selectedPersonId);
        if (person) {
            filteredEvents = filteredEvents.filter(e => 
                e.description.includes(person.name) || 
                e.event.includes('Bill') ||
                e.event.includes('Savings') ||
                e.event.includes('Expenses') ||
                e.event.includes('Budget')
            );
        }
    }
    if (startDate) {
        filteredEvents = filteredEvents.filter(e => e.date >= startDate);
    }
    if (endDate) {
        filteredEvents = filteredEvents.filter(e => e.date <= endDate);
    }
    
    const sortedEvents = filteredEvents.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    eventHistoryList.innerHTML = sortedEvents.length > 0 ? sortedEvents.map(e => `
        <tr>
            <td>${e.date}</td>
            <td>${e.event}</td>
            <td>${e.description}</td>
            <td><button class="btn-danger btn-small" onclick="deleteEvent(${e.id})">Delete</button></td>
        </tr>
    `).join('') : '<tr><td colspan="4">No events for selected person.</td></tr>';
}

function deleteEvent(eventId) {
    if (!confirm('Are you sure you want to delete this event? This cannot be undone.')) return;
    
    const event = data.eventHistory.find(e => e.id === eventId);
    if (!event) return;
    
    data.eventHistory = data.eventHistory.filter(e => e.id !== eventId);
    saveDataToLocalStorage();
    updateHistoryDisplay();
}

function clearHistoryFilters() {
    $('historyPersonFilter').value = 'all';
    $('historyStartDate').value = '';
    $('historyEndDate').value = '';
    updateHistoryDisplay();
}

function showTab(tabId) {
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.remove('active');
    });
    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.classList.remove('active');
        if (tab.dataset.personId) {
            tab.style.backgroundColor = '';
            tab.style.color = '';
        }
    });
    
    const content = $(tabId);
    if (content) {
        content.classList.add('active');
    }
    
    const activeTab = document.querySelector(`.tab[data-tab="${tabId}"],.tab[data-person-id="${tabId.replace('person-', '')}"]`);
    if (activeTab) {
        activeTab.classList.add('active');
        if (activeTab.dataset.personId) {
            const personId = parseInt(activeTab.dataset.personId);
            const person = data.people.find(p => p.id === personId);
            if (person && person.color) {
                activeTab.style.backgroundColor = person.color;
                activeTab.style.color = '#ffffff';
            }
        }
    }
    
    if (tabId === 'overview') {
        resetCalendarToCurrentMonth();
    }
}

function resetCalendarToCurrentMonth() {
    const today = new Date();
    currentViewMonth = today.getMonth();
    currentViewYear = today.getFullYear();
    updateCalendarView();
}


function initCalendarInteractions() {
    const calendarDays = document.querySelectorAll('.calendar-day');
    const calendarOverlay = document.getElementById('calendarOverlay');
    
    calendarDays.forEach(day => {
        day.addEventListener('click', function(event) {
            if (this.classList.contains('expanded') || event.target.classList.contains('day-close-btn')) {
                this.classList.remove('expanded');
                calendarOverlay.style.display = 'none';
                return;
            }
            
            calendarDays.forEach(d => d.classList.remove('expanded'));
            
            const dayIndex = Array.from(this.parentNode.children).indexOf(this) - 7;
            const dayOfWeek = dayIndex % 7;
            
            if (dayOfWeek >= 4) {
                this.style.right = '0';
                this.style.left = 'auto';
            } else {
                this.style.left = '0';
                this.style.right = 'auto';
            }
            
            this.classList.add('expanded');
            calendarOverlay.style.display = 'block';
        });
    });
    
    calendarOverlay.addEventListener('click', function() {
        const expandedDay = document.querySelector('.calendar-day.expanded');
        if (expandedDay) {
            expandedDay.classList.remove('expanded');
        }
        this.style.display = 'none';
    });
    
    const prevMonthBtn = document.getElementById('prevMonthBtn');
    const nextMonthBtn = document.getElementById('nextMonthBtn');
    
    if (prevMonthBtn) {
        prevMonthBtn.addEventListener('click', function(e) {
            e.preventDefault();
            navigateCalendar(-1);
        });
    }
    
    if (nextMonthBtn) {
        nextMonthBtn.addEventListener('click', function(e) {
            e.preventDefault();
            navigateCalendar(1);
        });
    }
}

function fullReset() {
    if (!confirm('Are you sure you want to reset all data? This cannot be undone.')) return;
    
    data = {
        people: [],
        bills: [],
        currency: "USD",
        darkMode: document.body.classList.contains('dark-mode'),
        weightedBills: false,
        nextPersonId: 1,
        nextBillId: 1,
        nextIncomeId: 1,
        nextEventId: 1,
        nextPaycheckId: 1,
        paycheckHistory: [],
        billHistory: [],
        eventHistory: [],
        billPayments: [],
        lastProcessedDate: null,
        peopleIncomeSettings: {},
        savedFileHandle: null
    };
    
    nextPersonId = 1;
    nextBillId = 1;
    nextIncomeId = 1;
    nextEventId = 1;
    nextPaycheckId = 1;
    savedFileHandle = null;
    
    saveDataToLocalStorage();
    
    document.querySelectorAll('.tab[data-person-id]').forEach(tab => tab.remove());
    document.querySelectorAll('.tab-content[id^="person-"]').forEach(content => content.remove());
    
    updateGreeting();
    updateBillPayerOptions();
    updateBillsList();
    updateHistoryDisplay();
    updateOverview();
    toggleBillTypeVisibility();
    showTab('overview');
}

function updatePersonColor(personId, colorValue) {
    const person = data.people.find(p => p.id === personId);
    if (person) {
        const otherPersonWithSameColor = data.people.find(p => p.id !== personId && p.color === colorValue);
        if (otherPersonWithSameColor) {
            alert(`${otherPersonWithSameColor.name} is already using this colour. Please choose a different one.`);
            return;
        }
        
        person.color = colorValue;
        saveDataToLocalStorage();
        updateOverview();
        
        const personTab = document.querySelector(`button.tab[data-person-id="${personId}"]`);
        if (personTab) {
            if (personTab.classList.contains('active')) {
                personTab.style.backgroundColor = colorValue;
                personTab.style.color = '#ffffff';
            } else {
                personTab.style.backgroundColor = '';
                personTab.style.color = '';
            }
        }
        
        const changeColorBtn = document.querySelector(`#person-${personId} .card:nth-child(1) button[onclick*="showColorModal"]`);
        if (changeColorBtn) {
            changeColorBtn.style.backgroundColor = colorValue;
            changeColorBtn.style.color = '#ffffff';
        }
        
        hideColorModal();
    }
}

function getContrastColor(hexColor) {
    const r = parseInt(hexColor.substr(1, 2), 16);
    const g = parseInt(hexColor.substr(3, 2), 16);
    const b = parseInt(hexColor.substr(5, 2), 16);
    const brightness = (r * 299 + g * 587 + b * 114) / 1000;
    return brightness > 128 ? '#000000' : '#ffffff';
}

function showColorModal(personId) {
    let modal = document.getElementById('colorModal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'colorModal';
        modal.className = 'color-modal';
        document.body.appendChild(modal);
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                hideColorModal();
            }
        });
    }
    
    const person = data.people.find(p => p.id === personId);
    const currentColor = person ? person.color : colorPalette[0].value;
    const usedColors = data.people.filter(p => p.id !== personId).map(p => p.color);
    
    const colorOptions = colorPalette.map(color => {
        const isUsed = usedColors.includes(color.value);
        const isCurrentColor = currentColor === color.value;
        const disabledStyle = isUsed && !isCurrentColor ? 'opacity:0.3;cursor:not-allowed;' : '';
        const onClick = isUsed && !isCurrentColor ? '' : `onclick="updatePersonColor(${personId}, '${color.value}')"`;
        
        return `<div class="color-option-item" style="${disabledStyle}" ${onClick}>
            <span class="color-swatch" style="background-color: ${color.value}"></span>
            <span>${color.name}${isUsed && !isCurrentColor ? ' (Used)' : ''}</span>
        </div>`;
    }).join('');
    
    const modalStyle = document.body.classList.contains('dark-mode') ? 
        'background-color: #000000; color: #ffffff; border-color: #ffffff;' : 
        'background-color: #ffffff; color: #000000; border-color: #000000;';
    
    modal.innerHTML = `
        <div class="color-modal-content" style="${modalStyle}">
            <h3 style="margin-bottom:20px;color:${document.body.classList.contains('dark-mode') ? '#fff' : '#000'};">Choose User Colour</h3>
            ${colorOptions}
            <div style="margin-top:20px;text-align:right;">
                <button onclick="hideColorModal()" style="background:#666;">Cancel</button>
            </div>
        </div>
    `;
    
    modal.style.display = 'flex';
}

function hideColorModal() {
    const modal = document.getElementById('colorModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function toggleSidebar() {
    $('sidebar').classList.toggle('open');
}

function markAsChanged() {
    const currentDataString = JSON.stringify(data);
    const originalDataString = JSON.stringify(originalEmbeddedData);
    hasChanges = currentDataString !== originalDataString;
}

function clearChanges() {
    hasChanges = false;
    localStorage.removeItem(STORAGE_KEY);
    originalEmbeddedData = JSON.parse(JSON.stringify(data));
}

function loadData() {
    try {
        localStorage.removeItem(STORAGE_KEY);
        const embeddedScript = $('embedded-data');
        data = JSON.parse(embeddedScript.textContent);
        originalEmbeddedData = JSON.parse(JSON.stringify(data));
        sessionStartData = JSON.parse(JSON.stringify(data));
        nextPersonId = data.nextPersonId || 1;
        nextBillId = data.nextBillId || 1;
        nextIncomeId = data.nextIncomeId || 1;
        nextEventId = data.nextEventId || 1;
        nextPaycheckId = data.nextPaycheckId || 1;
        savedFileHandle = data.savedFileHandle || null;
        
        if (data.darkMode) document.body.classList.add('dark-mode');
        $('currencySelect').value = data.currency || 'USD';
        $('weightedBillsSidebar').checked = data.weightedBills || false;
        
        showTab('overview');
        const sidebar = $('sidebar');
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
        }
        
        attachPersonEventListeners();
        
        clearChanges();
        processElapsedBills();
        processElapsedIncome();
    } catch (e) {
        console.error('Failed to load embedded data:', e);
        data = {
            people: [],
            bills: [],
            currency: "USD",
            darkMode: false,
            weightedBills: false,
            nextPersonId: 1,
            nextBillId: 1,
            nextIncomeId: 1,
            nextEventId: 1,
            nextPaycheckId: 1,
            paycheckHistory: [],
            billHistory: [],
            eventHistory: [],
            billPayments: [],
            lastProcessedDate: null,
            peopleIncomeSettings: {},
            savedFileHandle: null
        };
        originalEmbeddedData = JSON.parse(JSON.stringify(data));
        sessionStartData = JSON.parse(JSON.stringify(data));
        
        showTab('overview');
        const sidebar = $('sidebar');
        if (sidebar.classList.contains('open')) {
            sidebar.classList.remove('open');
        }
        
        clearChanges();
    }
}

function saveDataToLocalStorage() {
    try {
        data.nextPersonId = nextPersonId;
        data.nextBillId = nextBillId;
        data.nextIncomeId = nextIncomeId;
        data.nextEventId = nextEventId;
        data.nextPaycheckId = nextPaycheckId;
        data.savedFileHandle = savedFileHandle;
        localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        markAsChanged();
    } catch (e) {
        console.error('Failed to save to session storage:', e);
    }
}

async function saveDataToFile() {
    try {
        data.nextPersonId = nextPersonId;
        data.nextBillId = nextBillId;
        data.nextIncomeId = nextIncomeId;
        data.nextEventId = nextEventId;
        data.nextPaycheckId = nextPaycheckId;
        data.savedFileHandle = savedFileHandle;
        
        const embeddedScript = $('embedded-data');
        embeddedScript.textContent = JSON.stringify(data, null, 8);
        const htmlContent = document.documentElement.outerHTML;
        
        if ('showSaveFilePicker' in window) {
            if (savedFileHandle) {
                try {
                    const writable = await savedFileHandle.createWritable();
                    await writable.write(htmlContent);
                    await writable.close();
                    alert('File saved successfully!');
                    clearChanges();
                    return;
                } catch (err) {
                    if (err.name === 'NotAllowedError') {
                        savedFileHandle = null;
                        data.savedFileHandle = null;
                    }
                }
            }
            
            try {
                const currentPath = window.location.pathname;
                const fileName = currentPath.split('/').pop() || 'BUDGET.html';
                const fileHandle = await window.showSaveFilePicker({
                    suggestedName: fileName,
                    types: [{
                        description: 'HTML files',
                        accept: { 'text/html': ['.html'] }
                    }]
                });
                
                const writable = await fileHandle.createWritable();
                await writable.write(htmlContent);
                await writable.close();
                savedFileHandle = fileHandle;
                data.savedFileHandle = fileHandle;
                alert('File saved successfully!');
            } catch (err) {
                if (err.name !== 'AbortError') {
                    throw err;
                }
                return;
            }
        } else {
            const blob = new Blob([htmlContent], { type: 'text/html' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'BUDGET.html';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            alert('File downloaded successfully! Please save it over your original file.');
        }
        clearChanges();
    } catch (e) {
        console.error('Failed to save file:', e);
        alert('Failed to save file. Please try again.');
    }
}

function processElapsedBills() {
    const today = new Date();
    let billsUpdated = false;

    data.bills.forEach(bill => {
        if (bill.isDebt && bill.totalDebt <= 0.01) {
            return;
        }

        const dueDate = new Date(bill.dueDate);
        let nextDueDate = new Date(dueDate);
        const frequencyMs = getFrequencyMs(bill.frequency);

        while (nextDueDate <= today) {
            const paymentExists = data.billPayments.some(payment => 
                payment.billId === bill.id && 
                Math.abs(new Date(payment.date) - nextDueDate) < 1000 * 60 * 60 * 24
            );

            if (!paymentExists) {
                const paymentAmount = bill.amount + (bill.overpayment || 0);
                
                if (bill.isDebt) {
                    const monthlyRate = (bill.interestRate || 0) / 100 / 12;
                    const interest = bill.totalDebt * monthlyRate;
                    const principal = Math.min(paymentAmount - interest, bill.totalDebt);
                    
                    bill.totalDebt = Math.max(0, bill.totalDebt - principal);
                    billsUpdated = true;

                    data.billPayments.push({
                        billId: bill.id,
                        amount: paymentAmount,
                        date: nextDueDate.toISOString().split('T')[0],
                        category: bill.category
                    });

                    if (bill.totalDebt <= 0.01) {
                        break;
                    }
                } else {
                    data.billPayments.push({
                        billId: bill.id,
                        amount: paymentAmount,
                        date: nextDueDate.toISOString().split('T')[0],
                        category: bill.category
                    });
                    billsUpdated = true;
                }
            }

            if (bill.frequency === 'once') {
                break;
            } else {
                nextDueDate.setTime(nextDueDate.getTime() + frequencyMs);
            }
        }

        if (bill.frequency !== 'once' && nextDueDate > today) {
            bill.dueDate = nextDueDate.toISOString().split('T')[0];
            billsUpdated = true;
        }
    });

    data.bills = data.bills.filter(bill => !(bill.isDebt && bill.totalDebt <= 0.01));
    
    if (billsUpdated) {
        saveDataToLocalStorage();
        updateBillsList();
        updateOverview();
    }
}

function getFrequencyMs(frequency) {
    switch (frequency) {
        case 'daily': return 1000 * 60 * 60 * 24;
        case 'biweekly': return 1000 * 60 * 60 * 24 * 14;
        case 'monthly': return 1000 * 60 * 60 * 24 * 30;
        case 'quarterly': return 1000 * 60 * 60 * 24 * 90;
        case 'yearly': return 1000 * 60 * 60 * 24 * 365;
        default: return 0;
    }
}

function processElapsedIncome() {
    const today = new Date();
    const lastProcessed = data.lastProcessedDate ? new Date(data.lastProcessedDate) : null;
    
    if (!data.peopleIncomeSettings) data.peopleIncomeSettings = {};
    
    data.people.forEach(person => {
        if (!person.paymentDate || !person.income || !person.frequency) return;
        
        if (!data.peopleIncomeSettings[person.id]) {
            return;
        }
        
        const settings = data.peopleIncomeSettings[person.id];
        if (!settings.nextPaymentDate) return;
        
        let nextPayDate = new Date(settings.nextPaymentDate);
        
        while (nextPayDate <= today) {
            if (!lastProcessed || nextPayDate > lastProcessed) {
                const currentAmount = settings.currentAmount || person.income;
                const currentMonthYear = `${nextPayDate.getFullYear()}-${String(nextPayDate.getMonth() + 1).padStart(2, '0')}`;
                
                data.paycheckHistory.push({
                    id: nextPaycheckId++,
                    personId: person.id,
                    personName: person.name,
                    type: 'salary',
                    amount: currentAmount,
                    date: nextPayDate.toISOString().split('T')[0],
                    description: `Auto-logged ${person.frequency} salary${person.employer ? ` - ${person.employer}` : ''}`,
                    employer: person.employer,
                    frequency: person.frequency,
                    isAutoLogged: true,
                    monthApplied: currentMonthYear
                });
                
                data.eventHistory.push({
                    id: nextEventId++,
                    date: new Date().toISOString().split('T')[0],
                    event: 'Salary Auto-Logged',
                    description: `Auto-logged ${person.frequency} salary of ${formatCurrency(currentAmount)} for ${person.name} on ${nextPayDate.toISOString().split('T')[0]}`
                });
            }
            
            nextPayDate = getNextPaymentDate(nextPayDate, person.frequency);
        }
        
        settings.nextPaymentDate = nextPayDate.toISOString().split('T')[0];
        
        if (person.income !== settings.currentAmount) {
            const nextPayDateObj = new Date(settings.nextPaymentDate);
            if (today < nextPayDateObj) {
                settings.currentAmount = person.income;
            }
        }
    });
    
    data.lastProcessedDate = today.toISOString().split('T')[0];
    saveDataToLocalStorage();
}

function updateGreeting() {
    const names = data.people.map(p => p.name).join(' & ');
    $('greeting').textContent = names ? `Hello, ${names}!` : 'Hello, Welcome!';
}

function toggleDarkMode() {
    document.body.classList.toggle('dark-mode');
    data.darkMode = document.body.classList.contains('dark-mode');
    saveDataToLocalStorage();
}

function updateCurrency() {
    const oldCurrency = data.currency;
    const newCurrency = $('currencySelect').value;
    
    if (oldCurrency === newCurrency) return;
    
    data.currency = newCurrency;
    
    data.eventHistory.push({
        id: nextEventId++,
        date: new Date().toISOString().split('T')[0],
        event: 'Currency Changed',
        description: `Changed currency from ${oldCurrency} to ${newCurrency}. All amounts will now display in ${newCurrency}.`
    });
    
    saveDataToLocalStorage();
    updateOverview();
    updateHistoryDisplay();
    updateBillsList();
    data.people.forEach(p => updatePersonOverview(p.id));
    updateCalendarView();
}

function formatCurrency(amount) {
    const currencySymbols = {
        'USD': '$',
        'EUR': '€',
        'GBP': '£',
        'JPY': '¥',
        'CAD': '$'
    };
    
    const symbol = currencySymbols[data.currency] || '$';
    const formattedAmount = new Intl.NumberFormat('en-US', {
        minimumFractionDigits: data.currency === 'JPY' ? 0 : 2,
        maximumFractionDigits: data.currency === 'JPY' ? 0 : 2
    }).format(amount);
    
    return `${symbol}${formattedAmount}`;
}

function updateWeightedBills() {
    data.weightedBills = $('weightedBillsSidebar').checked;
    saveDataToLocalStorage();
    updateOverview();
}

function addPersonIncome(personId, incomeAmount, paymentDate, frequency, employer, isHistorical = false) {
    const person = data.people.find(p => p.id === personId);
    if (!person) return;
    
    const payDate = new Date(paymentDate);
    const currentMonthYear = `${payDate.getFullYear()}-${String(payDate.getMonth() + 1).padStart(2, '0')}`;
    
    const paycheck = {
        id: nextPaycheckId++,
        personId: personId,
        personName: person.name,
        type: 'salary',
        amount: incomeAmount,
        date: paymentDate,
        description: employer ? `${frequency} salary - ${employer}` : `${frequency} salary`,
        employer: employer,
        frequency: frequency,
        isAutoLogged: false,
        monthApplied: currentMonthYear,
        dateCreated: new Date().toISOString().split('T')[0],
        isHistorical: isHistorical
    };
    
    data.paycheckHistory.push(paycheck);
    return paycheck;
}

function updateTabsVisibility() {
    const addPersonTab = $('addPersonTab');
    if (!addPersonTab) return;
    
    if (data.people.length === 0) {
        addPersonTab.style.display = 'block';
    } else {
        addPersonTab.style.display = 'none';
    }
}

function addNewPerson() {
    const name = prompt('Enter User Name Below\nAdd more users using the sidemenu ☰');
    if (!name || !name.trim()) return;
    
    const trimmedName = name.trim();
    if (data.people.some(p => p.name.toLowerCase() === trimmedName.toLowerCase())) {
        alert('A person with this name already exists!');
        return;
    }
    
    const newPerson = {
        id: nextPersonId++,
        name: trimmedName,
        income: 0,
        frequency: 'monthly',
        paymentDate: '',
        savings: 0,
        expenses: 0,
        employer: '',
        color: colorPalette[data.people.length % colorPalette.length].value
    };
    
    data.people.push(newPerson);
    data.eventHistory.push({
        id: nextEventId++,
        date: new Date().toISOString().split('T')[0],
        event: 'Person Added',
        description: `Added ${trimmedName} to budget tracker`
    });
    
    saveDataToLocalStorage();
    createPersonTab(newPerson);
    attachPersonEventListeners();
    updateGreeting();
    updateBillPayerOptions();
    updateHistoryDisplay();
    updateOverview();
    toggleBillTypeVisibility();
    updateTabsVisibility();
    
    const sidebar = $('sidebar');
    if (sidebar.classList.contains('open')) {
        sidebar.classList.remove('open');
    }
    
    showTab(`person-${newPerson.id}`);
}

function calculateJointBillTransfers() {
    const transfers = [];
    const jointBills = data.bills.filter(b => b.billType === 'joint' && b.payer !== 'joint' && !b.isDeleted);
    const jointAccountBills = data.bills.filter(b => b.billType === 'joint' && b.payer === 'joint' && !b.isDeleted);
    const consolidatedTransfers = {};
    const personToPersonDebts = {};
    
    jointBills.forEach(bill => {
        let monthlyAmount;
        if (bill.isOneOff) {
            const billDate = new Date(bill.date);
            const today = new Date();
            if (billDate.getMonth() === today.getMonth() && billDate.getFullYear() === today.getFullYear()) {
                monthlyAmount = bill.amount + (bill.overpayment || 0);
            } else {
                return;
            }
        } else {
            monthlyAmount = frequencyToMonthly(bill.amount + (bill.overpayment || 0), bill.frequency);
        }
        
        const payerId = parseInt(bill.payer);
        const payer = data.people.find(p => p.id === payerId);
        if (!payer) return;
        
        data.people.forEach(person => {
            if (person.id !== payerId) {
                const personShare = calculateWeightedShare(monthlyAmount, person.id, data.weightedBills);
                
                if (personShare > 0) {
                    const debtKey = `${person.id}-owes-${payerId}`;
                    if (!personToPersonDebts[debtKey]) {
                        personToPersonDebts[debtKey] = {
                            fromId: person.id,
                            fromName: person.name,
                            toId: payerId,
                            toName: payer.name,
                            amount: 0
                        };
                    }
                    personToPersonDebts[debtKey].amount += personShare;
                }
            }
        });
    });
    
    const netDebts = {};
    Object.values(personToPersonDebts).forEach(debt => {
        const reverseKey = `${debt.toId}-${debt.fromId}`;
        const forwardKey = `${debt.fromId}-${debt.toId}`;
        
        if (!netDebts[reverseKey]) {
            if (!netDebts[forwardKey]) {
                netDebts[forwardKey] = {
                    fromId: debt.fromId,
                    fromName: debt.fromName,
                    toId: debt.toId,
                    toName: debt.toName,
                    amount: debt.amount
                };
            } else {
                netDebts[forwardKey].amount += debt.amount;
            }
        } else {
            const netAmount = debt.amount - netDebts[reverseKey].amount;
            if (netAmount > 0) {
                netDebts[forwardKey] = {
                    fromId: debt.fromId,
                    fromName: debt.fromName,
                    toId: debt.toId,
                    toName: debt.toName,
                    amount: netAmount
                };
                delete netDebts[reverseKey];
            } else if (netAmount < 0) {
                netDebts[reverseKey].amount = Math.abs(netAmount);
            } else {
                delete netDebts[reverseKey];
            }
        }
    });
    
    Object.values(netDebts).forEach(debt => {
        if (debt.amount > 0.01) {
            consolidatedTransfers[`${debt.fromName}-to-${debt.toName}`] = {
                from: debt.fromName,
                to: debt.toName,
                amount: debt.amount,
                type: 'person'
            };
        }
    });
    
    jointAccountBills.forEach(bill => {
        let monthlyAmount;
        if (bill.isOneOff) {
            const billDate = new Date(bill.date);
            const today = new Date();
            if (billDate.getMonth() === today.getMonth() && billDate.getFullYear() === today.getFullYear()) {
                monthlyAmount = bill.amount + (bill.overpayment || 0);
            } else {
                return;
            }
        } else {
            monthlyAmount = frequencyToMonthly(bill.amount + (bill.overpayment || 0), bill.frequency);
        }
        
        data.people.forEach(person => {
            const personShare = calculateWeightedShare(monthlyAmount, person.id, data.weightedBills);
            
            if (personShare > 0) {
                const key = `${person.name}-to-Joint`;
                if (!consolidatedTransfers[key]) {
                    consolidatedTransfers[key] = {
                        from: person.name,
                        to: 'Joint Account',
                        amount: 0,
                        type: 'joint'
                    };
                }
                consolidatedTransfers[key].amount += personShare;
            }
        });
    });
    
    return Object.values(consolidatedTransfers);
}

function isPaydayOnDate(person, day, month, year) {
    if (!person.paymentDate || !person.frequency) return false;
    
    const paymentDate = new Date(person.paymentDate);
    const checkDate = new Date(year, month, day);
    
    if (person.frequency === 'monthly') {
        const payDay = paymentDate.getDate();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        if (payDay > daysInMonth) {
            return day === (daysInMonth + 1 <= new Date(year, month + 1, 0).getDate() ? daysInMonth + 1 : 1) && 
                   new Date(year, month, day).getMonth() === (month + (day === 1 ? 1 : 0)) % 12;
        }
        return payDay === day;
    }
    
    if (person.frequency === 'biweekly') {
        const timeDiff = checkDate.getTime() - paymentDate.getTime();
        const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        
        if (daysDiff >= 0 && daysDiff % 14 === 0) {
            return true;
        }
        
        const originalPayday = new Date(paymentDate.getTime() + (Math.floor(daysDiff / 14) * 14 * 24 * 60 * 60 * 1000));
        if (originalPayday.getMonth() === month && originalPayday.getFullYear() === year) {
            const originalDay = originalPayday.getDate();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            
            if (originalDay > daysInMonth) {
                const adjustedDate = new Date(year, month, daysInMonth);
                adjustedDate.setDate(adjustedDate.getDate() + 1);
                return adjustedDate.getDate() === day && adjustedDate.getMonth() === (month + (day === 1 ? 1 : 0)) % 12;
            }
        }
        
        return false;
    }
    
    if (person.frequency === 'quarterly') {
        const payDay = paymentDate.getDate();
        const payMonth = paymentDate.getMonth();
        
        const monthsDiff = (year - paymentDate.getFullYear()) * 12 + (month - payMonth);
        if (monthsDiff < 0 || monthsDiff % 3 !== 0) return false;
        
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        if (payDay > daysInMonth) {
            const adjustedDate = new Date(year, month, daysInMonth);
            adjustedDate.setDate(adjustedDate.getDate() + 1);
            return adjustedDate.getDate() === day && adjustedDate.getMonth() === (month + (day === 1 ? 1 : 0)) % 12;
        }
        
        return payDay === day;
    }
    
    if (person.frequency === 'yearly') {
        const payDay = paymentDate.getDate();
        const payMonth = paymentDate.getMonth();
        
        if (month !== payMonth || year < paymentDate.getFullYear()) return false;
        
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        if (payDay > daysInMonth) {
            const adjustedDate = new Date(year, month, daysInMonth);
            adjustedDate.setDate(adjustedDate.getDate() + 1);
            return adjustedDate.getDate() === day && adjustedDate.getMonth() === (month + (day === 1 ? 1 : 0)) % 12;
        }
        
        return payDay === day;
    }
    
    return false;
}

function showDayEvents(element) {
    const eventsData = JSON.parse(element.dataset.events);
    
    let modal = $('editModal');
    let modalContent;
    
    if (!modal) {
        const modalData = createModal();
        modal = modalData.modal;
        modalContent = modalData.modalContent;
    } else {
        modalContent = $('modalContent');
    }
    
    const monthNames = ["January", "February", "March", "April", "May", "June", 
                       "July", "August", "September", "October", "November", "December"];
    
    const dateString = `${eventsData.day} ${monthNames[eventsData.month]} ${eventsData.year}`;
    
    let billsHTML = '';
    if (eventsData.bills && eventsData.bills.length > 0) {
        billsHTML = `
            <div class="day-events-section">
                <h4>Bills</h4>
                ${eventsData.bills.map(bill => {
                    const backgroundColor = bill.payerColor ? bill.payerColor : '#e8e8e8';
                    const textColor = bill.payerColor ? getContrastColor(bill.payerColor) : '#000000';
                    return `
                        <div class="day-event-item" style="background-color: ${backgroundColor}; color: ${textColor}; padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                            <div>${bill.name}: ${formatCurrency(bill.amount + (bill.overpayment || 0))}</div>
                            <div style="font-size: 12px;">Category: ${bill.category}</div>
                            ${bill.displayNote ? `<div style="font-size: 12px;">${bill.displayNote}</div>` : ''}
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    let paydaysHTML = '';
    if (eventsData.paydays && eventsData.paydays.length > 0) {
        paydaysHTML = `
            <div class="day-events-section">
                <h4>Paydays</h4>
                ${eventsData.paydays.map(person => {
                    return `
                        <div class="day-event-item" style="background-color: ${person.color}; color: #000000; padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                            <div>${person.name} Payday: ${formatCurrency(person.amount || person.income || 0)}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    let bonusesHTML = '';
    if (eventsData.bonuses && eventsData.bonuses.length > 0) {
        bonusesHTML = `
            <div class="day-events-section">
                <h4>Bonuses</h4>
                ${eventsData.bonuses.map(bonus => {
                    return `
                        <div class="day-event-item" style="background-color: ${bonus.person.color}; color: #000000; padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                            <div>${bonus.person.name} Bonus: ${formatCurrency(bonus.amount)}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    let oneOffsHTML = '';
    if (eventsData.oneOffs && eventsData.oneOffs.length > 0) {
        oneOffsHTML = `
            <div class="day-events-section">
                <h4>One-Off Expenses</h4>
                ${eventsData.oneOffs.map(oneOff => {
                    const backgroundColor = oneOff.payerColor ? oneOff.payerColor : '#8e1600';
                    const textColor = oneOff.payerColor ? getContrastColor(oneOff.payerColor) : '#ffffff';
                    return `
                        <div class="day-event-item" style="background-color: ${backgroundColor}; color: ${textColor}; padding: 10px; margin-bottom: 8px; border-radius: 4px;">
                            <div>${oneOff.name}: ${formatCurrency(oneOff.amount)}</div>
                            <div style="font-size: 12px;">Category: ${oneOff.category}</div>
                        </div>
                    `;
                }).join('')}
            </div>
        `;
    }
    
    modalContent.innerHTML = `
        <h3 style="margin-bottom:20px;color:${document.body.classList.contains('dark-mode') ? '#fff' : '#000'};">Events for ${dateString}</h3>
        <div class="day-events-container">
            ${billsHTML}
            ${paydaysHTML}
            ${bonusesHTML}
            ${oneOffsHTML}
        </div>
        <div style="margin-top:20px;text-align:right;">
            <button onclick="hideModal()" style="background:#666;">Close</button>
        </div>
    `;
    
    showModal();
}



function createYearlyIncomeView(personId) {
    const person = data.people.find(p => p.id === personId);
    if (!person) return '';
    
    const paychecks = data.paycheckHistory.filter(p => p.personId === personId);
    if (paychecks.length === 0) {
        return '<div class="historical-income-container"><h4>Income History</h4><p>No income data recorded.</p></div>';
    }
    
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                       "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    const yearData = {};
    
    paychecks.forEach(paycheck => {
        const date = new Date(paycheck.date);
        const year = date.getFullYear();
        const month = date.getMonth();
        
        if (!yearData[year]) {
            yearData[year] = { 
                months: {}, 
                totalSalary: 0, 
                totalBonuses: 0,
                salaryCount: 0,
                bonusCount: 0
            };
        }
        if (!yearData[year].months[month]) {
            yearData[year].months[month] = { salary: 0, bonuses: 0, items: [] };
        }
        
        if (paycheck.type === 'bonus') {
            yearData[year].months[month].bonuses += paycheck.amount;
            yearData[year].totalBonuses += paycheck.amount;
            yearData[year].bonusCount++;
        } else {
            yearData[year].months[month].salary += paycheck.amount;
            yearData[year].totalSalary += paycheck.amount;
            yearData[year].salaryCount++;
        }
        
        yearData[year].months[month].items.push({
            type: paycheck.type,
            amount: paycheck.amount,
            date: paycheck.date,
            description: paycheck.description
        });
    });
    
    const years = Object.keys(yearData).sort((a, b) => b - a);
    let html = `<div class="historical-income-container" id="salaryHistory-${personId}"><h4>Income History</h4>`;
    
    years.forEach(year => {
        const yearInfo = yearData[year];
        const monthsWithData = Object.keys(yearInfo.months).sort((a, b) => b - a);
        const totalIncome = yearInfo.totalSalary + yearInfo.totalBonuses;
        
        html += `<div class="year-group">`;
        html += `<div class="year-header">${year}</div>`;
        html += `<div class="year-totals">`;
        html += `Total Income: ${formatCurrency(totalIncome)} `;
        if (yearInfo.totalSalary > 0 && yearInfo.totalBonuses > 0) {
            html += `(Salary: ${formatCurrency(yearInfo.totalSalary)} | Bonuses: ${formatCurrency(yearInfo.totalBonuses)})`;
        }
        html += `</div>`;
        
        if (monthsWithData.length > 0) {
            html += `<div class="months-list">`;
            monthsWithData.forEach(month => {
                const monthData = yearInfo.months[month];
                const monthTotal = monthData.salary + monthData.bonuses;
                
                html += `<div class="month-item">`;
                html += `<span class="month-name">${monthNames[month]}</span>`;
                html += `<span class="month-total">`;
                
                if (monthData.salary > 0 && monthData.bonuses > 0) {
                    html += `${formatCurrency(monthTotal)} (${formatCurrency(monthData.salary)} + ${formatCurrency(monthData.bonuses)} bonus)`;
                } else {
                    html += `${formatCurrency(monthTotal)}`;
                    if (monthData.bonuses > 0) html += ` (bonus)`;
                }
                
                html += `</span>`;
                html += `</div>`;
            });
            html += `</div>`;
        }
        html += `</div>`;
    });
    
    html += '</div>';
    return html;
}

function formatCurrency(amount) {
    const formatter = new Intl.NumberFormat('en-US', {
        style: 'currency',
        currency: data.currency || 'USD'
    });
    return formatter.format(amount);
}

function calculateDebtInfo(bill) {
    if (!bill.isDebt || !bill.totalDebt || !bill.interestRate) return null;
    
    const monthlyRate = bill.interestRate / 100 / 12;
    const totalPayment = bill.amount + (bill.overpayment || 0);
    const monthlyPayment = frequencyToMonthly(totalPayment, bill.frequency);
    const monthlyInterest = bill.totalDebt * monthlyRate;
    
    let balance = bill.totalDebt;
    let months = 0;
    let totalInterestPaid = 0;
    const maxMonths = 600;
    
    while (balance > 0.01 && months < maxMonths) {
        const interestPayment = balance * monthlyRate;
        const principalPayment = monthlyPayment - interestPayment;
        
        if (principalPayment <= 0) break;
        
        balance -= principalPayment;
        totalInterestPaid += interestPayment;
        months++;
    }
    
    let balanceWithoutOverpayment = bill.totalDebt;
    let monthsWithoutOverpayment = 0;
    let totalInterestWithoutOverpayment = 0;
    const basePayment = frequencyToMonthly(bill.amount, bill.frequency);
    
    while (balanceWithoutOverpayment > 0.01 && monthsWithoutOverpayment < maxMonths) {
        const interestPayment = balanceWithoutOverpayment * monthlyRate;
        const principalPayment = basePayment - interestPayment;
        
        if (principalPayment <= 0) break;
        
        balanceWithoutOverpayment -= principalPayment;
        totalInterestWithoutOverpayment += interestPayment;
        monthsWithoutOverpayment++;
    }
    
    return {
        monthlyInterest: monthlyInterest,
        payoffMonths: months < maxMonths ? months : null,
        payoffMonthsWithoutOverpayment: monthsWithoutOverpayment < maxMonths ? monthsWithoutOverpayment : null,
        overpaymentSavings: bill.overpayment || 0,
        interestSaved: totalInterestWithoutOverpayment - totalInterestPaid,
        termReduction: monthsWithoutOverpayment - months
    };
}

function toggleBillFrequencyOptions() {
    const frequency = $('billFrequency').value;
    const monthGroup = $('billMonthGroup');
    const startMonthGroup = $('billStartMonthGroup');
    
    if (frequency === 'yearly') {
        monthGroup.style.display = 'block';
        startMonthGroup.style.display = 'none';
    } else if (frequency === 'quarterly') {
        monthGroup.style.display = 'none';
        startMonthGroup.style.display = 'block';
    } else {
        monthGroup.style.display = 'none';
        startMonthGroup.style.display = 'none';
    }
}

function getNextWorkingDay(date) {
    const nextDay = new Date(date);
    nextDay.setDate(date.getDate() + 1);
    while (nextDay.getDay() === 0 || nextDay.getDay() === 6) {
        nextDay.setDate(nextDay.getDate() + 1);
    }
    return nextDay;
}

function generateBillDate(day, month, frequency, startMonth) {
    const today = new Date();
    let billDate;
    
    if (frequency === 'yearly' && month) {
        billDate = new Date(today.getFullYear(), month - 1, 1);
        const daysInMonth = new Date(billDate.getFullYear(), billDate.getMonth() + 1, 0).getDate();
        
        if (day > daysInMonth) {
            billDate.setDate(daysInMonth);
            billDate.setDate(billDate.getDate() + 1);
            if (billDate.getDate() === 1) {
                billDate.setMonth(billDate.getMonth() + 1);
            }
        } else {
            billDate.setDate(day);
        }
        
        if (billDate < today) {
            billDate.setFullYear(today.getFullYear() + 1);
            const daysInNextMonth = new Date(billDate.getFullYear(), billDate.getMonth() + 1, 0).getDate();
            if (day > daysInNextMonth) {
                billDate.setDate(daysInNextMonth);
                billDate.setDate(billDate.getDate() + 1);
                if (billDate.getDate() === 1) {
                    billDate.setMonth(billDate.getMonth() + 1);
                }
            } else {
                billDate.setDate(day);
            }
        }
    } else if (frequency === 'quarterly') {
        const currentMonth = today.getMonth() + 1;
        const quarterStart = startMonth || currentMonth;
        let nextQuarterMonth = quarterStart;
        
        while (nextQuarterMonth <= currentMonth) {
            nextQuarterMonth += 3;
        }
        
        if (nextQuarterMonth > 12) {
            nextQuarterMonth = ((nextQuarterMonth - 1) % 12) + 1;
            billDate = new Date(today.getFullYear() + 1, nextQuarterMonth - 1, 1);
        } else {
            billDate = new Date(today.getFullYear(), nextQuarterMonth - 1, 1);
        }
        
        const daysInMonth = new Date(billDate.getFullYear(), billDate.getMonth() + 1, 0).getDate();
        if (day > daysInMonth) {
            billDate.setDate(daysInMonth);
            billDate.setDate(billDate.getDate() + 1);
            if (billDate.getDate() === 1) {
                billDate.setMonth(billDate.getMonth() + 1);
            }
        } else {
            billDate.setDate(day);
        }
    } else {
        billDate = new Date(today.getFullYear(), today.getMonth(), 1);
        const daysInMonth = new Date(billDate.getFullYear(), billDate.getMonth() + 1, 0).getDate();
        
        if (day > daysInMonth) {
            billDate.setDate(daysInMonth);
            billDate.setDate(billDate.getDate() + 1);
            if (billDate.getDate() === 1) {
                billDate.setMonth(billDate.getMonth() + 1);
            }
        } else {
            billDate.setDate(day);
        }
        
        if (billDate < today) {
            billDate.setMonth(billDate.getMonth() + 1);
            const daysInNextMonth = new Date(billDate.getFullYear(), billDate.getMonth() + 1, 0).getDate();
            if (day > daysInNextMonth) {
                billDate.setDate(daysInNextMonth);
                billDate.setDate(billDate.getDate() + 1);
                if (billDate.getDate() === 1) {
                    billDate.setMonth(billDate.getMonth() + 1);
                }
            } else {
                billDate.setDate(day);
            }
        }
    }
    
    return billDate.toISOString().split('T')[0];
}

function isPaydayOnDate(person, day, month, year) {
    if (!person.paymentDate || !person.frequency) return false;
    
    const paymentDate = new Date(person.paymentDate);
    const checkDate = new Date(year, month, day);
    
    if (person.frequency === 'monthly') {
        const payDay = paymentDate.getDate();
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        if (payDay > daysInMonth) {
            return day === daysInMonth;
        }
        return payDay === day;
    }
    
    if (person.frequency === 'biweekly') {
        const timeDiff = checkDate.getTime() - paymentDate.getTime();
        const daysDiff = Math.floor(timeDiff / (1000 * 60 * 60 * 24));
        return daysDiff >= 0 && daysDiff % 14 === 0;
    }
    
    if (person.frequency === 'quarterly') {
        const payDay = paymentDate.getDate();
        const payMonth = paymentDate.getMonth();
        
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const adjustedPayDay = payDay > daysInMonth ? daysInMonth : payDay;
        
        if (adjustedPayDay !== day) return false;
        
        const monthsDiff = (year - paymentDate.getFullYear()) * 12 + (month - payMonth);
        return monthsDiff >= 0 && monthsDiff % 3 === 0;
    }
    
    if (person.frequency === 'yearly') {
        const payDay = paymentDate.getDate();
        const payMonth = paymentDate.getMonth();
        
        if (month !== payMonth) return false;
        
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        const adjustedPayDay = payDay > daysInMonth ? daysInMonth : payDay;
        
        return adjustedPayDay === day && year >= paymentDate.getFullYear();
    }
    
    return false;
}

function toggleBillTypeVisibility() {
    const billTypeGroup = $('billTypeGroup');
    const billPayerGroup = $('billPayerGroup');
    
    if (data.people.length <= 1) {
        billTypeGroup.style.display = 'none';
        billPayerGroup.style.display = 'none';
        $('billType').value = 'individual';
    } else {
        billTypeGroup.style.display = 'block';
        toggleBillPayerVisibility();
    }
}

function toggleBillPayerVisibility() {
    const billType = $('billType').value;
    const billPayerGroup = $('billPayerGroup');
    billPayerGroup.style.display = 'block';
    updateBillPayerOptions();
}

function updateBillPayerOptions() {
    const billPayer = $('billPayer');
    const billType = $('billType').value;
    
    billPayer.innerHTML = '';
    
    if (billType === 'joint') {
        const jointOption = document.createElement('option');
        jointOption.value = 'joint';
        jointOption.textContent = 'Joint Account';
        billPayer.appendChild(jointOption);
    }
    
    data.people.forEach(person => {
        const option = document.createElement('option');
        option.value = person.id;
        option.textContent = person.name;
        billPayer.appendChild(option);
    });
    
    if (billPayer.options.length > 0 && !billPayer.value) {
        if (billType === 'joint') {
            billPayer.value = 'joint';
        } else {
            billPayer.value = data.people[0].id;
        }
    }
}

function toggleDebtFields() {
    const isDebt = $('isDebt').checked;
    const debtFields = $('debtFields');
    debtFields.style.display = isDebt ? 'block' : 'none';
}

function toggleOneOffFields() {
    const isOneOff = $('isOneOff').checked;
    const billFrequency = $('billFrequency');
    const billFrequencyGroup = billFrequency.closest('.form-group');
    const billDate = $('billDate');
    const billDateGroup = billDate.closest('.form-group');
    const billMonthGroup = $('billMonthGroup');
    const billStartMonthGroup = $('billStartMonthGroup');
    const isDebtCheckbox = $('isDebt');
    
    if (isOneOff) {
        billFrequency.disabled = true;
        billFrequency.value = 'monthly';
        billFrequencyGroup.style.display = 'none';
        billDateGroup.style.display = 'none';
        billMonthGroup.style.display = 'none';
        billStartMonthGroup.style.display = 'none';
        isDebtCheckbox.checked = false;
        isDebtCheckbox.disabled = true;
        toggleDebtFields();
    } else {
        billFrequency.disabled = false;
        billFrequencyGroup.style.display = 'block';
        billDateGroup.style.display = 'block';
        isDebtCheckbox.disabled = false;
        toggleBillFrequencyOptions();
    }
}

function createModal() {
    const modal = document.createElement('div');
    modal.id = 'editModal';
    modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: none;
        z-index: 10000;
        justify-content: center;
        align-items: center;
    `;
    
    const modalContent = document.createElement('div');
    modalContent.id = 'modalContent';
    modalContent.style.cssText = `
        background: ${document.body.classList.contains('dark-mode') ? '#000' : '#fff'};
        border: 2px solid ${document.body.classList.contains('dark-mode') ? '#fff' : '#000'};
        border-radius: 16px;
        padding: 32px;
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        color: ${document.body.classList.contains('dark-mode') ? '#fff' : '#000'};
    `;
    
    modal.appendChild(modalContent);
    document.body.appendChild(modal);
    
    modal.addEventListener('click', (e) => {
        if (e.target === modal) {
            hideModal();
        }
    });
    
    return { modal, modalContent };
}

function showModal() {
    let modal = $('editModal');
    if (!modal) {
        const modalData = createModal();
        modal = modalData.modal;
    }
    modal.style.display = 'flex';
}

function hideModal() {
    const modal = $('editModal');
    if (modal) {
        modal.style.display = 'none';
    }
}

function showEditBillModal(bill) {
    let modal = $('editModal');
    let modalContent;
    
    if (!modal) {
        const modalData = createModal();
        modal = modalData.modal;
        modalContent = modalData.modalContent;
    } else {
        modalContent = $('modalContent');
    }
    
    const dayOptions = Array.from({length: 31}, (_, i) => {
        const day = i + 1;
        return `<option value="${day}"${bill.day === day ? ' selected' : ''}>${day}</option>`;
    }).join('');
    
    const monthOptions = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ].map((month, i) => {
        const value = i + 1;
        return `<option value="${value}"${bill.month === value ? ' selected' : ''}>${month}</option>`;
    }).join('');
    
    const startMonthOptions = [
        'January', 'February', 'March', 'April', 'May', 'June',
        'July', 'August', 'September', 'October', 'November', 'December'
    ].map((month, i) => {
        const value = i + 1;
        return `<option value="${value}"${bill.startMonth === value ? ' selected' : ''}>${month}</option>`;
    }).join('');
    
    const categoryOptions = [
        'Utilities', 'Housing', 'Transportation', 'Insurance', 'Entertainment',
        'Subscriptions', 'Government', 'Financial', 'Health & Fitness', 'Technology', 'Other'
    ].map(cat => 
        `<option value="${cat}"${bill.category === cat ? ' selected' : ''}>${cat}</option>`
    ).join('');
    
    const generatePayerOptions = (currentBillType, currentPayer) => {
        let options = '';
        
        if (currentBillType === 'joint') {
            options += `<option value="joint"${currentPayer === 'joint' ? ' selected' : ''}>Joint Account</option>`;
        }
        
        data.people.forEach(person => {
            const isSelected = currentPayer == person.id ? ' selected' : '';
            options += `<option value="${person.id}"${isSelected}>${person.name}</option>`;
        });
        
        return options;
    };
    
    const billTypeSection = data.people.length > 1 ? `
        <div class="form-group">
            <label for="editBillType">Bill Type</label>
            <select id="editBillType">
                <option value="individual"${bill.billType === 'individual' ? ' selected' : ''}>Individual</option>
                <option value="joint"${bill.billType === 'joint' ? ' selected' : ''}>Joint</option>
            </select>
        </div>
        <div class="form-group" id="editBillPayerGroup">
            <label for="editBillPayer">Paid By</label>
            <select id="editBillPayer">
                ${generatePayerOptions(bill.billType, bill.payer)}
            </select>
        </div>
    ` : '';
    
    modalContent.innerHTML = `
        <h3 style="margin-bottom:20px;color:${document.body.classList.contains('dark-mode') ? '#fff' : '#000'};">Edit Bill: ${bill.name}</h3>
        <div class="form-group">
            <label for="editBillName">Bill Name</label>
            <input type="text" id="editBillName" value="${bill.name}">
        </div>
        <div class="form-group">
            <label for="editBillAmount">Amount</label>
            <input type="number" id="editBillAmount" value="${bill.amount}" step="0.01">
        </div>
        <div class="form-group">
            <label for="editBillFrequency">Frequency</label>
            <select id="editBillFrequency">
                <option value="monthly"${bill.frequency === 'monthly' ? ' selected' : ''}>Monthly</option>
                <option value="quarterly"${bill.frequency === 'quarterly' ? ' selected' : ''}>Quarterly</option>
                <option value="yearly"${bill.frequency === 'yearly' ? ' selected' : ''}>Yearly</option>
            </select>
        </div>
        <div class="form-group">
            <label for="editBillDate">Due Day of Month</label>
            <select id="editBillDate">
                <option value="">Select day...</option>
                ${dayOptions}
            </select>
        </div>
        <div class="form-group" id="editBillMonthGroup" style="display:${bill.frequency === 'yearly' ? 'block' : 'none'};">
            <label for="editBillMonth">Month</label>
            <select id="editBillMonth">
                ${monthOptions}
            </select>
        </div>
        <div class="form-group" id="editBillStartMonthGroup" style="display:${bill.frequency === 'quarterly' ? 'block' : 'none'};">
            <label for="editBillStartMonth">Start Month</label>
            <select id="editBillStartMonth">
                ${startMonthOptions}
            </select>
        </div>
        <div class="form-group">
            <label for="editBillCategory">Category</label>
            <select id="editBillCategory">
                ${categoryOptions}
            </select>
        </div>
        ${billTypeSection}
        <div class="checkbox-group">
            <input type="checkbox" id="editIsDebt"${bill.isDebt ? ' checked' : ''}>
            <label for="editIsDebt">This is a debt/loan</label>
        </div>
        <div id="editDebtFields" style="display:${bill.isDebt ? 'block' : 'none'};">
            <div class="form-group">
                <label for="editTotalDebt">Total Debt Amount</label>
                <input type="number" id="editTotalDebt" value="${bill.totalDebt || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label for="editInterestRate">Interest Rate (%)</label>
                <input type="number" id="editInterestRate" value="${bill.interestRate || ''}" step="0.01">
            </div>
            <div class="form-group">
                <label for="editTermYears">Term Length Years</label>
                <input type="number" id="editTermYears" value="${bill.termYears || ''}" min="0">
            </div>
            <div class="form-group">
                <label for="editTermMonths">Additional Months</label>
                <input type="number" id="editTermMonths" value="${bill.termMonths || ''}" min="0" max="11">
            </div>
            <div class="form-group">
                <label for="editOverpayment">Monthly Overpayment</label>
                <input type="number" id="editOverpayment" value="${bill.overpayment || ''}" step="0.01">
            </div>
        </div>
        <div style="display:flex;gap:10px;margin-top:20px;">
            <button id="saveEditBtn" style="flex:1;">Save Changes</button>
            <button id="cancelEditBtn" style="flex:1;background:#666;">Cancel</button>
        </div>
    `;
    
    $('editBillFrequency').addEventListener('change', () => {
        const frequency = $('editBillFrequency').value;
        const monthGroup = $('editBillMonthGroup');
        const startMonthGroup = $('editBillStartMonthGroup');
        
        if (frequency === 'yearly') {
            monthGroup.style.display = 'block';
            startMonthGroup.style.display = 'none';
        } else if (frequency === 'quarterly') {
            monthGroup.style.display = 'none';
            startMonthGroup.style.display = 'block';
        } else {
            monthGroup.style.display = 'none';
            startMonthGroup.style.display = 'none';
        }
    });
    
    $('editIsDebt').addEventListener('change', () => {
        const isDebt = $('editIsDebt').checked;
        const debtFields = $('editDebtFields');
        debtFields.style.display = isDebt ? 'block' : 'none';
    });
    
    if (data.people.length > 1) {
        $('editBillType').addEventListener('change', () => {
            const billType = $('editBillType').value;
            const billPayer = $('editBillPayer');
            
            billPayer.innerHTML = '';
            
            if (billType === 'joint') {
                const jointOption = document.createElement('option');
                jointOption.value = 'joint';
                jointOption.textContent = 'Joint Account';
                billPayer.appendChild(jointOption);
            }
            
            data.people.forEach(person => {
                const option = document.createElement('option');
                option.value = person.id;
                option.textContent = person.name;
                billPayer.appendChild(option);
            });
            
            if (billType === 'joint') {
                billPayer.value = 'joint';
            } else if (billPayer.options.length > 0) {
                billPayer.value = data.people[0].id;
            }
        });
    }
    
    $('saveEditBtn').addEventListener('click', () => {
        const name = $('editBillName').value.trim();
        const amount = parseFloat($('editBillAmount').value) || 0;
        const frequency = $('editBillFrequency').value;
        const day = parseInt($('editBillDate').value);
        const month = $('editBillMonth').value ? parseInt($('editBillMonth').value) : null;
        const startMonth = $('editBillStartMonth').value ? parseInt($('editBillStartMonth').value) : null;
        const category = $('editBillCategory').value;
        const billType = data.people.length <= 1 ? 'individual' : $('editBillType').value;
        const isDebt = $('editIsDebt').checked;
        
        let payer;
        if (data.people.length <= 1) {
            payer = data.people[0]?.id;
        } else {
            const selectedPayer = $('editBillPayer').value;
            if (billType === 'joint' && selectedPayer === 'joint') {
                payer = 'joint';
            } else {
                payer = parseInt(selectedPayer);
            }
        }
        
        if (!name || !amount) {
            alert('Please fill in bill name and amount');
            return;
        }
        
        if (!day) {
            alert('Please select a due day');
            return;
        }
        
        if (frequency === 'yearly' && !month) {
            alert('Please select a month for yearly bills');
            return;
        }
        
        if (frequency === 'quarterly' && !startMonth) {
            alert('Please select a start month for quarterly bills');
            return;
        }
        
        if (payer !== 'joint' && !data.people.find(p => p.id === payer)) {
            alert('Please select a valid payer');
            return;
        }
        
        bill.name = name;
        bill.amount = amount;
        bill.frequency = frequency;
        bill.day = day;
        bill.month = month;
        bill.startMonth = frequency === 'quarterly' ? startMonth : null;
        bill.category = category;
        bill.billType = billType;
        bill.payer = payer;
        bill.isDebt = isDebt;
        
        if (isDebt) {
            bill.totalDebt = parseFloat($('editTotalDebt').value) || 0;
            bill.interestRate = parseFloat($('editInterestRate').value) || 0;
            bill.termYears = parseInt($('editTermYears').value) || 0;
            bill.termMonths = parseInt($('editTermMonths').value) || 0;
            bill.overpayment = parseFloat($('editOverpayment').value) || 0;
        } else {
            delete bill.totalDebt;
            delete bill.interestRate;
            delete bill.termYears;
            delete bill.termMonths;
            delete bill.overpayment;
        }
        
        bill.date = generateBillDate(day, month, frequency, startMonth);
        
        const payerName = payer === 'joint' ? 'Joint Account' : 
                         data.people.find(p => p.id === payer)?.name || 'Unknown';
        
        data.eventHistory.push({
            id: nextEventId++,
            date: new Date().toISOString().split('T')[0],
            event: 'Bill Updated',
            description: `Updated ${bill.name} details, paid by ${payerName}`
        });
        
        saveDataToLocalStorage();
        updateBillsList();
        updateOverview();
        hideModal();
    });
    
    $('cancelEditBtn').addEventListener('click', hideModal);
    
    showModal();
}

function addBill() {
    const name = $('billName').value.trim();
    const amount = parseFloat($('billAmount').value) || 0;
    const frequency = $('billFrequency').value;
    const day = parseInt($('billDate').value);
    const month = $('billMonth').value ? parseInt($('billMonth').value) : null;
    const startMonth = $('billStartMonth').value ? parseInt($('billStartMonth').value) : null;
    const category = $('billCategory').value;
    const billType = data.people.length <= 1 ? 'individual' : $('billType').value;
    const isDebt = $('isDebt').checked;
    const isOneOff = $('isOneOff').checked;
    
    let payer;
    if (data.people.length <= 1) {
        payer = data.people[0]?.id;
    } else {
        const selectedPayer = $('billPayer').value;
        if (billType === 'joint' && selectedPayer === 'joint') {
            payer = 'joint';
        } else {
            payer = parseInt(selectedPayer);
        }
    }
    
    if (!name || !amount) {
        alert('Please fill in bill name and amount');
        return;
    }
    
    if (!isOneOff && frequency === 'yearly' && !month) {
        alert('Please select a month for yearly bills');
        return;
    }
    
    if (!isOneOff && frequency === 'quarterly' && !startMonth) {
        alert('Please select a start month for quarterly bills');
        return;
    }
    
    if (!isOneOff && day && month && frequency === 'yearly') {
        const testDate = new Date(2024, month - 1, day);
        if (testDate.getMonth() !== month - 1) {
            alert(`Day ${day} does not exist in ${['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'][month - 1]}. The bill will be moved to the next valid day when that month occurs.`);
        }
    }
    
    if (!isOneOff && day > 31) {
        alert('Please select a valid day (1-31)');
        return;
    }
    
    if (payer !== 'joint' && !data.people.find(p => p.id === payer)) {
        alert('Please select a valid payer');
        return;
    }
    
    const bill = {
        id: nextBillId++,
        name: name,
        amount: amount,
        frequency: isOneOff ? 'one-off' : frequency,
        date: isOneOff ? new Date().toISOString().split('T')[0] : generateBillDate(day, month, frequency, startMonth),
        day: isOneOff ? null : day,
        month: isOneOff ? null : month,
        startMonth: frequency === 'quarterly' ? startMonth : null,
        category: category,
        billType: billType,
        payer: payer,
        isDebt: isDebt,
        isOneOff: isOneOff,
        dateCreated: new Date().toISOString().split('T')[0]
    };
    
    if (isDebt) {
        bill.totalDebt = parseFloat($('totalDebt').value) || 0;
        bill.interestRate = parseFloat($('interestRate').value) || 0;
        bill.termYears = parseInt($('termYears').value) || 0;
        bill.termMonths = parseInt($('termMonths').value) || 0;
        bill.overpayment = parseFloat($('overpayment').value) || 0;
    }
    
    data.bills.push(bill);
    
    const payerName = payer === 'joint' ? 'Joint Account' : 
                     data.people.find(p => p.id === parseInt(payer))?.name || 'Unknown';
    
    if (isOneOff) {
        const paymentRecord = {
            id: nextPaycheckId++,
            billId: bill.id,
            billName: bill.name,
            amount: bill.amount + (bill.overpayment || 0),
            date: bill.date,
            category: bill.category,
            billType: bill.billType,
            payer: bill.payer,
            status: 'One-off expense'
        };
        
        if (!data.billPayments) data.billPayments = [];
        data.billPayments.push(paymentRecord);
        
        data.eventHistory.push({
            id: nextEventId++,
            date: new Date().toISOString().split('T')[0],
            event: 'Unexpected Expense Added',
            description: `Added one-off expense: ${bill.name} - ${formatCurrency(bill.amount + (bill.overpayment || 0))} paid by ${payerName}`
        });
    } else {
        data.eventHistory.push({
            id: nextEventId++,
            date: new Date().toISOString().split('T')[0],
            event: 'Bill Added',
            description: `Added ${bill.name} - ${formatCurrency(bill.amount + (bill.overpayment || 0))}/${bill.frequency} on day ${day}${month ? ` of month ${month}` : ''} paid by ${payerName}`
        });
    }
    
    $('billName').value = '';
    $('billAmount').value = '';
    $('billDate').value = '';
    $('billMonth').value = '';
    $('billStartMonth').value = '';
    $('isDebt').checked = false;
    $('isOneOff').checked = false;
    $('totalDebt').value = '';
    $('interestRate').value = '';
    $('termYears').value = '';
    $('termMonths').value = '';
    $('overpayment').value = '';
    toggleDebtFields();
    toggleOneOffFields();
    toggleBillFrequencyOptions();
    
    saveDataToLocalStorage();
    updateBillsList();
    updateOverview();
    toggleBillTypeVisibility();
}

function editBill(billId) {
    const bill = data.bills.find(b => b.id === billId);
    if (!bill) return;
    showEditBillModal(bill);
}

function deleteBill(billId) {
    const bill = data.bills.find(b => b.id === billId);
    if (!bill) return;
    
    const confirmMessage = bill.isOneOff ? 
        'Delete this one off expense?' : 
        'Are you sure you want to stop this bill? This will prevent future payments but keep the payment history.';
    
    if (!confirm(confirmMessage)) return;

    bill.isDeleted = true;
    bill.deletedDate = new Date().toISOString().split('T')[0];

    if (bill.isDebt) {
        bill.isDebt = false;
        bill.totalDebt = 0;
        bill.interestRate = 0;
        bill.termYears = 0;
        bill.termMonths = 0;
        bill.overpayment = 0;
    }

    const eventDescription = bill.isOneOff ? 
        `Deleted one-off expense: ${bill.name} - ${formatCurrency(bill.amount + (bill.overpayment || 0))}` :
        `Stopped future payments for ${bill.name} - ${formatCurrency(bill.amount + (bill.overpayment || 0))}/${bill.frequency}. Payment history preserved.`;

    data.eventHistory.push({
        id: nextEventId++,
        date: new Date().toISOString().split('T')[0],
        event: bill.isOneOff ? 'One-off Expense Deleted' : 'Bill Stopped',
        description: eventDescription
    });

    saveDataToLocalStorage();
    updateBillsList();
    updateOverview(); 
    toggleBillTypeVisibility();
}

function updateBillsList() {
    const billsList = $('billsList');
    billsList.innerHTML = '';
    
    const activeBills = data.bills.filter(b => !b.isDeleted);
    
    if (data.people.length <= 1) {
        activeBills.forEach(bill => {
            billsList.appendChild(createBillItem(bill));
        });
        return;
    }
    
    const jointBills = activeBills.filter(b => b.billType === 'joint');
    const individualBills = activeBills.filter(b => b.billType === 'individual');
    
    if (jointBills.length > 0) {
        const jointGroup = document.createElement('div');
        jointGroup.className = 'bills-group';
        jointGroup.innerHTML = '<div class="bills-group-header">Joint Bills</div>';
        
        jointBills.forEach(bill => {
            jointGroup.appendChild(createBillItem(bill));
        });
        
        billsList.appendChild(jointGroup);
    }
    
    const peopleWithBills = data.people.filter(person => 
        individualBills.some(bill => bill.payer === person.id)
    );
    
    peopleWithBills.forEach(person => {
        const personBills = individualBills.filter(bill => bill.payer === person.id);
        
        if (personBills.length > 0) {
            const personGroup = document.createElement('div');
            personGroup.className = 'bills-group';
            personGroup.innerHTML = `<div class="bills-group-header">${person.name}'s Bills</div>`;
            
            personBills.forEach(bill => {
                personGroup.appendChild(createBillItem(bill));
            });
            
            billsList.appendChild(personGroup);
        }
    });
}

function createBillItem(bill) {
    const billItem = document.createElement('div');
    billItem.className = 'bill-item';
    
    const payerName = bill.payer === 'joint' ? 'Joint Account' : 
                     data.people.find(p => p.id === parseInt(bill.payer))?.name || 'Unknown';
    
    let debtInfo = '';
    if (bill.isDebt && bill.totalDebt > 0) {
        const debtCalc = calculateDebtInfo(bill);
        debtInfo = `
            <div>Total Debt: ${formatCurrency(bill.totalDebt)}</div>
            ${bill.interestRate > 0 ? `<div>Interest Rate: ${bill.interestRate}%</div>` : ''}
            ${bill.termYears > 0 || bill.termMonths > 0 ? 
              `<div>Term: ${bill.termYears} years${bill.termMonths > 0 ? `, ${bill.termMonths} months` : ''}</div>` : ''}
            ${bill.overpayment > 0 ? `<div>Overpayment: ${formatCurrency(bill.overpayment)}/month</div>` : ''}
            ${debtCalc && debtCalc.monthlyInterest ? 
              `<div>Est. Monthly Interest: ${formatCurrency(debtCalc.monthlyInterest)}</div>` : ''}
            ${debtCalc && debtCalc.payoffMonths ? 
              `<div>Est. Payoff: ${Math.floor(debtCalc.payoffMonths / 12)} years ${debtCalc.payoffMonths % 12} months</div>` : ''}
        `;
    }
    
    const monthNames = ["Jan", "Feb", "Mar", "Apr", "May", "Jun", 
                       "Jul", "Aug", "Sep", "Oct", "Nov", "Dec"];
    let dueText;
    
    if (bill.isOneOff) {
        const billDate = new Date(bill.date);
        dueText = `${billDate.getDate()} ${monthNames[billDate.getMonth()]} ${billDate.getFullYear()}`;
    } else if (bill.frequency === 'yearly' && bill.month) {
        dueText = `Day ${bill.day} of ${monthNames[bill.month - 1]}`;
    } else if (bill.frequency === 'quarterly' && bill.startMonth) {
        dueText = `Day ${bill.day}, starting ${monthNames[bill.startMonth - 1]}`;
    } else {
        dueText = `Day ${bill.day} of month`;
    }
    
    billItem.innerHTML = `
        <div class="bill-info">
            <strong>${bill.name}</strong>
            <div>Amount: ${formatCurrency(bill.amount)}/${bill.frequency}${bill.overpayment > 0 ? ` + ${formatCurrency(bill.overpayment)} overpayment` : ''}</div>
            <div>Total: ${formatCurrency(bill.amount + (bill.overpayment || 0))}/${bill.frequency}</div>
            <div>Due: ${dueText}</div>
            <div>Category: ${bill.category}</div>
            ${data.people.length > 1 ? `<div>Type: ${bill.billType}</div>` : ''}
            ${data.people.length > 1 ? `<div>Paid by: ${payerName}</div>` : ''}
            ${bill.isDebt ? '<div>Type: Debt/Loan</div>' : ''}
            ${debtInfo}
        </div>
        <div class="bill-actions">
            <button class="btn-small" onclick="editBill(${bill.id})">Edit</button>
            <button class="btn-danger btn-small" onclick="deleteBill(${bill.id})">Delete</button>
        </div>
    `;
    
    return billItem;
}

function updateOverview() {
    const totalMonthlyIncome = data.people.reduce((sum, person) => sum + calculateMonthlyBudget(person), 0);
    const totalMonthlySavings = data.people.reduce((sum, person) => sum + (person.savings || 0), 0);
    const activeBills = data.bills.filter(b => !b.isDeleted);
    
    const totalMonthlyBills = activeBills.reduce((sum, bill) => {
        if (bill.isOneOff) {
            const billDate = new Date(bill.date);
            const today = new Date();
            if (billDate.getMonth() === today.getMonth() && billDate.getFullYear() === today.getFullYear()) {
                return sum + (bill.amount + (bill.overpayment || 0));
            }
            return sum;
        } else {
            return sum + frequencyToMonthly(bill.amount + (bill.overpayment || 0), bill.frequency);
        }
    }, 0);
    
    const totalMonthlyExpenses = data.people.reduce((sum, person) => sum + (person.expenses || 0), 0);
    const leftover = totalMonthlyIncome - totalMonthlySavings - totalMonthlyBills - totalMonthlyExpenses;
    
    $('totalIncome').textContent = formatCurrency(totalMonthlyIncome);
    $('totalBills').textContent = formatCurrency(totalMonthlyBills);
    $('totalSavings').textContent = formatCurrency(totalMonthlySavings);
    $('totalLeftover').textContent = formatCurrency(leftover);
    
    $('billsPercentage').textContent = totalMonthlyIncome ? 
        `${((totalMonthlyBills / totalMonthlyIncome) * 100).toFixed(1)}%` : '0%';
    $('savingsPercentage').textContent = totalMonthlyIncome ? 
        `${((totalMonthlySavings / totalMonthlyIncome) * 100).toFixed(1)}%` : '0%';
    $('leftoverPercentage').textContent = totalMonthlyIncome ? 
        `${((leftover / totalMonthlyIncome) * 100).toFixed(1)}%` : '0%';
    
    updatePeopleOverview();
    updateDebtOverview();
    updateOneOffOverview();
    updateTransfersOverview();
    updateCalendarView();
    data.people.forEach(p => updatePersonOverview(p.id));
}

function updatePeopleOverview() {
    const container = $('peopleOverview');
    container.innerHTML = '';
    const hasJointBills = data.bills.some(b => b.billType === 'joint' && !b.isDeleted);
    
    data.people.forEach(person => {
        const monthlyIncome = calculateMonthlyBudget(person);
        const monthlySavings = person.savings || 0;
        const monthlyExpenses = person.expenses || 0;
        
        const individualBills = data.bills
            .filter(b => b.billType === 'individual' && b.payer === person.id && !b.isDeleted);
        
        let individualBillsMonthly = 0;
        let quarterlySetAside = 0;
        let yearlySetAside = 0;
        
        individualBills.forEach(bill => {
            const totalAmount = bill.amount + (bill.overpayment || 0);
            if (bill.isOneOff) {
                const billDate = new Date(bill.date);
                const today = new Date();
                if (billDate.getMonth() === today.getMonth() && billDate.getFullYear() === today.getFullYear()) {
                    individualBillsMonthly += totalAmount;
                }
            } else if (bill.frequency === 'monthly') {
                individualBillsMonthly += totalAmount;
            } else if (bill.frequency === 'quarterly') {
                quarterlySetAside += calculateSetAsideAmount(totalAmount, 'quarterly', bill.isDebt, bill.interestRate, bill.totalDebt);
            } else if (bill.frequency === 'yearly') {
                yearlySetAside += calculateSetAsideAmount(totalAmount, 'yearly', bill.isDebt, bill.interestRate, bill.totalDebt);
            }
        });
        
        let jointBillsShare = 0;
        let jointQuarterlySetAside = 0;
        let jointYearlySetAside = 0;
        
        const jointBills = data.bills.filter(b => b.billType === 'joint' && !b.isDeleted);
        jointBills.forEach(bill => {
            const totalAmount = bill.amount + (bill.overpayment || 0);
            const personShare = calculateWeightedShare(totalAmount, person.id, data.weightedBills);
            
            if (bill.isOneOff) {
                const billDate = new Date(bill.date);
                const today = new Date();
                if (billDate.getMonth() === today.getMonth() && billDate.getFullYear() === today.getFullYear()) {
                    jointBillsShare += personShare;
                }
            } else if (bill.frequency === 'monthly') {
                jointBillsShare += personShare;
            } else if (bill.frequency === 'quarterly') {
                const setAsideAmount = calculateSetAsideAmount(totalAmount, 'quarterly', bill.isDebt, bill.interestRate, bill.totalDebt);
                jointQuarterlySetAside += calculateWeightedShare(setAsideAmount, person.id, data.weightedBills);
            } else if (bill.frequency === 'yearly') {
                const setAsideAmount = calculateSetAsideAmount(totalAmount, 'yearly', bill.isDebt, bill.interestRate, bill.totalDebt);
                jointYearlySetAside += calculateWeightedShare(setAsideAmount, person.id, data.weightedBills);
            }
        });
        
        const totalQuarterlySetAside = quarterlySetAside + jointQuarterlySetAside;
        const totalYearlySetAside = yearlySetAside + jointYearlySetAside;
        
        const netMonthly = monthlyIncome - monthlySavings - monthlyExpenses - individualBillsMonthly - 
                          jointBillsShare - totalQuarterlySetAside - totalYearlySetAside;
        
        const personCard = document.createElement('div');
        personCard.className = 'person-card';
        personCard.innerHTML = `
            <h3><span class="person-color-dot" style="background-color: ${person.color || colorPalette[0].value}"></span>${person.name}</h3>
            <div class="person-info">
                <div class="info-item">
                    <span class="info-label">Monthly Income</span>
                    <span class="info-value">${formatCurrency(monthlyIncome)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Monthly Savings</span>
                    <span class="info-value">${formatCurrency(monthlySavings)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">Monthly Expenses</span>
                    <span class="info-value">${formatCurrency(monthlyExpenses)}</span>
                </div>
                <div class="info-item">
                    <span class="info-label">${data.people.length === 1 ? 'Monthly Bills' : 'Individual Monthly Bills'}</span>
                    <span class="info-value">${formatCurrency(individualBillsMonthly)}</span>
                </div>
                ${totalQuarterlySetAside > 0 ? `
                    <div class="info-item">
                        <span class="info-label">Set aside for Quarterly Bills</span>
                        <span class="info-value">${formatCurrency(totalQuarterlySetAside)}/month</span>
                    </div>
                ` : ''}
                ${totalYearlySetAside > 0 ? `
                    <div class="info-item">
                        <span class="info-label">Set aside for Yearly Bills</span>
                        <span class="info-value">${formatCurrency(totalYearlySetAside)}/month</span>
                    </div>
                ` : ''}
                ${hasJointBills ? `
                    <div class="info-item">
                        <span class="info-label">Joint Monthly Bills</span>
                        <span class="info-value">${formatCurrency(jointBillsShare)}</span>
                    </div>
                ` : ''}
                <div class="info-item">
                    <span class="info-label">Net Monthly</span>
                    <span class="info-value">${formatCurrency(netMonthly)}</span>
                </div>
            </div>
        `;
        
        container.appendChild(personCard);
    });
}

function updateDebtOverview() {
    const debtsList = $('debtsList');
    const debtOverview = $('debtOverview');
    const debts = data.bills.filter(b => b.isDebt && b.totalDebt > 0 && !b.isDeleted);

    if (debts.length === 0) {
        debtOverview.style.display = 'none';
        return;
    }

    debtOverview.style.display = 'block';
    debtsList.innerHTML = '';

    if (data.people.length <= 1) {
        debts.forEach(debt => {
            debtsList.appendChild(createDebtItem(debt));
        });
        return;
    }

    const jointDebts = debts.filter(d => d.billType === 'joint');
    const individualDebts = debts.filter(d => d.billType === 'individual');

    if (jointDebts.length > 0) {
        const jointGroup = document.createElement('div');
        jointGroup.className = 'bills-group';
        jointGroup.innerHTML = '<div class="bills-group-header">Joint Debts</div>';
        
        jointDebts.forEach(debt => {
            jointGroup.appendChild(createDebtItem(debt));
        });
        
        debtsList.appendChild(jointGroup);
    }

    const peopleWithDebts = data.people.filter(person => 
        individualDebts.some(debt => debt.payer === person.id)
    );

    peopleWithDebts.forEach(person => {
        const personDebts = individualDebts.filter(debt => debt.payer === person.id);
        
        if (personDebts.length > 0) {
            const personGroup = document.createElement('div');
            personGroup.className = 'bills-group';
            personGroup.innerHTML = `<div class="bills-group-header">${person.name}'s Debts</div>`;
            
            personDebts.forEach(debt => {
                personGroup.appendChild(createDebtItem(debt));
            });
            
            debtsList.appendChild(personGroup);
        }
    });
}

function createDebtItem(debt) {
    const monthlyPayment = frequencyToMonthly(debt.amount, debt.frequency);
    const totalWithOverpayment = monthlyPayment + (debt.overpayment || 0);
    const debtCalc = calculateDebtInfo(debt);

    const debtItem = document.createElement('div');
    debtItem.className = 'debt-item';
    debtItem.innerHTML = `
        <div class="info-item">
            <span class="info-label">${debt.name}</span>
            <span class="info-value">${formatCurrency(debt.totalDebt)}${debt.interestRate > 0 ? ` @ ${debt.interestRate}%` : ''}</span>
        </div>
        <div class="info-item">
            <span class="info-label">Monthly Payment</span>
            <span class="info-value">${formatCurrency(totalWithOverpayment)}</span>
        </div>
        ${debtCalc && debtCalc.monthlyInterest ? `
            <div class="info-item">
                <span class="info-label">Est. Monthly Interest</span>
                <span class="info-value">${formatCurrency(debtCalc.monthlyInterest)} (estimate)</span>
            </div>
        ` : ''}
        ${debtCalc && debtCalc.payoffMonths ? `
            <div class="info-item">
                <span class="info-label">Est. Payoff Time</span>
                <span class="info-value">${Math.floor(debtCalc.payoffMonths / 12)} years ${debtCalc.payoffMonths % 12} months</span>
            </div>
        ` : ''}
        ${debtCalc && debtCalc.overpaymentSavings > 0 && debtCalc.termReduction > 0 ? `
            <div class="info-item">
                <span class="info-label">Overpayment Benefit</span>
                <span class="info-value">Saves ${Math.floor(debtCalc.termReduction / 12)} years ${debtCalc.termReduction % 12} months, ${formatCurrency(debtCalc.interestSaved)} interest</span>
            </div>
        ` : ''}
    `;

    return debtItem;
}

function updateTransfersOverview() {
    const transfersOverview = $('transfersOverview');
    const transfers = calculateJointBillTransfers();
    
    if (transfers.length === 0 || data.people.length <= 1 || !data.bills.some(b => b.billType === 'joint' && !b.isDeleted)) {
        transfersOverview.style.display = 'none';
        return;
    }
    
    transfersOverview.style.display = 'grid';
    transfersOverview.innerHTML = '';
    
    if (data.people.length === 2) {
        data.people.forEach(person => {
            const personTransfers = transfers.filter(t => t.from === person.name);
            const card = document.createElement('div');
            card.className = 'payment-transfers';
            card.innerHTML = `<h3>${person.name}'s Monthly Transfers</h3>`;
            
            if (personTransfers.length === 0) {
                card.innerHTML += '<p>No transfers required this month.</p>';
            } else {
                let totalAmount = 0;
                
                personTransfers.forEach(t => {
                    const transferItem = document.createElement('div');
                    transferItem.className = 'transfer-item';
                    transferItem.innerHTML = `
                        <span>Send to ${t.to}</span>
                        <span>${formatCurrency(t.amount)}</span>
                    `;
                    card.appendChild(transferItem);
                    totalAmount += t.amount;
                });
                
                if (personTransfers.length > 1) {
                    const totalItem = document.createElement('div');
                    totalItem.className = 'transfer-item';
                    totalItem.style.fontWeight = '600';
                    totalItem.innerHTML = `
                        <span>Total</span>
                        <span>${formatCurrency(totalAmount)}</span>
                    `;
                    card.appendChild(totalItem);
                }
            }
            
            transfersOverview.appendChild(card);
        });
    } else {
        const card = document.createElement('div');
        card.className = 'payment-transfers';
        card.innerHTML = '<h3>Monthly Required Transfers</h3>';
        
        const transfersByPerson = {};
        
        transfers.forEach(t => {
            if (!transfersByPerson[t.from]) {
                transfersByPerson[t.from] = [];
            }
            transfersByPerson[t.from].push(t);
        });
        
        Object.keys(transfersByPerson).forEach(fromPerson => {
            const personTransfers = transfersByPerson[fromPerson];
            let totalAmount = 0;
            
            personTransfers.forEach(t => {
                const transferItem = document.createElement('div');
                transferItem.className = 'transfer-item';
                transferItem.innerHTML = `
                    <span>${t.from} sends to ${t.to}</span>
                    <span>${formatCurrency(t.amount)}</span>
                `;
                card.appendChild(transferItem);
                totalAmount += t.amount;
            });
            
            if (personTransfers.length > 1) {
                const totalItem = document.createElement('div');
                totalItem.className = 'transfer-item';
                totalItem.style.fontWeight = '600';
                totalItem.innerHTML = `
                    <span>${fromPerson} Total</span>
                    <span>${formatCurrency(totalAmount)}</span>
                `;
                card.appendChild(totalItem);
            }
            
            if (Object.keys(transfersByPerson).length > 1 && fromPerson !== Object.keys(transfersByPerson)[Object.keys(transfersByPerson).length - 1]) {
                const spacerItem = document.createElement('div');
                spacerItem.style.height = '16px';
                card.appendChild(spacerItem);
            }
        });
        
        transfersOverview.appendChild(card);
    }
}

function createPersonTab(person) {
    if (!person || !person.id || !person.name) return;
    
    const existingTab = document.querySelector(`button.tab[data-person-id="${person.id}"]`);
    if (existingTab) return;
    
    const tabsContainer = $('tabsContainer');
    const historyTab = document.querySelector('.tab[data-tab="history"]');
    
    const tab = document.createElement('button');
    tab.className = 'tab';
    tab.textContent = person.name;
    tab.dataset.personId = person.id;
    tab.addEventListener('click', () => showTab(`person-${person.id}`));
    
    tabsContainer.insertBefore(tab, historyTab);
    
    const content = document.createElement('div');
    content.id = `person-${person.id}`;
    content.className = 'tab-content';
    
    const userSettingsHTML = `
        <div class="card">
            <h3>${person.name} - User Settings</h3>
            <div class="form-group">
                <label for="name-${person.id}">Name</label>
                <input type="text" id="name-${person.id}" value="${person.name}">
            </div>
            <div style="display:flex;gap:10px;margin-top:20px;">
                <button onclick="updatePersonBasic(${person.id})" style="flex:1;">Update Name</button>
                <button onclick="showColorModal(${person.id})" style="flex:1; background-color: ${person.color || colorPalette[0].value}; color: #ffffff;">Change Colour</button>
                <button onclick="deletePerson(${person.id})" class="btn-danger" style="flex:1;">Delete</button>
            </div>
        </div>
    `;
    
    const incomeHTML = `
        <div class="card">
            <h3>${person.name} - Income</h3>
            <div class="form-group">
                <label for="income-${person.id}">Income Amount</label>
                <input type="number" id="income-${person.id}" value="${person.income || 0}" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label for="frequency-${person.id}">Payment Frequency</label>
                <select id="frequency-${person.id}">
                    <option value="biweekly"${person.frequency === 'biweekly' ? ' selected' : ''}>Biweekly</option>
                    <option value="monthly"${person.frequency === 'monthly' ? ' selected' : ''}>Monthly</option>
                    <option value="quarterly"${person.frequency === 'quarterly' ? ' selected' : ''}>Quarterly</option>
                    <option value="yearly"${person.frequency === 'yearly' ? ' selected' : ''}>Yearly</option>
                </select>
            </div>
            <div class="form-group">
                <label for="paymentDate-${person.id}">Payment Date</label>
                <input type="date" id="paymentDate-${person.id}" value="${person.paymentDate || ''}">
            </div>
            <div class="form-group">
                <label for="employer-${person.id}">Employer (Optional)</label>
                <input type="text" id="employer-${person.id}" value="${person.employer || ''}" placeholder="Company name">
            </div>
            <button onclick="updatePersonIncome(${person.id})">Update Income</button>
            <p style="font-size:12px;color:#666;margin-top:10px;">Future pay days will be automatically logged. Changing the income amount, frequency, or payday will affect the current month and future months.</p>
        </div>
    `;
    
    const savingsExpensesHTML = `
        <div class="card">
            <h3>${person.name} - Ongoing Monthly Goals</h3>
            <div class="form-group">
                <label for="savings-${person.id}">Monthly Savings Goal</label>
                <input type="number" id="savings-${person.id}" value="${person.savings || 0}" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label for="expenses-${person.id}">Monthly Expenses</label>
                <p style="font-size:12px;color:#666;margin-top:10px;">This is how much you should leave in your main account to spend on Food, Petrol, Clothes etc.</p>
                <div style="height:10px;"></div>
                <input type="number" id="expenses-${person.id}" value="${person.expenses || 0}" placeholder="0.00" step="0.01">
            </div>
            <button onclick="updatePersonSavingsExpenses(${person.id})">Update Monthly Goals</button>
            <p style="font-size:12px;color:#666;margin-top:10px;">These goals will continue each month unless you update them.</p>
        </div>
    `;
    
    const paycheckHTML = `
        <div class="card">
            <h3>${person.name} - Add Historical Salary</h3>
            <div class="form-group">
                <label for="paycheckAmount-${person.id}">Paycheck Amount</label>
                <input type="number" id="paycheckAmount-${person.id}" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label for="paycheckDate-${person.id}">Date</label>
                <input type="date" id="paycheckDate-${person.id}">
            </div>
            <div class="form-group">
                <label for="paycheckEmployer-${person.id}">Employer (Optional)</label>
                <input type="text" id="paycheckEmployer-${person.id}" placeholder="Company name">
            </div>
            <button onclick="addPaycheck(${person.id})" class="add-paycheck-btn">Add Salary Entry</button>
            <p style="font-size:12px;color:#666;margin-top:10px;">These are stored in the Income History below and the History tab.</p>
        </div>
    `;
    
    const bonusHTML = `
        <div class="card">
            <h3>${person.name} - Add One-time Bonus</h3>
            <div class="form-group">
                <label for="bonusAmount-${person.id}">Bonus Amount</label>
                <input type="number" id="bonusAmount-${person.id}" placeholder="0.00" step="0.01">
            </div>
            <div class="form-group">
                <label for="bonusDate-${person.id}">Date Received</label>
                <input type="date" id="bonusDate-${person.id}">
            </div>
            <div class="form-group">
                <label for="bonusEmployer-${person.id}">Source (Optional)</label>
                <input type="text" id="bonusEmployer-${person.id}" placeholder="Company or source">
            </div>
            <button onclick="addBonus(${person.id})" class="add-bonus-btn">Add One-time Bonus</button>
            <p style="font-size:12px;color:#666;margin-top:10px;">Bonuses are a one-time addition and will affect the total income for the month they were received.</p>
        </div>
    `;
    
    content.innerHTML = userSettingsHTML + incomeHTML + savingsExpensesHTML + paycheckHTML + bonusHTML + createYearlyIncomeView(person.id);
    document.querySelector('.container').appendChild(content);
    
    const changeColorBtn = content.querySelector(`button[onclick*="showColorModal"]`);
    if (changeColorBtn && person.color) {
        changeColorBtn.style.backgroundColor = person.color;
        changeColorBtn.style.color = '#ffffff';
    }
    
    const personTab = document.querySelector(`button.tab[data-person-id="${person.id}"]`);
    if (personTab && person.color) {
        if (personTab.classList.contains('active')) {
            personTab.style.backgroundColor = person.color;
            personTab.style.color = '#ffffff';
        } else {
            personTab.style.backgroundColor = '';
            personTab.style.color = '';
        }
    }
    
    updatePersonOverview(person.id);
}

function updatePersonBasic(personId) {
    const person = data.people.find(p => p.id === personId);
    if (!person) return;
    
    const oldName = person.name;
    const name = $(`name-${personId}`).value.trim();
    
    if (!name) {
        alert('Name is required');
        return;
    }
    
    if (data.people.some(p => p.id !== personId && p.name.toLowerCase() === name.toLowerCase())) {
        alert('A person with this name already exists!');
        return;
    }
    
    person.name = name;
    
    data.eventHistory.push({
        id: nextEventId++,
        date: new Date().toISOString().split('T')[0],
        event: 'Person Updated',
        description: `Updated ${name}'s basic settings`
    });
    
    saveDataToLocalStorage();
    updateGreeting();
    updateBillPayerOptions();
    updateHistoryDisplay();
    updateOverview();
    
    const personalTab = document.querySelector(`button.tab[data-person-id="${personId}"]`);
    if (personalTab) personalTab.textContent = name;
    
    const h3Elements = document.querySelectorAll(`#person-${personId} h3`);
    h3Elements.forEach(h3 => {
        if (h3.textContent.includes(' - ')) {
            const parts = h3.textContent.split(' - ');
            h3.textContent = `${name} - ${parts[1]}`;
        }
    });
}

function attachPersonEventListeners() {
    document.querySelectorAll('.tab[data-person-id]').forEach(tab => {
        if (!tab.onclick && !tab.hasEventListener) {
            const personId = tab.dataset.personId;
            tab.addEventListener('click', () => showTab(`person-${personId}`));
            tab.hasEventListener = true;
        }
    });
    
    data.people.forEach(person => {
        const personId = person.id;
        
        const updateBasicBtn = $(`updateBasicBtn${personId}`);
        if (updateBasicBtn && !updateBasicBtn.onclick) {
            updateBasicBtn.onclick = () => updatePersonBasic(personId);
        }
        
        const updateIncomeBtn = $(`updateIncomeBtn${personId}`);
        if (updateIncomeBtn && !updateIncomeBtn.onclick) {
            updateIncomeBtn.onclick = () => updatePersonIncome(personId);
        }
        
        const updateSavingsExpensesBtn = $(`updateSavingsExpensesBtn${personId}`);
        if (updateSavingsExpensesBtn && !updateSavingsExpensesBtn.onclick) {
            updateSavingsExpensesBtn.onclick = () => updatePersonSavingsExpenses(personId);
        }
        
        const deletePersonBtn = $(`deletePersonBtn${personId}`);
        if (deletePersonBtn && !deletePersonBtn.onclick) {
            deletePersonBtn.onclick = () => deletePerson(personId);
        }
        
        const addPaycheckBtn = $(`addPaycheckBtn${personId}`);
        if (addPaycheckBtn && !addPaycheckBtn.onclick) {
            addPaycheckBtn.onclick = () => addPaycheck(personId);
        }
        
        const addBonusBtn = $(`addBonusBtn${personId}`);
        if (addBonusBtn && !addBonusBtn.onclick) {
            addBonusBtn.onclick = () => addBonus(personId);
        }
    });
}

function updateOneOffOverview() {
    const oneOffList = $('oneOffList');
    const oneOffOverview = $('oneOffOverview');
    const today = new Date();
    const currentMonth = today.getMonth();
    const currentYear = today.getFullYear();
    
    const oneOffExpenses = data.bills.filter(b => 
        b.isOneOff && 
        !b.isDeleted && 
        (() => {
            const billDate = new Date(b.date);
            return billDate.getMonth() === currentMonth && billDate.getFullYear() === currentYear;
        })()
    );

    if (oneOffExpenses.length === 0) {
        oneOffOverview.style.display = 'none';
        return;
    }

    oneOffOverview.style.display = 'block';
    oneOffList.innerHTML = '';

    if (data.people.length <= 1) {
        oneOffExpenses.forEach(expense => {
            oneOffList.appendChild(createOneOffItem(expense));
        });
        return;
    }

    const jointOneOffs = oneOffExpenses.filter(e => e.billType === 'joint');
    const individualOneOffs = oneOffExpenses.filter(e => e.billType === 'individual');

    if (jointOneOffs.length > 0) {
        const jointGroup = document.createElement('div');
        jointGroup.className = 'bills-group';
        jointGroup.innerHTML = '<div class="bills-group-header">Joint One-off Expenses</div>';
        
        jointOneOffs.forEach(expense => {
            jointGroup.appendChild(createOneOffItem(expense));
        });
        
        oneOffList.appendChild(jointGroup);
    }

    const peopleWithOneOffs = data.people.filter(person => 
        individualOneOffs.some(expense => expense.payer === person.id)
    );

    peopleWithOneOffs.forEach(person => {
        const personOneOffs = individualOneOffs.filter(expense => expense.payer === person.id);
        
        if (personOneOffs.length > 0) {
            const personGroup = document.createElement('div');
            personGroup.className = 'bills-group';
            personGroup.innerHTML = `<div class="bills-group-header">${person.name}'s One-off Expenses</div>`;
            
            personOneOffs.forEach(expense => {
                personGroup.appendChild(createOneOffItem(expense));
            });
            
            oneOffList.appendChild(personGroup);
        }
    });
}

function createOneOffItem(expense) {
    const payerName = expense.payer === 'joint' ? 'Joint' : 
                     data.people.find(p => p.id === expense.payer)?.name || 'Unknown';
    
    const oneOffItem = document.createElement('div');
    oneOffItem.className = 'debt-item';
    
    let itemContent = `
        <div class="info-item">
            <span class="info-label">${expense.name}</span>
            <span class="info-value">${formatCurrency(expense.amount)}</span>
        </div>
    `;
    
    if (data.people.length > 1) {
        itemContent += `
            <div class="info-item">
                <span class="info-label">Paid by</span>
                <span class="info-value">${payerName}</span>
            </div>
        `;
    }
    
    oneOffItem.innerHTML = itemContent;
    return oneOffItem;
}

function attachEventListeners() {
    loadData();
    updateGreeting();
    updateBillPayerOptions();
    updateBillsList();
    updateHistoryDisplay();
    updateOverview();
    toggleBillTypeVisibility();
    
    data.people.forEach(person => createPersonTab(person));
    
    $('hamburgerBtn').addEventListener('click', toggleSidebar);
    $('addNewPersonBtn').addEventListener('click', addNewPerson);
    $('toggleDarkModeBtn').addEventListener('click', toggleDarkMode);
    $('currencySelect').addEventListener('change', updateCurrency);
    $('weightedBillsSidebar').addEventListener('change', updateWeightedBills);
    $('addBillBtn').addEventListener('click', addBill);
    $('isDebt').addEventListener('change', toggleDebtFields);
    $('billType').addEventListener('change', toggleBillPayerVisibility);
    $('billFrequency').addEventListener('change', toggleBillFrequencyOptions);
    $('fullResetBtn').addEventListener('click', fullReset);
    $('clearHistoryFiltersBtn').addEventListener('click', clearHistoryFilters);
    $('historyPersonFilter').addEventListener('change', updateHistoryDisplay);
    $('historyStartDate').addEventListener('change', updateHistoryDisplay);
    $('historyEndDate').addEventListener('change', updateHistoryDisplay);
    $('isOneOff').addEventListener('change', toggleOneOffFields);
    
    

    
    document.querySelectorAll('.tab').forEach(tab => {
        tab.addEventListener('click', () => {
            if (tab.dataset.tab === 'add-person') {
                addNewPerson();
                return;
            }
            const tabId = tab.dataset.tab || `person-${tab.dataset.personId}`;
            showTab(tabId);
        });
    });
    
    document.addEventListener('click', function(event) {
        const sidebar = $('sidebar');
        const hamburgerBtn = $('hamburgerBtn');
        
        if (sidebar.classList.contains('open')) {
            const isClickInsideSidebar = sidebar.contains(event.target);
            const isClickOnHamburgerBtn = hamburgerBtn.contains(event.target);
            
            if (!isClickInsideSidebar && !isClickOnHamburgerBtn) {
                sidebar.classList.remove('open');
            }
        }
    });
    
    updateTabsVisibility();
}

document.addEventListener('DOMContentLoaded', attachEventListeners);
</script>

</body></html>
