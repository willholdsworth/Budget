<html lang="en"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget Tracker</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@300;400;500;600;700&amp;display=swap">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Space Grotesk', monospace; background: #ffffff; min-height: 100vh; padding: 20px; color: #000000; transition: all 0.3s ease; }
        body.dark-mode { background: #000000; color: #ffffff; }
        .fixed-header { position: fixed; top: 0; left: 0; right: 0; background: #ffffff; padding: 20px; z-index: 1000; transition: all 0.3s ease; }
        body.dark-mode .fixed-header { background: #000000; }
        .header-content { max-width: 1000px; margin: 0 auto; display: flex; align-items: center; position: relative; }
        .header-left { position: absolute; left: 0; }
        .header-right { position: absolute; right: 0; }
        .greeting { font-size: 24px; font-weight: 300; letter-spacing: -0.02em; margin: 0 auto; text-align: center; flex-grow: 1; }
        .hamburger-btn, .save-btn { background: transparent; color: #000000; border: none; width: 50px; height: 50px; cursor: pointer; font-size: 24px; display: flex; align-items: center; justify-content: center; transition: all 0.3s ease; font-family: inherit; position: relative; z-index: 1100; }
        body.dark-mode .hamburger-btn, body.dark-mode .save-btn { color: #ffffff; }
        .hamburger-btn:hover, .save-btn:not(:disabled):hover { transform: scale(1.05); }
        .save-btn.changed { color: #ff0000; }
        .save-btn:disabled { cursor: not-allowed; opacity: 0.6; }
        .sidebar { position: fixed; top: 0; left: -250px; width: 250px; height: 100%; background: #ffffff; border-right: 2px solid #000000; padding: 80px 20px 20px; z-index: 1001; transition: left 0.3s ease; }
        body.dark-mode .sidebar { background: #000000; border-right-color: #ffffff; }
        .sidebar.open { left: 0; }
        .sidebar-menu { list-style: none; display: flex; flex-direction: column; gap: 10px; }
        .sidebar-menu li { width: 100%; }
        .sidebar-menu button, .sidebar-menu .currency-selector { width: 100%; padding: 12px 16px; border: 2px solid #000000; border-radius: 8px; font-size: 14px; background: #ffffff; font-family: inherit; transition: all 0.3s ease; color: #000000; cursor: pointer; text-align: left; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode .sidebar-menu button, body.dark-mode .sidebar-menu .currency-selector { border-color: #ffffff; background: #000000; color: #ffffff; }
        .sidebar-menu button:hover, .sidebar-menu .currency-selector:hover { background: #e8e8e8; color: #000000; }
        body.dark-mode .sidebar-menu button:hover, body.dark-mode .sidebar-menu .currency-selector:hover { background: #1a1a1a; color: #ffffff; }
        .sidebar-menu .checkbox-group { display: flex; align-items: center; gap: 8px; padding: 12px 16px; border: 2px solid #000000; border-radius: 8px; background: #ffffff; color: #000000; transition: all 0.3s ease; }
        body.dark-mode .sidebar-menu .checkbox-group { border-color: #ffffff; background: #000000; color: #ffffff; }
        .sidebar-menu .checkbox-group:hover { background: #e8e8e8; }
        body.dark-mode .sidebar-menu .checkbox-group:hover { background: #1a1a1a; }
        .sidebar-menu .checkbox-group input[type="checkbox"] { width: auto; margin: 0; }
        .sidebar-menu .checkbox-group label { color: #000000; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; cursor: pointer; }
        body.dark-mode .sidebar-menu .checkbox-group label { color: #ffffff; }
        .container { max-width: 1000px; margin: 80px auto 0; background: transparent; }
        .tabs { display: flex; background: #f5f5f5; border-radius: 12px; padding: 4px; margin-bottom: 32px; gap: 4px; }
        body.dark-mode .tabs { background: #0a0a0a; }
        .tab { flex: 1; padding: 12px 20px; text-align: center; cursor: pointer; background: transparent; border: none; border-radius: 8px; font-weight: 500; font-size: 14px; color: #666; transition: all 0.3s ease; font-family: inherit; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode .tab { color: #999; }
        .tab:hover { background: #e8e8e8; color: #000; }
        body.dark-mode .tab:hover { background: #1a1a1a; color: #fff; }
        .tab.active { color: #ffffff; background: #000000; }
        body.dark-mode .tab.active { color: #000000; background: #ffffff; }
        .tab-content { display: none; opacity: 0; transition: opacity 0.3s ease; }
        .tab-content.active { display: block; opacity: 1; }
        .card { background: #ffffff; border-radius: 16px; padding: 32px; margin-bottom: 24px; border: 2px solid #000000; }
        body.dark-mode .card { background: #000000; border-color: #ffffff; }
        .card h3, .card h4 { margin-bottom: 20px; color: #000000; font-size: 18px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        body.dark-mode .card h3, body.dark-mode .card h4 { color: #ffffff; }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 6px; font-weight: 500; color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode label { color: #999; }
        input, select, textarea { width: 100%; padding: 12px 16px; border: 2px solid #000000; border-radius: 8px; font-size: 14px; background: #ffffff; font-family: inherit; transition: all 0.3s ease; color: #000000; }
        body.dark-mode input, body.dark-mode select, body.dark-mode textarea { border-color: #ffffff; background: #000000; color: #ffffff; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #666; }
        button { background: #000000; color: #ffffff; border: none; padding: 12px 24px; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 600; transition: all 0.3s ease; font-family: inherit; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode button { background: #ffffff; color: #000000; }
        button:hover { transform: translateY(-1px); opacity: 0.8; }
        .btn-danger { background: #000000; color: #ffffff; }
        .btn-small { padding: 6px 12px; font-size: 12px; }
        .overview-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 32px; }
        .stat-card { background: #ffffff; border-radius: 12px; padding: 24px; text-align: center; border: 2px solid #000000; }
        body.dark-mode .stat-card { background: #000000; border-color: #ffffff; }
        .stat-value { font-size: 24px; font-weight: 600; margin-bottom: 8px; color: #000000; }
        body.dark-mode .stat-value { color: #ffffff; }
        .stat-label { color: #666; font-size: 14px; font-weight: 500; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode .stat-label { color: #999; }
        .person-overview { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 24px; }
        .person-card { padding: 24px; border-radius: 12px; background: #ffffff; border: 2px solid #000000; }
        body.dark-mode .person-card { background: #000000; border-color: #ffffff; }
        .person-card h3 { color: #000000; margin-bottom: 16px; font-size: 16px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode .person-card h3 { color: #ffffff; }
        .person-info { display: grid; gap: 12px; }
        .info-item { display: flex; justify-content: space-between; padding: 8px 0; }
        .info-label { font-weight: 500; color: #666; font-size: 14px; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode .info-label { color: #999; }
        .info-value { font-weight: 600; color: #000000; font-size: 14px; }
        body.dark-mode .info-value { color: #ffffff; }
        .bill-item { background: #ffffff; border-radius: 8px; padding: 16px; margin-bottom: 12px; display: flex; justify-content: space-between; align-items: center; border: 2px solid #000000; }
        body.dark-mode .bill-item { background: #000000; border-color: #ffffff; }
        .bill-info { flex: 1; }
        .bill-info strong { font-size: 14px; color: #000000; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode .bill-info strong { color: #ffffff; }
        .bill-info small { color: #666; font-size: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode .bill-info small { color: #999; }
        .bill-actions { display: flex; gap: 8px; }
        .payment-transfers { background: #f5f5f5; border-radius: 12px; padding: 20px; margin-top: 16px; border: 2px solid #000000; }
        body.dark-mode .payment-transfers { background: #0a0a0a; border-color: #ffffff; }
        .transfer-item { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #000000; }
        body.dark-mode .transfer-item { border-bottom-color: #ffffff; }
        .transfer-item:last-child { border-bottom: none; }
        .debt-overview { background: #f5f5f5; border-radius: 8px; padding: 16px; margin-top: 16px; border: 1px solid #000000; }
        body.dark-mode .debt-overview { background: #0a0a0a; border-color: #ffffff; }
        .history-table { width: 100%; border-collapse: collapse; margin-top: 20px; background: #ffffff; border-radius: 8px; overflow: hidden; border: 2px solid #000000; }
        body.dark-mode .history-table { background: #000000; border-color: #ffffff; }
        .history-table th, .history-table td { padding: 12px 16px; text-align: left; border-bottom: 1px solid #000000; font-size: 14px; }
        body.dark-mode .history-table th, body.dark-mode .history-table td { border-color: #ffffff; }
        .history-table th { background: #000000; font-weight: 600; color: #ffffff; text-transform: uppercase; letter-spacing: 0.5px; }
        body.dark-mode .history-table th { background: #ffffff; color: #000000; }
        .red { color: #ff0000 !important; }
        .green { color: #00ff00 !important; }
        .checkbox-group { display: flex; align-items: center; gap: 8px; margin-bottom: 20px; }
        .checkbox-group input[type="checkbox"] { width: auto; margin: 0; }
        @media (max-width: 768px) {
            .tabs { flex-wrap: wrap; }
            .overview-grid, .person-overview { grid-template-columns: 1fr; }
            .greeting { font-size: 20px; }
            .hamburger-btn, .save-btn { width: 45px; height: 45px; font-size: 20px; }
        }
    </style>
</head>
<body>
    <div class="fixed-header">
        <div class="header-content">
            <div class="header-left">
                <button id="hamburgerBtn" class="hamburger-btn">â˜°</button>
            </div>
            <div class="greeting" id="greeting">Hello, Will!</div>
            <div class="header-right">
                <button id="saveBtn" class="save-btn changed" title="Save Budget">ðŸ’¾</button>
            </div>
        </div>
        <div id="sidebar" class="sidebar">
            <ul class="sidebar-menu">
                <li><button id="addNewPersonBtn">Add New User</button></li>
                <li class="checkbox-group">
                    <input type="checkbox" id="weightedBillsSidebar">
                    <label for="weightedBillsSidebar">Weight Bills By Income</label>
                </li>
                <li>
                    <select id="currencySelect" class="currency-selector">
                        <option value="USD">$USD</option>
                        <option value="EUR">â‚¬EUR</option>
                        <option value="GBP">Â£GBP</option>
                        <option value="JPY">Â¥JPY</option>
                        <option value="CAD">$CAD</option>
                    </select>
                </li>
                <li><button id="toggleDarkModeBtn">Dark Mode</button></li>
            </ul>
        </div>
    </div>
    <div class="container">
        <div class="tabs" id="tabsContainer">
            <button class="tab" data-tab="overview">Overview</button>
            <button class="tab" data-tab="bills">Bills</button>
            <button class="tab" data-tab="history">History</button>
        <button class="tab active" data-person-id="1">Will</button></div>
        <div id="overview" class="tab-content" style="opacity: 0;">
            <div class="overview-grid">
                <div class="stat-card">
                    <div class="stat-value" id="totalIncome">$0.00</div>
                    <div class="stat-label">Total Income</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalBills">$0.00</div>
                    <div class="stat-label">Total Bills</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalSavings">$0.00</div>
                    <div class="stat-label">Total Savings</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="totalLeftover">$0.00</div>
                    <div class="stat-label">Leftover</div>
                </div>
            </div>
            <div id="peopleOverview" class="person-overview"><div class="person-card">
                    <h3>Will</h3>
                    <div class="person-info">
                        <div class="info-item">
                            <span class="info-label">Monthly Income</span>
                            <span class="info-value">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Monthly Savings</span>
                            <span class="info-value">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Monthly Expenses</span>
                            <span class="info-value">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Individual Bills</span>
                            <span class="info-value">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Joint Bills Share</span>
                            <span class="info-value">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Net Monthly</span>
                            <span class="info-value">$0.00</span>
                        </div>
                    </div></div></div>
            <div id="debtOverview" class="card" style="display: none;">
                <h3>Debt Overview</h3>
                <div id="debtsList"></div>
            </div>
            <div id="transfersOverview" class="card" style="display: none;">
                <h3>Required Transfers</h3>
                <div id="transfersList"></div>
            </div>
        </div>
        <div id="bills" class="tab-content" style="opacity: 0;">
            <div class="card">
                <h3>Add New Bill</h3>
                <div class="form-group">
                    <label for="billName">Bill Name</label>
                    <input type="text" id="billName" placeholder="Enter bill name">
                </div>
                <div class="form-group">
                    <label for="billAmount">Amount</label>
                    <input type="number" id="billAmount" placeholder="0.00" step="0.01">
                </div>
                <div class="form-group">
                    <label for="billFrequency">Frequency</label>
                    <select id="billFrequency">
                        <option value="weekly">Weekly</option>
                        <option value="monthly" selected="">Monthly</option>
                        <option value="quarterly">Quarterly</option>
                        <option value="yearly">Yearly</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="billDate">Due Date</label>
                    <input type="date" id="billDate">
                </div>
                <div class="form-group">
                    <label for="billCategory">Category</label>
                    <select id="billCategory">
                        <option value="Utilities">Utilities</option>
                        <option value="Groceries">Groceries</option>
                        <option value="Housing">Housing</option>
                        <option value="Transportation">Transportation</option>
                        <option value="Insurance">Insurance</option>
                        <option value="Entertainment">Entertainment</option>
                        <option value="Mortgage">Mortgage</option>
                        <option value="Loan">Loan</option>
                        <option value="Credit Card">Credit Card</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="billType">Bill Type</label>
                    <select id="billType">
                        <option value="individual">Individual</option>
                        <option value="joint">Joint</option>
                    </select>
                </div>
                <div class="form-group" id="billPayerGroup">
                    <label for="billPayer">Paid By</label>
                    <select id="billPayer"><option value="1">Will</option></select>
                </div>
                <div id="debtFields" style="display: none;">
                    <div class="form-group">
                        <label for="totalDebt">Total Debt Amount</label>
                        <input type="number" id="totalDebt" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="interestRate">Interest Rate (%)</label>
                        <input type="number" id="interestRate" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="termYears">Term Length (Years)</label>
                        <input type="number" id="termYears" placeholder="30" min="0">
                    </div>
                    <div class="form-group">
                        <label for="termMonths">Additional Months</label>
                        <input type="number" id="termMonths" placeholder="0" min="0" max="11">
                    </div>
                    <div class="form-group">
                        <label for="overpayment">Monthly Overpayment</label>
                        <input type="number" id="overpayment" placeholder="0.00" step="0.01">
                    </div>
                </div>
                <div id="mortgageFields" style="display: none;">
                    <div class="form-group">
                        <label for="rateExpiry">Rate Expiry Date</label>
                        <input type="date" id="rateExpiry">
                    </div>
                </div>
                <button id="addBillBtn">Add Bill</button>
            </div>
            <div class="card">
                <h3>All Bills</h3>
                <div id="billsList"></div>
            </div>
        </div>
        <div id="history" class="tab-content" style="opacity: 0;">
            <div class="card">
                <h3>Income &amp; Salary History</h3>
                <div class="form-group">
                    <label for="historyPersonFilter">Filter by Person</label>
                    <select id="historyPersonFilter">
                        <option value="all">All People</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="historyStartDate">Start Date</label>
                    <input type="date" id="historyStartDate">
                </div>
                <div class="form-group">
                    <label for="historyEndDate">End Date</label>
                    <input type="date" id="historyEndDate">
                </div>
                <button id="clearHistoryFiltersBtn">Clear Filters</button>
                <button id="fullResetBtn" class="btn-danger">Full Reset</button>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Person</th>
                            <th>Type</th>
                            <th>Amount</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="incomeHistoryList"><tr><td colspan="6" style="text-align: center; padding: 8px;">No income history available.</td></tr></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Bill History</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Action</th>
                            <th>Bill Name</th>
                            <th>Amount</th>
                            <th>Category</th>
                            <th>Type</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="billHistoryList"><tr><td colspan="7" style="text-align: center; padding: 8px;">No bill history available.</td></tr></tbody>
                </table>
            </div>
            <div class="card">
                <h3>Event History</h3>
                <table class="history-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Event</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="eventHistoryList"><tr>
                    <td>2025-06-23</td>
                    <td>Person Added</td>
                    <td>Added Will to budget tracker</td>
                    <td>-</td></tr></tbody>
                </table>
            </div>
        </div>
    <div id="person-1" class="tab-content active" style="opacity: 1;">
                <div class="card">
                    <h3>Will - Settings</h3>
                    <div class="form-group">
                        <label for="person1Name">Name</label>
                        <input type="text" id="name-1" value="Will">
                    </div>
                    <div class="form-group">
                        <label for="person1Income">Income Amount</label>
                        <input type="number" id="income-1" value="0" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="person1Frequency">Payment Frequency</label>
                        <select id="frequency-1">
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected="">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="person1Savings">Monthly Savings Goal</label>
                        <input type="number" id="savings-1" value="0" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="person1Expenses">Monthly Expenses</label>
                        <input type="number" id="expenses-1" value="0" placeholder="0.00" step="0.01">
                    </div>
                </div>
            
                <div class="card">
                    <h3>Will - Paycheck History</h3>
                    <div class="form-group">
                        <label for="paycheck1Amount">Paycheck Amount</label>
                        <input type="number" id="paycheckAmount-1" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="paycheck1Date">Date</label>
                        <input type="date" id="paycheckDate-1">
                    </div>
                    <div class="form-group">
                        <label for="paycheck1Description">Description (optional)</label>
                        <textarea id="paycheckDescription-1" placeholder="e.g., Regular paycheck"></textarea>
                    </div>
                    <button id="addPaycheckBtn1" class="add-paycheck-btn">Add Paycheck</button>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paycheckHistory-1"><tr><td colspan="4" style="text-align: center; padding: 8px;">No paychecks recorded.</td></tr></tbody>
                    </table>
                </div>
            
                <div class="card">
                    <h3>Will - Bonus</h3>
                    <div class="form-group">
                        <label for="bonus1Amount">Bonus Amount</label>
                        <input type="number" id="bonusAmount-1" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="bonus1Date">Date</label>
                        <input type="date" id="bonusDate-1">
                    </div>
                    <div class="form-group">
                        <label for="bonus1Description">Description (optional)</label>
                        <textarea id="bonusDescription-1" placeholder="e.g., Performance bonus"></textarea>
                    </div>
                    <button id="addBonusBtn1" class="add-bonus-btn">Add Bonus</button>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bonusHistory-1"><tr><td colspan="4" style="text-align: center; padding: 8px;">No bonuses recorded.</td></tr></tbody>
                    </table>
                </div>
            
                <div class="card">
                    <h3>Will - Overview</h3>
                    <div class="person-info">
                        <div class="info-item">
                            <span class="info-label">Monthly Income</span>
                            <span class="info-value" id="monthlyIncome-1">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Monthly Savings</span>
                            <span class="info-value" id="monthlySavings-1">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Monthly Expenses</span>
                            <span class="info-value" id="monthlyExpenses-1">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Individual Bills</span>
                            <span class="info-value" id="individualBills-1">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Joint Bills Share</span>
                            <span class="info-value" id="jointBillsShare-1">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Required Transfers</span>
                            <span class="info-value" id="requiredTransfers-1">$0.00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Net Monthly</span>
                            <span class="info-value" id="netMonthly-1">$0.00</span>
                        </div>
                    </div>
                    <div id="debtOverview-1"></div>
                </div>
            
                <div class="card">
                    
                </div>
            </div></div>
    <script id="embedded-data" type="application/json">{
  "people": [
    {
      "id": 1,
      "name": "Will",
      "income": 0,
      "frequency": "monthly",
      "savings": 0,
      "expenses": 0
    }
  ],
  "bills": [],
  "currency": "USD",
  "darkMode": false,
  "weightedBills": false,
  "nextPersonId": 2,
  "nextBillId": 1,
  "nextIncomeId": 1,
  "nextEventId": 2,
  "nextPaycheckId": 1,
  "paycheckHistory": [],
  "billHistory": [],
  "eventHistory": [
    {
      "id": 1,
      "date": "2025-06-23",
      "event": "Person Added",
      "description": "Added Will to budget tracker"
    }
  ]
}</script>
    <script>
        let data = {};
        let nextPersonId = 1;
        let nextBillId = 1;
        let nextIncomeId = 1;
        let nextEventId = 1;
        let nextPaycheckId = 1;
        let hasChanges = false;
        let originalData = {};
        const STORAGE_KEY = 'budgetTrackerData';
        const $ = id => document.getElementById(id);

        function toggleSidebar() {
            $('sidebar').classList.toggle('open');
        }

        function markAsChanged() {
            hasChanges = true;
            const saveBtn = $('saveBtn');
            saveBtn.disabled = false;
            saveBtn.classList.add('changed');
        }

        function clearChanges() {
            hasChanges = false;
            const saveBtn = $('saveBtn');
            saveBtn.disabled = true;
            saveBtn.classList.remove('changed');
            originalData = JSON.parse(JSON.stringify(data));
        }

        function loadData() {
            try {
                const storedData = localStorage.getItem(STORAGE_KEY);
                if (storedData) {
                    data = JSON.parse(storedData);
                } else {
                    const embeddedScript = $('embedded-data');
                    data = JSON.parse(embeddedScript.textContent);
                }
                nextPersonId = data.nextPersonId || 1;
                nextBillId = data.nextBillId || 1;
                nextIncomeId = data.nextIncomeId || 1;
                nextEventId = data.nextEventId || 1;
                nextPaycheckId = data.nextPaycheckId || 1;
                if (data.darkMode) document.body.classList.add('dark-mode');
                $('currencySelect').value = data.currency || 'USD';
                $('weightedBillsSidebar').checked = data.weightedBills || false;
                originalData = JSON.parse(JSON.stringify(data));
            } catch (e) {
                data = {
                    people: [],
                    bills: [],
                    currency: "USD",
                    darkMode: false,
                    weightedBills: false,
                    nextPersonId: 1,
                    nextBillId: 1,
                    nextIncomeId: 1,
                    nextEventId: 1,
                    nextPaycheckId: 1,
                    paycheckHistory: [],
                    billHistory: [],
                    eventHistory: []
                };
                originalData = JSON.parse(JSON.stringify(data));
                saveDataToLocalStorage();
            }
        }

        function saveDataToLocalStorage() {
            try {
                data.nextPersonId = nextPersonId;
                data.nextBillId = nextBillId;
                data.nextIncomeId = nextIncomeId;
                data.nextEventId = nextEventId;
                data.nextPaycheckId = nextPaycheckId;
                localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
                markAsChanged();
            } catch (e) {
                console.error('Failed to save to local storage:', e);
            }
        }

        function saveDataToEmbedded() {
            try {
                data.nextPersonId = nextPersonId;
                data.nextBillId = nextBillId;
                data.nextIncomeId = nextIncomeId;
                data.nextEventId = nextEventId;
                data.nextPaycheckId = nextPaycheckId;
                const embeddedScript = $('embedded-data');
                embeddedScript.textContent = JSON.stringify(data, null, 2);
                const htmlContent = document.documentElement.outerHTML;
                const fileName = window.location.pathname.split('/').pop() || 'BUDGET.html';
                const blob = new Blob([htmlContent], { type: 'text/html' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                clearChanges();
                saveDataToLocalStorage();
            } catch (e) {
                console.error('Failed to save file:', e);
                alert('Failed to save file. Please try again.');
            }
        }

        function updateGreeting() {
            const names = data.people.map(p => p.name).join(' & ');
            $('greeting').textContent = names ? `Hello, ${names}!` : 'Hello, Welcome!';
        }

        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            data.darkMode = document.body.classList.contains('dark-mode');
            saveDataToLocalStorage();
        }

        function updateCurrency() {
            data.currency = $('currencySelect').value;
            saveDataToLocalStorage();
            updateOverview();
            data.people.forEach(p => updatePersonOverview(p.id));
        }

        function updateWeightedBills() {
            data.weightedBills = $('weightedBillsSidebar').checked;
            saveDataToLocalStorage();
            updateOverview();
        }

        function addNewPerson() {
            const name = prompt('Enter new person\'s name:').trim();
            if (!name) return;
            if (data.people.some(p => p.name.toLowerCase() === name.toLowerCase())) {
                alert('A person with this name already exists!');
                return;
            }
            const newPerson = {
                id: nextPersonId++,
                name: name,
                income: 0,
                frequency: 'monthly',
                savings: 0,
                expenses: 0
            };
            data.people.push(newPerson);
            data.eventHistory.push({
                id: nextEventId++,
                date: new Date().toISOString().split('T')[0],
                event: 'Person Added',
                description: `Added ${name} to budget tracker`
            });
            saveDataToLocalStorage();
            createPersonTab(newPerson);
            updateGreeting();
            updateBillPayerOptions();
            updateHistoryDisplay();
            updateOverview();
        }

        function frequencyToMonthly(amount, frequency) {
            switch (frequency) {
                case 'weekly': return amount * 52 / 12;
                case 'quarterly': return amount * 4 / 12;
                case 'yearly': return amount / 12;
                default: return amount;
            }
        }

        function calculateMonthlyBudget(person) {
            return frequencyToMonthly(person.income, person.frequency);
        }

        function getCurrentMonthRange() {
            const now = new Date();
            const start = new Date(now.getFullYear(), now.getMonth(), 1);
            const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            return { startDate: start, endDate: end };
        }

        function calculateIncomeRatio() {
            const totalIncome = data.people.reduce((sum, p) => sum + calculateMonthlyBudget(p), 0);
            return data.people.map(p => ({
                id: p.id,
                ratio: totalIncome ? calculateMonthlyBudget(p) / totalIncome : 1 / data.people.length
            }));
        }

        function formatCurrency(amount) {
            const formatter = new Intl.NumberFormat('en-US', {
                style: 'currency',
                currency: data.currency || 'USD'
            });
            return formatter.format(amount);
        }

        function createPersonTab(person) {
            if (!person || !person.id || !person.name) return;
            const existingTab = document.querySelector(`button.tab[data-person-id="${person.id}"]`);
            if (existingTab) return;
            const tabsContainer = $('tabsContainer');
            const tab = document.createElement('button');
            tab.className = 'tab';
            tab.textContent = person.name;
            tab.dataset.personId = person.id;
            tab.addEventListener('click', () => showTab(`person-${person.id}`));
            tabsContainer.appendChild(tab);
            const content = document.createElement('div');
            content.id = `person-${person.id}`;
            content.className = 'tab-content';
            const settingsHTML = `
                <div class="card">
                    <h3>${person.name} - Settings</h3>
                    <div class="form-group">
                        <label for="person${person.id}Name">Name</label>
                        <input type="text" id="name-${person.id}" value="${person.name}">
                    </div>
                    <div class="form-group">
                        <label for="person${person.id}Income">Income Amount</label>
                        <input type="number" id="income-${person.id}" value="${person.income || 0}" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="person${person.id}Frequency">Payment Frequency</label>
                        <select id="frequency-${person.id}">
                            <option value="weekly"${person.frequency === 'weekly' ? ' selected' : ''}>Weekly</option>
                            <option value="monthly"${person.frequency === 'monthly' ? ' selected' : ''}>Monthly</option>
                            <option value="quarterly"${person.frequency === 'quarterly' ? ' selected' : ''}>Quarterly</option>
                            <option value="yearly"${person.frequency === 'yearly' ? ' selected' : ''}>Yearly</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="person${person.id}Savings">Monthly Savings Goal</label>
                        <input type="number" id="savings-${person.id}" value="${person.savings || 0}" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="person${person.id}Expenses">Monthly Expenses</label>
                        <input type="number" id="expenses-${person.id}" value="${person.expenses || 0}" placeholder="0.00" step="0.01">
                    </div>
                </div>
            `;
            const paycheckHTML = `
                <div class="card">
                    <h3>${person.name} - Paycheck History</h3>
                    <div class="form-group">
                        <label for="paycheck${person.id}Amount">Paycheck Amount</label>
                        <input type="number" id="paycheckAmount-${person.id}" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="paycheck${person.id}Date">Date</label>
                        <input type="date" id="paycheckDate-${person.id}">
                    </div>
                    <div class="form-group">
                        <label for="paycheck${person.id}Description">Description (optional)</label>
                        <textarea id="paycheckDescription-${person.id}" placeholder="e.g., Regular paycheck"></textarea>
                    </div>
                    <button id="addPaycheckBtn${person.id}" class="add-paycheck-btn">Add Paycheck</button>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="paycheckHistory-${person.id}"></tbody>
                    </table>
                </div>
            `;
            const bonusHTML = `
                <div class="card">
                    <h3>${person.name} - Bonus</h3>
                    <div class="form-group">
                        <label for="bonus${person.id}Amount">Bonus Amount</label>
                        <input type="number" id="bonusAmount-${person.id}" placeholder="0.00" step="0.01">
                    </div>
                    <div class="form-group">
                        <label for="bonus${person.id}Date">Date</label>
                        <input type="date" id="bonusDate-${person.id}">
                    </div>
                    <div class="form-group">
                        <label for="bonus${person.id}Description">Description (optional)</label>
                        <textarea id="bonusDescription-${person.id}" placeholder="e.g., Performance bonus"></textarea>
                    </div>
                    <button id="addBonusBtn${person.id}" class="add-bonus-btn">Add Bonus</button>
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Amount</th>
                                <th>Description</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody id="bonusHistory-${person.id}"></tbody>
                    </table>
                </div>
            `;
            const overviewHTML = `
                <div class="card">
                    <h3>${person.name} - Overview</h3>
                    <div class="person-info">
                        <div class="info-item">
                            <span class="info-label">Monthly Income</span>
                            <span class="info-value" id="monthlyIncome-${person.id}">${formatCurrency(0)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Monthly Savings</span>
                            <span class="info-value" id="monthlySavings-${person.id}">${formatCurrency(0)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Monthly Expenses</span>
                            <span class="info-value" id="monthlyExpenses-${person.id}">${formatCurrency(0)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Individual Bills</span>
                            <span class="info-value" id="individualBills-${person.id}">${formatCurrency(0)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Joint Bills Share</span>
                            <span class="info-value" id="jointBillsShare-${person.id}">${formatCurrency(0)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Required Transfers</span>
                            <span class="info-value" id="requiredTransfers-${person.id}">${formatCurrency(0)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Net Monthly</span>
                            <span class="info-value" id="netMonthly-${person.id}">${formatCurrency(0)}</span>
                        </div>
                    </div>
                    <div id="debtOverview-${person.id}"></div>
                </div>
            `;
            const deleteHTML = `
                <div class="card">
                    ${data.people.length > 1 ? `<button id="deletePersonBtn${person.id}" class="btn-danger delete-person-btn">Delete ${person.name}</button>` : ''}
                </div>
            `;
            content.innerHTML = settingsHTML + paycheckHTML + bonusHTML + overviewHTML + deleteHTML;
            document.querySelector('.container').appendChild(content);
            const nameInput = $(`name-${person.id}`);
            const incomeInput = $(`income-${person.id}`);
            const frequencySelect = $(`frequency-${person.id}`);
            const savingsInput = $(`savings-${person.id}`);
            const expensesInput = $(`expenses-${person.id}`);
            const addPaycheckBtn = $(`addPaycheckBtn${person.id}`);
            const addBonusBtn = $(`addBonusBtn${person.id}`);
            const deletePersonBtn = $(`deletePersonBtn${person.id}`);
            if (nameInput) nameInput.addEventListener('change', () => updatePersonName(person.id));
            if (incomeInput) incomeInput.addEventListener('change', () => updatePersonData(person.id));
            if (frequencySelect) frequencySelect.addEventListener('change', () => updatePersonData(person.id));
            if (savingsInput) savingsInput.addEventListener('change', () => updatePersonData(person.id));
            if (expensesInput) expensesInput.addEventListener('change', () => updatePersonData(person.id));
            if (addPaycheckBtn) addPaycheckBtn.addEventListener('click', () => addPaycheck(person.id));
            if (addBonusBtn) addBonusBtn.addEventListener('click', () => addBonus(person.id));
            if (deletePersonBtn) deletePersonBtn.addEventListener('click', () => deletePerson(person.id));
            updatePersonOverview(person.id);
            updatePaycheckHistory(person.id);
            updateBonusHistory(person.id);
        }

        function updatePaycheckHistory(personId) {
            const tbody = $(`paycheckHistory-${personId}`);
            if (!tbody) return;
            tbody.innerHTML = '';
            const payments = data.paycheckHistory
                .filter(p => p.personId === personId && p.type === 'salary')
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            if (payments.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 8px;">No paychecks recorded.</td></tr>';
                return;
            }
            payments.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.date}</td>
                    <td>${formatCurrency(p.amount)}</td>
                    <td>${p.description || '-'}</td>
                    <td>
                        <button class="btn-danger btn-small" data-paycheck-id="${p.id}">Delete</button>
                    </td>`;
                row.querySelector('button').addEventListener('click', () => deletePaycheck(p.id));
                tbody.appendChild(row);
            });
        }

        function updateBonusHistory(personId) {
            const tbody = $(`bonusHistory-${personId}`);
            if (!tbody) return;
            tbody.innerHTML = '';
            const bonuses = data.paycheckHistory
                .filter(p => p.personId === personId && p.type === 'bonus')
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            if (bonuses.length === 0) {
                tbody.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 8px;">No bonuses recorded.</td></tr>';
                return;
            }
            bonuses.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.date}</td>
                    <td>${formatCurrency(p.amount)}</td>
                    <td>${p.description || '-'}</td>
                    <td>
                        <button class="btn-danger btn-small" data-paycheck-id="${p.id}">Delete</button>
                    </td>`;
                row.querySelector('button').addEventListener('click', () => deletePaycheck(p.id));
                tbody.appendChild(row);
            });
        }

        function addPaycheck(personId) {
            const amount = parseFloat($(`paycheckAmount-${personId}`).value) || 0;
            const date = $(`paycheckDate-${personId}`).value;
            const description = $(`paycheckDescription-${personId}`).value.trim();
            if (!amount || !date) {
                alert('Please fill in amount and date');
                return;
            }
            const person = data.people.find(p => p.id === personId);
            if (!person) return;
            data.paycheckHistory.push({
                id: nextPaycheckId++,
                personId: personId,
                personName: person.name,
                type: 'salary',
                amount: amount,
                date: date,
                description: description || 'Manual paycheck entry',
                frequency: person.frequency
            });
            data.eventHistory.push({
                id: nextEventId++,
                date: new Date().toISOString().split('T')[0],
                event: 'Paycheck Added',
                description: `Added paycheck of ${formatCurrency(amount)} for ${person.name} on ${date}`
            });
            $(`paycheckAmount-${personId}`).value = '';
            $(`paycheckDate-${personId}`).value = '';
            $(`paycheckDescription-${personId}`).value = '';
            saveDataToLocalStorage();
            updatePaycheckHistory(personId);
            updateOverview();
        }

        function addBonus(personId) {
            const amount = parseFloat($(`bonusAmount-${personId}`).value) || 0;
            const date = $(`bonusDate-${personId}`).value;
            const description = $(`bonusDescription-${personId}`).value.trim();
            if (!amount || !date) {
                alert('Please fill in amount and date');
                return;
            }
            const person = data.people.find(p => p.id === personId);
            if (!person) return;
            data.paycheckHistory.push({
                id: nextPaycheckId++,
                personId: personId,
                personName: person.name,
                type: 'bonus',
                amount: amount,
                date: date,
                description: description || 'Bonus',
                frequency: 'monthly'
            });
            data.eventHistory.push({
                id: nextEventId++,
                date: new Date().toISOString().split('T')[0],
                event: 'Bonus Added',
                description: `Added bonus of ${formatCurrency(amount)} for ${person.name} on ${date}`
            });
            $(`bonusAmount-${personId}`).value = '';
            $(`bonusDate-${personId}`).value = '';
            $(`bonusDescription-${personId}`).value = '';
            saveDataToLocalStorage();
            updateBonusHistory(personId);
            updateOverview();
        }

        function deletePaycheck(paycheckId) {
            if (confirm('Delete this paycheck/bonus record?')) {
                const payment = data.paycheckHistory.find(p => p.id === paycheckId);
                if (!payment) return;
                data.paymentHistory = data.paycheckHistory.filter(p => p.id !== paycheckId);
                data.eventHistory.push({
                    id: nextEventId++,
                    date: new Date().toISOString().split('T')[0],
                    event: payment.type === 'salary' ? 'Paycheck Deleted' : 'Bonus Deleted',
                    description: `Deleted ${payment.type} of ${formatCurrency(payment.amount)} for ${payment.personName} on ${payment.date}`
                });
                saveDataToLocalStorage();
                updatePaycheckHistory(payment.personId);
                updateBonusHistory(payment.personId);
                updateOverview();
            }
        }

        function updatePersonName(personId) {
            const person = data.people.find(p => p.id === personId);
            if (!person) return;
            const oldName = person.name;
            const newName = $(`name-${personId}`).value.trim();
            if (newName && newName !== oldName) {
                if (data.people.some(p => p.id !== personId && p.name.toLowerCase() === newName.toLowerCase())) {
                    alert('A person with this name already exists!');
                    $(`name-${personId}`).value = oldName;
                    return;
                }
                person.name = newName;
                data.eventHistory.push({
                    id: nextEventId++,
                    date: new Date().toISOString().split('T')[0],
                    event: 'Person Renamed',
                    description: `Renamed ${oldName} to ${newName}`
                });
                saveDataToLocalStorage();
                updateTabs();
                updateGreeting();
                updateBillPayerOptions();
                updateHistoryDisplay();
            }
        }

        function updatePersonData(personId) {
            const person = data.people.find(p => p.id === personId);
            if (!person) return;
            const oldIncome = person.income;
            const oldFrequency = person.frequency;
            const newIncome = parseFloat($(`income-${personId}`).value) || 0;
            const newFrequency = $(`frequency-${personId}`).value;
            person.income = newIncome;
            person.frequency = newFrequency;
            person.savings = parseFloat($(`savings-${personId}`).value) || 0;
            person.expenses = parseFloat($(`expenses-${personId}`).value) || 0;
            if (newIncome !== oldIncome || newFrequency !== oldFrequency) {
                const { startDate, endDate } = getCurrentMonthRange();
                const today = new Date().toISOString().split('T')[0];
                data.paycheckHistory = data.paycheckHistory.filter(p => 
                    !(p.personId === personId && p.type === 'salary' && p.description === 'Auto-logged salary' && 
                      new Date(p.date) >= startDate && new Date(p.date) <= endDate)
                );
                data.paycheckHistory.push({
                    id: nextPaycheckId++,
                    personId: personId,
                    personName: person.name,
                    type: 'salary',
                    amount: newIncome,
                    date: today,
                    description: 'Income updated',
                    frequency: newFrequency
                });
                data.eventHistory.push({
                    id: nextEventId++,
                    date: today,
                    event: 'Income Updated',
                    description: `${person.name} income changed from ${formatCurrency(oldIncome)} to ${formatCurrency(newIncome)} (${newFrequency})`
                });
            }
            saveDataToLocalStorage();
            updatePersonOverview(personId);
            updateOverview();
        }

        function updatePersonOverview(personId) {
            const person = data.people.find(p => p.id === personId);
            if (!person) return;
            const monthlyIncome = calculateMonthlyBudget(person);
            const monthlyExpenses = person.expenses;
            const monthlySavings = person.savings;
            const individualBills = data.bills.filter(b => b.billType === 'individual' && b.payer === personId)
                .reduce((sum, bill) => sum + frequencyToMonthly(bill.amount, bill.frequency), 0);
            const jointBills = data.bills.filter(b => b.billType === 'joint');
            const incomeRatios = calculateIncomeRatio();
            const personRatio = incomeRatios.find(r => r.id === personId)?.ratio || 0.5;
            let jointBillsShare = 0;
            let requiredTransfers = 0;
            jointBills.forEach(bill => {
                const monthlyAmount = frequencyToMonthly(bill.amount, bill.frequency);
                const personShare = data.weightedBills ? monthlyAmount * personRatio : monthlyAmount / data.people.length;
                if (bill.payer === 'joint') {
                    jointBillsShare += personShare;
                } else if (bill.payer === personId) {
                    jointBillsShare += personShare;
                    requiredTransfers -= (monthlyAmount - personShare);
                } else {
                    jointBillsShare += personShare;
                    requiredTransfers += personShare;
                }
            });
            const netMonthly = monthlyIncome - monthlyExpenses - monthlySavings - individualBills - jointBillsShare - requiredTransfers;
            const monthlyIncomeEl = $(`monthlyIncome-${personId}`);
            const monthlySavingsEl = $(`monthlySavings-${personId}`);
            const monthlyExpensesEl = $(`monthlyExpenses-${personId}`);
            const individualBillsEl = $(`individualBills-${personId}`);
            const jointBillsShareEl = $(`jointBillsShare-${personId}`);
            const requiredTransfersEl = $(`requiredTransfers-${personId}`);
            const netMonthlyEl = $(`netMonthly-${personId}`);
            if (monthlyIncomeEl) monthlyIncomeEl.textContent = formatCurrency(monthlyIncome);
            if (monthlySavingsEl) monthlySavingsEl.textContent = formatCurrency(monthlySavings);
            if (monthlyExpensesEl) monthlyExpensesEl.textContent = formatCurrency(monthlyExpenses);
            if (individualBillsEl) individualBillsEl.textContent = formatCurrency(individualBills);
            if (jointBillsShareEl) jointBillsShareEl.textContent = formatCurrency(jointBillsShare);
            if (requiredTransfersEl) requiredTransfersEl.textContent = formatCurrency(requiredTransfers);
            if (netMonthlyEl) netMonthlyEl.textContent = formatCurrency(netMonthly);
            updatePersonDebtOverview(personId);
        }

        function updatePersonDebtOverview(personId) {
            const debtContainer = $(`debtOverview-${personId}`);
            if (!debtContainer) return;
            const personDebts = data.bills.filter(b => 
                (b.billType === 'individual' && b.payer === personId) && 
                ['Mortgage', 'Loan', 'Credit Card'].includes(b.category) &&
                b.totalDebt > 0
            );
            if (personDebts.length === 0) {
                debtContainer.innerHTML = '';
                return;
            }
            let debtHTML = '<div class="debt-overview"><h4>Debt Overview</h4>';
            personDebts.forEach(debt => {
                const monthlyPayment = frequencyToMonthly(debt.amount, debt.frequency);
                const totalWithOverpayment = monthlyPayment + (debt.overpayment || 0);
                debtHTML += `
                    <div class="info-item">
                        <span class="info-label">${debt.name} (${debt.category})</span>
                        <span class="info-value">${formatCurrency(debt.totalDebt)} @ ${debt.interestRate}%${debt.overpayment > 0 ? ' (+' + formatCurrency(debt.overpayment) + ' overpayment)' : ''}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Monthly Payment</span>
                        <span class="info-value">${formatCurrency(totalWithOverpayment)}</span>
                    </div>`;
            });
            debtHTML += '</div>';
            debtContainer.innerHTML = debtHTML;
        }

        function deletePerson(personId) {
            if (data.people.length <= 1) {
                alert('Cannot delete the last person!');
                return;
            }
            const person = data.people.find(p => p.id === personId);
            if (!person) return;
            if (confirm(`Are you sure you want to delete ${person.name}? This will remove all their data and cannot be undone.`)) {
                data.people = data.people.filter(p => p.id !== personId);
                data.bills = data.bills.filter(b => b.payer !== personId);
                data.paycheckHistory = data.paycheckHistory.filter(p => p.personId !== personId);
                data.billHistory = data.billHistory.filter(h => h.payer !== personId);
                data.eventHistory.push({
                    id: nextEventId++,
                    date: new Date().toISOString().split('T')[0],
                    event: 'Person Deleted',
                    description: `Deleted ${person.name} and all associated data`
                });
                const tab = document.querySelector(`button.tab[data-person-id="${personId}"]`);
                if (tab) tab.remove();
                const content = $(`person-${personId}`);
                if (content) content.remove();
                saveDataToLocalStorage();
                updateTabs();
                updateOverview();
                showTab('overview');
            }
        }

        function toggleDebtFields() {
            const category = $('billCategory').value;
            const debtFields = $('debtFields');
            const mortgageFields = $('mortgageFields');
            if (['Mortgage', 'Loan', 'Credit Card'].includes(category)) {
                debtFields.style.display = 'block';
                if (category === 'Mortgage') {
                    mortgageFields.style.display = 'block';
                } else {
                    mortgageFields.style.display = 'none';
                }
            } else {
                debtFields.style.display = 'none';
                mortgageFields.style.display = 'none';
            }
        }

        function toggleBillPayerVisibility() {
            const billType = $('billType').value;
            const billPayerGroup = $('billPayerGroup');
            billPayerGroup.style.display = 'block';
            updateBillPayerOptions();
        }

        function updateBillPayerOptions() {
            const billPayer = $('billPayer');
            const billType = $('billType').value;
            billPayer.innerHTML = '';
            if (billType === 'joint') {
                const jointOption = document.createElement('option');
                jointOption.value = 'joint';
                jointOption.textContent = 'Joint Account';
                billPayer.appendChild(jointOption);
                data.people.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = `${person.name}'s Account`;
                    billPayer.appendChild(option);
                });
            } else {
                data.people.forEach(person => {
                    const option = document.createElement('option');
                    option.value = person.id;
                    option.textContent = person.name;
                    billPayer.appendChild(option);
                });
            }
        }

        function addBill() {
            const name = $('billName').value.trim();
            const amount = parseFloat($('billAmount').value) || 0;
            const frequency = $('billFrequency').value;
            const date = $('billDate').value;
            const category = $('billCategory').value;
            const billType = $('billType').value;
            const payer = billType === 'individual' ? parseInt($('billPayer').value) : $('billPayer').value;
            if (!name || !amount || !date) {
                alert('Please fill in all required fields');
                return;
            }
            const bill = {
                id: nextBillId++,
                name: name,
                amount: amount,
                frequency: frequency,
                date: date,
                category: category,
                billType: billType,
                payer: payer
            };
            if (['Mortgage', 'Loan', 'Credit Card'].includes(category)) {
                bill.totalDebt = parseFloat($('totalDebt').value) || 0;
                bill.interestRate = parseFloat($('interestRate').value) || 0;
                bill.termYears = parseInt($('termYears').value) || 0;
                bill.termMonths = parseInt($('termMonths').value) || 0;
                bill.overpayment = parseFloat($('overpayment').value) || 0;
                if (category === 'Mortgage') {
                    bill.rateExpiry = $('rateExpiry').value;
                }
            }
            data.bills.push(bill);
            data.billHistory.push({
                id: bill.id,
                date: new Date().toISOString().split('T')[0],
                action: 'Added',
                billName: bill.name,
                amount: bill.amount,
                category: bill.category,
                billType: bill.billType,
                payer: bill.payer
            });
            data.eventHistory.push({
                id: nextEventId++,
                date: new Date().toISOString().split('T')[0],
                event: 'Bill Added',
                description: `Added ${bill.name} - ${formatCurrency(bill.amount)}/${bill.frequency}`
            });
            $('billName').value = '';
            $('billAmount').value = '';
            $('billDate').value = '';
            $('totalDebt').value = '';
            $('interestRate').value = '';
            $('termYears').value = '';
            $('termMonths').value = '';
            $('overpayment').value = '';
            $('rateExpiry').value = '';
            saveDataToLocalStorage();
            updateBillsList();
            updateOverview();
        }

        function deleteBill(billId) {
            if (confirm('Are you sure you want to delete this bill? This cannot be undone.')) {
                const bill = data.bills.find(b => b.id === billId);
                if (bill) {
                    data.bills = data.bills.filter(b => b.id !== billId);
                    data.billHistory.push({
                        id: billId,
                        date: new Date().toISOString().split('T')[0],
                        action: 'Deleted',
                        billName: bill.name,
                        amount: bill.amount,
                        category: bill.category,
                        billType: bill.billType,
                        payer: bill.payer
                    });
                    data.eventHistory.push({
                        id: nextEventId++,
                        date: new Date().toISOString().split('T')[0],
                        event: 'Bill Deleted',
                        description: `Deleted ${bill.name} - ${formatCurrency(bill.amount)}/${bill.frequency}`
                    });
                    saveDataToLocalStorage();
                    updateBillsList();
                    updateOverview();
                }
            }
        }

        function updateBillsList() {
            const billsList = $('billsList');
            billsList.innerHTML = '';
            data.bills.forEach(bill => {
                const billItem = document.createElement('div');
                billItem.className = 'bill-item';
                let payerName = bill.billType === 'joint' ? (bill.payer === 'joint' ? 'Joint Account' : data.people.find(p => p.id === bill.payer)?.name + "'s Account") : data.people.find(p => p.id === bill.payer)?.name || 'Unknown';
                let debtInfo = '';
                if (['Mortgage', 'Loan', 'Credit Card'].includes(bill.category) && bill.totalDebt > 0) {
                    debtInfo = `
                        <div>Total Debt: ${formatCurrency(bill.totalDebt)}</div>
                        <div>Interest Rate: ${bill.interestRate}%</div>
                        <div>Term: ${bill.termYears} years${bill.termMonths > 0 ? `, ${bill.termMonths} months` : ''}</div>
                        ${bill.overpayment > 0 ? `<div>Overpayment: ${formatCurrency(bill.overpayment)}/month</div>` : ''}
                        ${bill.category === 'Mortgage' && bill.rateExpiry ? `<div>Rate Expiry: ${bill.rateExpiry}</div>` : ''}`;
                }
                billItem.innerHTML = `
                    <div class="bill-info">
                        <strong>${bill.name}</strong>
                        <div>Amount: ${formatCurrency(bill.amount)}/${bill.frequency}</div>
                        <div>Due: ${bill.date}</div>
                        <div>Category: ${bill.category}</div>
                        <div>Type: ${bill.billType}</div>
                        <div>Paid by: ${payerName}</div>
                        ${debtInfo}
                    </div>
                    <div class="bill-actions">
                        <button class="btn-danger btn-small" data-bill-id="${bill.id}">Delete</button>
                    </div>`;
                billItem.querySelector('button').addEventListener('click', () => deleteBill(bill.id));
                billsList.appendChild(billItem);
            });
        }

        function updateOverview() {
            const totalMonthlyIncome = data.people.reduce((sum, person) => 
                sum + calculateMonthlyBudget(person), 0);
            const totalMonthlySavings = data.people.reduce((sum, person) => 
                sum + (person.savings || 0), 0);
            const totalMonthlyBills = data.bills.reduce((sum, bill) => 
                sum + frequencyToMonthly(bill.amount, bill.frequency), 0);
            const leftover = totalMonthlyIncome - totalMonthlySavings - totalMonthlyBills;
            $('totalIncome').textContent = formatCurrency(totalMonthlyIncome);
            $('totalBills').textContent = formatCurrency(totalMonthlyBills);
            $('totalSavings').textContent = formatCurrency(totalMonthlySavings);
            $('totalLeftover').textContent = formatCurrency(leftover);
            updatePeopleOverview();
            updateDebtOverview();
            updateTransfersOverview();
            data.people.forEach(p => updatePersonOverview(p.id));
        }

        function updatePeopleOverview() {
            const container = $('peopleOverview');
            container.innerHTML = '';
            data.people.forEach(person => {
                const monthlyIncome = calculateMonthlyBudget(person);
                const monthlySavings = person.savings || 0;
                const monthlyExpenses = person.expenses || 0;
                const individualBills = data.bills.filter(b => b.billType === 'individual' && b.payer === person.id)
                    .reduce((sum, bill) => sum + frequencyToMonthly(bill.amount, bill.frequency), 0);
                const jointBills = data.bills.filter(b => b.billType === 'joint');
                const incomeRatios = calculateIncomeRatio();
                const personRatio = incomeRatios.find(r => r.id === person.id)?.ratio || 0.5;
                const jointBillsShare = jointBills.reduce((sum, bill) => {
                    const monthlyAmount = frequencyToMonthly(bill.amount, bill.frequency);
                    return sum + (data.weightedBills ? monthlyAmount * personRatio : monthlyAmount / data.people.length);
                }, 0);
                const netMonthly = monthlyIncome - monthlySavings - monthlyExpenses - individualBills - jointBillsShare;
                const personCard = document.createElement('div');
                personCard.className = 'person-card';
                personCard.innerHTML = `
                    <h3>${person.name}</h3>
                    <div class="person-info">
                        <div class="info-item">
                            <span class="info-label">Monthly Income</span>
                            <span class="info-value">${formatCurrency(monthlyIncome)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Monthly Savings</span>
                            <span class="info-value">${formatCurrency(monthlySavings)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Monthly Expenses</span>
                            <span class="info-value">${formatCurrency(monthlyExpenses)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Individual Bills</span>
                            <span class="info-value">${formatCurrency(individualBills)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Joint Bills Share</span>
                            <span class="info-value">${formatCurrency(jointBillsShare)}</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Net Monthly</span>
                            <span class="info-value">${formatCurrency(netMonthly)}</span>
                        </div>
                    </div>`;
                container.appendChild(personCard);
            });
        }

        function updateDebtOverview() {
            const debtsList = $('debtsList');
            const debtOverview = $('debtOverview');
            const debts = data.bills.filter(b => ['Mortgage', 'Loan', 'Credit Card'].includes(b.category) && b.totalDebt > 0);
            if (debts.length === 0) {
                debtOverview.style.display = 'none';
                return;
            }
            debtOverview.style.display = 'block';
            debtsList.innerHTML = '';
            debts.forEach(debt => {
                const monthlyPayment = frequencyToMonthly(debt.amount, debt.frequency);
                const totalWithOverpayment = monthlyPayment + (debt.overpayment || 0);
                const debtItem = document.createElement('div');
                debtItem.className = 'debt-item';
                debtItem.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">${debt.name} (${debt.category})</span>
                        <span class="info-value">${formatCurrency(debt.totalDebt)} @ ${debt.interestRate}%</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Monthly Payment</span>
                        <span class="info-value">${formatCurrency(totalWithOverpayment)}</span>
                    </div>
                    ${debt.overpayment > 0 ? `<div class="info-item"><span class="info-label">Overpayment</span><span class="info-value">${formatCurrency(debt.overpayment)}</span></div>` : ''}
                    ${debt.rateExpiry ? `<div class="info-item"><span class="info-label">Rate Expiry</span><span class="info-value">${debt.rateExpiry}</span></div>` : ''}`;
                debtsList.appendChild(debtItem);
            });
        }

        function updateTransfersOverview() {
            const transfersList = $('transfersList');
            const transfersOverview = $('transfersOverview');
            const transfers = [];
            const jointBills = data.bills.filter(b => b.billType === 'joint');
            const incomeRatios = calculateIncomeRatio();
            data.people.forEach(person => {
                let personTransfers = 0;
                jointBills.forEach(bill => {
                    const monthlyAmount = frequencyToMonthly(bill.amount, bill.frequency);
                    const personRatio = incomeRatios.find(r => r.id === person.id)?.ratio || 0.5;
                    const personShare = data.weightedBills ? monthlyAmount * personRatio : monthlyAmount / data.people.length;
                    if (bill.payer === 'joint') {
                        personTransfers += personShare;
                    } else if (bill.payer === person.id) {
                        personTransfers -= (monthlyAmount - personShare);
                    } else {
                        personTransfers += personShare;
                    }
                });
                if (personTransfers !== 0) {
                    transfers.push({
                        personId: person.id,
                        personName: person.name,
                        amount: personTransfers
                    });
                }
            });
            if (transfers.length === 0) {
                transfersOverview.style.display = 'none';
                return;
            }
            transfersOverview.style.display = 'block';
            transfersList.innerHTML = '';
            transfers.forEach(t => {
                if (t.amount === 0) return;
                const transferItem = document.createElement('div');
                transferItem.className = 'transfer-item';
                const direction = t.amount > 0 ? 'to' : 'from';
                const absAmount = Math.abs(t.amount);
                transferItem.innerHTML = `
                    <span>${t.personName}</span>
                    <span class="${t.amount > 0 ? 'red' : 'green'}">${formatCurrency(absAmount)} ${direction} joint account</span>`;
                transfersList.appendChild(transferItem);
            });
        }

        function updateHistoryDisplay() {
            const personFilter = $('historyPersonFilter').value;
            const startDate = $('historyStartDate').value;
            const endDate = $('historyEndDate').value;
            const incomeHistoryList = $('incomeHistoryList');
            incomeHistoryList.innerHTML = '';
            let filteredHistory = data.paycheckHistory;
            if (personFilter !== 'all') {
                filteredHistory = filteredHistory.filter(p => p.personId === parseInt(personFilter));
            }
            if (startDate) {
                filteredHistory = filteredHistory.filter(p => new Date(p.date) >= new Date(startDate));
            }
            if (endDate) {
                filteredHistory = filteredHistory.filter(p => new Date(p.date) <= new Date(endDate));
            }
            filteredHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredHistory.forEach(p => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${p.date}</td>
                    <td>${p.personName}</td>
                    <td>${p.type.charAt(0).toUpperCase() + p.type.slice(1)}</td>
                    <td>${formatCurrency(p.amount)}</td>
                    <td>${p.description || '-'}</td>
                    <td>
                        <button class="btn-danger btn-small" data-paycheck-id="${p.id}">Delete</button>
                    </td>`;
                row.querySelector('button').addEventListener('click', () => deletePaycheck(p.id));
                incomeHistoryList.appendChild(row);
            });
            if (filteredHistory.length === 0) {
                incomeHistoryList.innerHTML = '<tr><td colspan="6" style="text-align: center; padding: 8px;">No income history available.</td></tr>';
            }
            const billHistoryList = $('billHistoryList');
            billHistoryList.innerHTML = '';
            let filteredBillHistory = data.billHistory;
            if (personFilter !== 'all') {
                filteredBillHistory = filteredBillHistory.filter(h => h.payer === parseInt(personFilter));
            }
            if (startDate) {
                filteredBillHistory = filteredBillHistory.filter(h => new Date(h.date) >= new Date(startDate));
            }
            if (endDate) {
                filteredBillHistory = filteredBillHistory.filter(h => new Date(h.date) <= new Date(endDate));
            }
            filteredBillHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredBillHistory.forEach(h => {
                const row = document.createElement('tr');
                const payerName = h.billType === 'joint' ? (h.payer === 'joint' ? 'Joint Account' : data.people.find(p => p.id === h.payer)?.name + "'s Account") : data.people.find(p => p.id === h.payer)?.name || 'Unknown';
                row.innerHTML = `
                    <td>${h.date}</td>
                    <td>${h.action}</td>
                    <td>${h.billName}</td>
                    <td>${formatCurrency(h.amount)}</td>
                    <td>${h.category}</td>
                    <td>${h.billType} (${payerName})</td>
                    <td>-</td>`;
                billHistoryList.appendChild(row);
            });
            if (filteredBillHistory.length === 0) {
                billHistoryList.innerHTML = '<tr><td colspan="7" style="text-align: center; padding: 8px;">No bill history available.</td></tr>';
            }
            const eventHistoryList = $('eventHistoryList');
            eventHistoryList.innerHTML = '';
            let filteredEventHistory = data.eventHistory;
            if (startDate) {
                filteredEventHistory = filteredEventHistory.filter(e => new Date(e.date) >= new Date(startDate));
            }
            if (endDate) {
                filteredEventHistory = filteredEventHistory.filter(e => new Date(e.date) <= new Date(endDate));
            }
            filteredEventHistory.sort((a, b) => new Date(b.date) - new Date(a.date));
            filteredEventHistory.forEach(e => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${e.date}</td>
                    <td>${e.event}</td>
                    <td>${e.description}</td>
                    <td>-</td>`;
                eventHistoryList.appendChild(row);
            });
            if (filteredEventHistory.length === 0) {
                eventHistoryList.innerHTML = '<tr><td colspan="4" style="text-align: center; padding: 8px;">No events recorded.</td></tr>';
            }
        }

        function clearHistoryFilters() {
            $('historyPersonFilter').value = 'all';
            $('historyStartDate').value = '';
            $('historyEndDate').value = '';
            updateHistoryDisplay();
        }

		function fullReset() {
			if (confirm('Are you sure you want to reset all data? This will clear all people, bills, and history and cannot be undone.')) {
				data = {
					people: [],
					bills: [],
					currency: "USD",
					darkMode: false,
					weightedBills: false,
					nextPersonId: 1,
					nextBillId: 1,
					nextIncomeId: 1,
					nextEventId: 1,
					nextPaycheckId: 1,
					paycheckHistory: [],
					billHistory: [],
					eventHistory: []
				};
				nextPersonId = 1;
				nextBillId = 1;
				nextIncomeId = 1;
				nextEventId = 1;
				nextPaycheckId = 1;
				document.body.classList.remove('dark-mode');
				$('currencySelect').value = 'USD';
				$('weightedBillsSidebar').checked = false;
				localStorage.removeItem(STORAGE_KEY);
				saveDataToLocalStorage(); // Save the reset state to local storage
				clearChanges(); // Reset change tracking
				updateTabs();
				updateGreeting();
				updateBillPayerOptions();
				updateBillsList();
				updateOverview();
				updateHistoryDisplay();
				showTab('overview');
				alert('All data has been reset.');
			}
		}

		function updateTabs() {
			const tabsContainer = $('tabsContainer');
			const personTabs = document.querySelectorAll('.tab[data-person-id]');
			personTabs.forEach(tab => tab.remove());
			const personContents = document.querySelectorAll('.tab-content[id^="person-"]');
			personContents.forEach(content => content.remove());
			data.people.forEach(person => createPersonTab(person));
			const overviewTab = document.querySelector('.tab[data-tab="overview"]');
			if (overviewTab) overviewTab.click();
		}

		function showTab(tabId) {
			document.querySelectorAll('.tab-content').forEach(content => {
				content.classList.remove('active');
				content.style.opacity = '0';
			});
			document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
			const selectedContent = $(tabId);
			const selectedTab = document.querySelector(`.tab[data-tab="${tabId}"], .tab[data-person-id="${tabId.replace('person-', '')}"]`);
			if (selectedContent && selectedTab) {
				selectedContent.classList.add('active');
				setTimeout(() => selectedContent.style.opacity = '1', 50);
				selectedTab.classList.add('active');
			}
		}

		function initializeEventListeners() {
			$('hamburgerBtn').addEventListener('click', toggleSidebar);
			$('saveBtn').addEventListener('click', saveDataToEmbedded);
			$('addNewPersonBtn').addEventListener('click', addNewPerson);
			$('toggleDarkModeBtn').addEventListener('click', toggleDarkMode);
			$('currencySelect').addEventListener('change', updateCurrency);
			$('weightedBillsSidebar').addEventListener('change', updateWeightedBills);
			$('billCategory').addEventListener('change', toggleDebtFields);
			$('billType').addEventListener('change', toggleBillPayerVisibility);
			$('addBillBtn').addEventListener('click', addBill);
			$('clearHistoryFiltersBtn').addEventListener('click', clearHistoryFilters);
			$('fullResetBtn').addEventListener('click', fullReset);
			document.querySelectorAll('.tab').forEach(tab => {
				tab.addEventListener('click', () => {
					const tabId = tab.dataset.tab || `person-${tab.dataset.personId}`;
					showTab(tabId);
				});
			});
			$('historyPersonFilter').addEventListener('change', updateHistoryDisplay);
			$('historyStartDate').addEventListener('change', updateHistoryDisplay);
			$('historyEndDate').addEventListener('change', updateHistoryDisplay);
			window.addEventListener('beforeunload', () => {
				if (hasChanges) {
					return confirm('You have unsaved changes. Do you want to save before leaving?') ? saveDataToEmbedded() : localStorage.removeItem(STORAGE_KEY);
				}
				localStorage.removeItem(STORAGE_KEY);
			});
		}

		function initializeApp() {
			loadData();
			updateGreeting();
			updateBillPayerOptions();
			updateBillsList();
			updateOverview();
			updateHistoryDisplay();
			data.people.forEach(person => createPersonTab(person));
			initializeEventListeners();
			showTab('overview');
		}

		initializeApp();
		</script>
	
</body></html>
